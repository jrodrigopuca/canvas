{"version":3,"file":"index.js","sources":["../src/core/utils/id.ts","../src/core/utils/classnames.ts","../src/core/utils/deepMerge.ts","../src/core/utils/geometry.ts","../src/core/utils/layers.ts","../src/core/utils/validation.ts","../src/core/utils/serialization.ts","../src/core/context/ThemeContext.tsx","../src/core/context/ViewportContext.tsx","../src/core/context/SelectionContext.tsx","../src/core/context/HistoryContext.tsx","../src/core/context/CanvasContext.tsx","../src/core/context/CombinedCanvasProvider.tsx","../src/core/hooks/useDraggable.ts","../src/core/hooks/useResizable.ts","../src/core/hooks/useRotatable.ts","../src/core/hooks/useSelectable.ts","../src/core/hooks/useKeyboard.ts","../src/core/hooks/useCanvasActions.ts","../src/elements/ElementBase.tsx","../src/elements/withElementBehavior.tsx","../src/elements/shapes/Rectangle.tsx","../src/elements/shapes/Ellipse.tsx","../src/elements/shapes/Diamond.tsx","../src/elements/shapes/TextElement.tsx","../src/elements/LineBase.tsx","../src/elements/shapes/Line.tsx","../src/elements/uml/Actor.tsx","../src/elements/uml/Lifeline.tsx","../src/elements/uml/Message.tsx","../src/elements/uml/ActivationBar.tsx","../src/components/DrawingCanvas.tsx","../src/components/Canvas.tsx","../src/components/ElementFactory.ts"],"sourcesContent":["// ID generation utility\n// Uses crypto.randomUUID() with fallback for older environments\n\nexport const generateId = (): string => {\n\tif (\n\t\ttypeof crypto !== \"undefined\" &&\n\t\ttypeof crypto.randomUUID === \"function\"\n\t) {\n\t\treturn crypto.randomUUID();\n\t}\n\t// Fallback for environments without crypto.randomUUID\n\treturn `${Date.now().toString(36)}-${Math.random().toString(36).slice(2, 11)}`;\n};\n","// Classnames utility\n// Simple alternative to clsx/classnames libraries\n\ntype ClassValue =\n\t| string\n\t| number\n\t| boolean\n\t| undefined\n\t| null\n\t| ClassObject\n\t| ClassValue[];\ntype ClassObject = { [key: string]: boolean | undefined | null };\n\nexport const cx = (...args: ClassValue[]): string => {\n\tconst classes: string[] = [];\n\n\tfor (const arg of args) {\n\t\tif (!arg) continue;\n\n\t\tif (typeof arg === \"string\" || typeof arg === \"number\") {\n\t\t\tclasses.push(String(arg));\n\t\t} else if (Array.isArray(arg)) {\n\t\t\tconst inner = cx(...arg);\n\t\t\tif (inner) classes.push(inner);\n\t\t} else if (typeof arg === \"object\") {\n\t\t\tfor (const [key, value] of Object.entries(arg)) {\n\t\t\t\tif (value) classes.push(key);\n\t\t\t}\n\t\t}\n\t}\n\n\treturn classes.join(\" \");\n};\n","// Deep merge utility\n// Used for merging theme objects\n\nexport function deepMerge<T extends object>(target: T, source: Partial<T>): T {\n\tconst output = { ...target };\n\n\tfor (const key in source) {\n\t\tif (Object.prototype.hasOwnProperty.call(source, key)) {\n\t\t\tconst sourceVal = source[key];\n\t\t\tconst targetVal = target[key];\n\n\t\t\tif (\n\t\t\t\tsourceVal !== null &&\n\t\t\t\ttypeof sourceVal === \"object\" &&\n\t\t\t\t!Array.isArray(sourceVal) &&\n\t\t\t\ttargetVal !== null &&\n\t\t\t\ttypeof targetVal === \"object\" &&\n\t\t\t\t!Array.isArray(targetVal)\n\t\t\t) {\n\t\t\t\toutput[key] = deepMerge(\n\t\t\t\t\ttargetVal as object,\n\t\t\t\t\tsourceVal as object,\n\t\t\t\t) as T[typeof key];\n\t\t\t} else if (sourceVal !== undefined) {\n\t\t\t\toutput[key] = sourceVal as T[typeof key];\n\t\t\t}\n\t\t}\n\t}\n\n\treturn output;\n}\n","// Geometry utilities\n// Position and size calculations\n\nimport type { Point, Size, Bounds } from \"@/types/elements\";\n\n/**\n * Calculate distance between two points\n */\nexport const distance = (p1: Point, p2: Point): number => {\n\tconst dx = p2.x - p1.x;\n\tconst dy = p2.y - p1.y;\n\treturn Math.sqrt(dx * dx + dy * dy);\n};\n\n/**\n * Check if a point is inside bounds\n */\nexport const isPointInBounds = (point: Point, bounds: Bounds): boolean => {\n\treturn (\n\t\tpoint.x >= bounds.x &&\n\t\tpoint.x <= bounds.x + bounds.width &&\n\t\tpoint.y >= bounds.y &&\n\t\tpoint.y <= bounds.y + bounds.height\n\t);\n};\n\n/**\n * Check if two bounds intersect\n */\nexport const boundsIntersect = (a: Bounds, b: Bounds): boolean => {\n\treturn !(\n\t\ta.x + a.width < b.x ||\n\t\tb.x + b.width < a.x ||\n\t\ta.y + a.height < b.y ||\n\t\tb.y + b.height < a.y\n\t);\n};\n\n/**\n * Check if bounds A contains bounds B completely\n */\nexport const boundsContain = (\n\tcontainer: Bounds,\n\tcontained: Bounds,\n): boolean => {\n\treturn (\n\t\tcontained.x >= container.x &&\n\t\tcontained.y >= container.y &&\n\t\tcontained.x + contained.width <= container.x + container.width &&\n\t\tcontained.y + contained.height <= container.y + container.height\n\t);\n};\n\n/**\n * Get center point of bounds\n */\nexport const getBoundsCenter = (bounds: Bounds): Point => ({\n\tx: bounds.x + bounds.width / 2,\n\ty: bounds.y + bounds.height / 2,\n});\n\n/**\n * Snap a value to a grid\n */\nexport const snapToGrid = (value: number, gridSize: number): number => {\n\treturn Math.round(value / gridSize) * gridSize;\n};\n\n/**\n * Snap a point to a grid\n */\nexport const snapPointToGrid = (point: Point, gridSize: number): Point => ({\n\tx: snapToGrid(point.x, gridSize),\n\ty: snapToGrid(point.y, gridSize),\n});\n\n/**\n * Get bounding box that contains all given bounds\n */\nexport const getContainingBounds = (boundsArray: Bounds[]): Bounds | null => {\n\tif (boundsArray.length === 0) return null;\n\n\tlet minX = Infinity;\n\tlet minY = Infinity;\n\tlet maxX = -Infinity;\n\tlet maxY = -Infinity;\n\n\tfor (const bounds of boundsArray) {\n\t\tminX = Math.min(minX, bounds.x);\n\t\tminY = Math.min(minY, bounds.y);\n\t\tmaxX = Math.max(maxX, bounds.x + bounds.width);\n\t\tmaxY = Math.max(maxY, bounds.y + bounds.height);\n\t}\n\n\treturn {\n\t\tx: minX,\n\t\ty: minY,\n\t\twidth: maxX - minX,\n\t\theight: maxY - minY,\n\t};\n};\n\n/**\n * Clamp a value between min and max\n */\nexport const clamp = (value: number, min: number, max: number): number => {\n\treturn Math.min(Math.max(value, min), max);\n};\n\n/**\n * Normalize bounds to ensure positive width/height\n */\nexport const normalizeBounds = (bounds: Bounds): Bounds => {\n\tlet { x, y, width, height } = bounds;\n\n\tif (width < 0) {\n\t\tx += width;\n\t\twidth = Math.abs(width);\n\t}\n\n\tif (height < 0) {\n\t\ty += height;\n\t\theight = Math.abs(height);\n\t}\n\n\treturn { x, y, width, height };\n};\n\n/**\n * Resize handle positions\n */\nexport type ResizeHandle = \"nw\" | \"n\" | \"ne\" | \"e\" | \"se\" | \"s\" | \"sw\" | \"w\";\n\n/**\n * Resize handle info\n */\nexport interface ResizeHandleInfo {\n\tposition: ResizeHandle;\n\tx: number;\n\ty: number;\n}\n\n/**\n * Get resize handle positions for a given bounds\n */\nexport const getResizeHandles = (\n\tbounds: Bounds,\n\thandleSize: number,\n): ResizeHandleInfo[] => {\n\tconst { x, y, width, height } = bounds;\n\tconst halfHandle = handleSize / 2;\n\n\treturn [\n\t\t{ position: \"nw\", x: x - halfHandle, y: y - halfHandle },\n\t\t{ position: \"n\", x: x + width / 2 - halfHandle, y: y - halfHandle },\n\t\t{ position: \"ne\", x: x + width - halfHandle, y: y - halfHandle },\n\t\t{\n\t\t\tposition: \"e\",\n\t\t\tx: x + width - halfHandle,\n\t\t\ty: y + height / 2 - halfHandle,\n\t\t},\n\t\t{ position: \"se\", x: x + width - halfHandle, y: y + height - halfHandle },\n\t\t{\n\t\t\tposition: \"s\",\n\t\t\tx: x + width / 2 - halfHandle,\n\t\t\ty: y + height - halfHandle,\n\t\t},\n\t\t{ position: \"sw\", x: x - halfHandle, y: y + height - halfHandle },\n\t\t{ position: \"w\", x: x - halfHandle, y: y + height / 2 - halfHandle },\n\t];\n};\n\n/**\n * Get connection points for element bounds\n */\nexport const getConnectionPoints = (bounds: Bounds): Record<string, Point> => {\n\tconst { x, y, width, height } = bounds;\n\treturn {\n\t\ttop: { x: x + width / 2, y },\n\t\tright: { x: x + width, y: y + height / 2 },\n\t\tbottom: { x: x + width / 2, y: y + height },\n\t\tleft: { x, y: y + height / 2 },\n\t\tcenter: { x: x + width / 2, y: y + height / 2 },\n\t};\n};\n\n/**\n * Calculate midpoint between two points\n */\nexport const midpoint = (p1: Point, p2: Point): Point => ({\n\tx: (p1.x + p2.x) / 2,\n\ty: (p1.y + p2.y) / 2,\n});\n\n/**\n * Normalize angle to 0-360 range\n */\nexport const normalizeAngle = (angle: number): number => {\n\treturn ((angle % 360) + 360) % 360;\n};\n\n/**\n * Rotate a point around an origin\n */\nexport const rotatePoint = (\n\tpoint: Point,\n\torigin: Point,\n\tangleDegrees: number,\n): Point => {\n\tconst angleRad = (angleDegrees * Math.PI) / 180;\n\tconst cos = Math.cos(angleRad);\n\tconst sin = Math.sin(angleRad);\n\tconst dx = point.x - origin.x;\n\tconst dy = point.y - origin.y;\n\n\treturn {\n\t\tx: origin.x + dx * cos - dy * sin,\n\t\ty: origin.y + dx * sin + dy * cos,\n\t};\n};\n","// Layers / Z-index management utilities\n\nimport type { CanvasElement } from \"@/types/elements\";\n\n/**\n * Sort elements by z-index for rendering\n */\nexport const sortByZIndex = (elements: CanvasElement[]): CanvasElement[] => {\n\treturn [...elements].sort((a, b) => a.zIndex - b.zIndex);\n};\n\n/**\n * Get the maximum z-index from elements\n */\nexport const getMaxZIndex = (elements: CanvasElement[]): number => {\n\tif (elements.length === 0) return 0;\n\treturn Math.max(...elements.map((el) => el.zIndex));\n};\n\n/**\n * Get the minimum z-index from elements\n */\nexport const getMinZIndex = (elements: CanvasElement[]): number => {\n\tif (elements.length === 0) return 0;\n\treturn Math.min(...elements.map((el) => el.zIndex));\n};\n\n/**\n * Bring element to front (highest z-index)\n */\nexport const bringToFront = (\n\telements: CanvasElement[],\n\telementId: string,\n): CanvasElement[] => {\n\tconst maxZ = getMaxZIndex(elements);\n\treturn elements.map((el) =>\n\t\tel.id === elementId ? { ...el, zIndex: maxZ + 1 } : el,\n\t);\n};\n\n/**\n * Send element to back (lowest z-index)\n */\nexport const sendToBack = (\n\telements: CanvasElement[],\n\telementId: string,\n): CanvasElement[] => {\n\tconst minZ = getMinZIndex(elements);\n\treturn elements.map((el) =>\n\t\tel.id === elementId ? { ...el, zIndex: minZ - 1 } : el,\n\t);\n};\n\n/**\n * Bring element one step forward\n */\nexport const bringForward = (\n\telements: CanvasElement[],\n\telementId: string,\n): CanvasElement[] => {\n\tconst sorted = sortByZIndex(elements);\n\tconst index = sorted.findIndex((el) => el.id === elementId);\n\n\tif (index === -1 || index === sorted.length - 1) return elements;\n\n\tconst current = sorted[index];\n\tconst above = sorted[index + 1];\n\n\treturn elements.map((el) => {\n\t\tif (el.id === current.id) return { ...el, zIndex: above.zIndex + 1 };\n\t\treturn el;\n\t});\n};\n\n/**\n * Send element one step backward\n */\nexport const sendBackward = (\n\telements: CanvasElement[],\n\telementId: string,\n): CanvasElement[] => {\n\tconst sorted = sortByZIndex(elements);\n\tconst index = sorted.findIndex((el) => el.id === elementId);\n\n\tif (index <= 0) return elements;\n\n\tconst current = sorted[index];\n\tconst below = sorted[index - 1];\n\n\treturn elements.map((el) => {\n\t\tif (el.id === current.id) return { ...el, zIndex: below.zIndex - 1 };\n\t\treturn el;\n\t});\n};\n\n/**\n * Normalize z-indexes to be sequential (0, 1, 2, ...)\n */\nexport const normalizeZIndexes = (\n\telements: CanvasElement[],\n): CanvasElement[] => {\n\tconst sorted = sortByZIndex(elements);\n\tconst idToNewIndex = new Map<string, number>();\n\n\tsorted.forEach((el, index) => {\n\t\tidToNewIndex.set(el.id, index);\n\t});\n\n\treturn elements.map((el) => ({\n\t\t...el,\n\t\tzIndex: idToNewIndex.get(el.id) ?? el.zIndex,\n\t}));\n};\n","// Validation utilities\n// Schema validation for imported data\n\nimport type { CanvasElement, Connection } from \"@/types/elements\";\nimport type { CanvasData } from \"./serialization\";\n\nexport interface ValidationResult {\n\tvalid: boolean;\n\terrors: string[];\n}\n\n/**\n * Validate canvas data structure\n */\nexport const validateCanvasData = (data: unknown): ValidationResult => {\n\tconst errors: string[] = [];\n\n\tif (!data || typeof data !== \"object\") {\n\t\treturn { valid: false, errors: [\"Data must be an object\"] };\n\t}\n\n\tconst obj = data as Record<string, unknown>;\n\n\t// Check version\n\tif (typeof obj.version !== \"string\") {\n\t\terrors.push(\"Missing or invalid version field\");\n\t}\n\n\t// Check elements array\n\tif (!Array.isArray(obj.elements)) {\n\t\terrors.push(\"Elements must be an array\");\n\t} else {\n\t\tobj.elements.forEach((element, index) => {\n\t\t\tconst elementErrors = validateElement(element, index);\n\t\t\terrors.push(...elementErrors);\n\t\t});\n\t}\n\n\t// Check connections array\n\tif (!Array.isArray(obj.connections)) {\n\t\terrors.push(\"Connections must be an array\");\n\t} else {\n\t\tobj.connections.forEach((connection, index) => {\n\t\t\tconst connectionErrors = validateConnection(connection, index);\n\t\t\terrors.push(...connectionErrors);\n\t\t});\n\t}\n\n\treturn {\n\t\tvalid: errors.length === 0,\n\t\terrors,\n\t};\n};\n\n/**\n * Validate a single element\n */\nexport const validateElement = (element: unknown, index: number): string[] => {\n\tconst errors: string[] = [];\n\tconst prefix = `Element[${index}]`;\n\n\tif (!element || typeof element !== \"object\") {\n\t\treturn [`${prefix}: Must be an object`];\n\t}\n\n\tconst el = element as Record<string, unknown>;\n\n\t// Required fields\n\tif (typeof el.id !== \"string\" || el.id.length === 0) {\n\t\terrors.push(`${prefix}: Missing or invalid id`);\n\t}\n\n\tif (typeof el.type !== \"string\" || el.type.length === 0) {\n\t\terrors.push(`${prefix}: Missing or invalid type`);\n\t}\n\n\tif (typeof el.x !== \"number\" || isNaN(el.x)) {\n\t\terrors.push(`${prefix}: Missing or invalid x coordinate`);\n\t}\n\n\tif (typeof el.y !== \"number\" || isNaN(el.y)) {\n\t\terrors.push(`${prefix}: Missing or invalid y coordinate`);\n\t}\n\n\tif (typeof el.width !== \"number\" || isNaN(el.width) || el.width < 0) {\n\t\terrors.push(`${prefix}: Missing or invalid width`);\n\t}\n\n\tif (typeof el.height !== \"number\" || isNaN(el.height) || el.height < 0) {\n\t\terrors.push(`${prefix}: Missing or invalid height`);\n\t}\n\n\tif (typeof el.zIndex !== \"number\" || isNaN(el.zIndex)) {\n\t\terrors.push(`${prefix}: Missing or invalid zIndex`);\n\t}\n\n\treturn errors;\n};\n\n/**\n * Validate a single connection\n */\nexport const validateConnection = (\n\tconnection: unknown,\n\tindex: number,\n): string[] => {\n\tconst errors: string[] = [];\n\tconst prefix = `Connection[${index}]`;\n\n\tif (!connection || typeof connection !== \"object\") {\n\t\treturn [`${prefix}: Must be an object`];\n\t}\n\n\tconst conn = connection as Record<string, unknown>;\n\n\tif (typeof conn.id !== \"string\" || conn.id.length === 0) {\n\t\terrors.push(`${prefix}: Missing or invalid id`);\n\t}\n\n\tif (typeof conn.fromId !== \"string\" || conn.fromId.length === 0) {\n\t\terrors.push(`${prefix}: Missing or invalid fromId`);\n\t}\n\n\tif (typeof conn.toId !== \"string\" || conn.toId.length === 0) {\n\t\terrors.push(`${prefix}: Missing or invalid toId`);\n\t}\n\n\treturn errors;\n};\n\n/**\n * Check if all connection references exist\n */\nexport const validateConnectionReferences = (\n\telements: CanvasElement[],\n\tconnections: Connection[],\n): ValidationResult => {\n\tconst errors: string[] = [];\n\tconst elementIds = new Set(elements.map((el) => el.id));\n\n\tconnections.forEach((conn, index) => {\n\t\tif (!elementIds.has(conn.fromId)) {\n\t\t\terrors.push(\n\t\t\t\t`Connection[${index}]: fromId '${conn.fromId}' does not exist`,\n\t\t\t);\n\t\t}\n\t\tif (!elementIds.has(conn.toId)) {\n\t\t\terrors.push(`Connection[${index}]: toId '${conn.toId}' does not exist`);\n\t\t}\n\t});\n\n\treturn {\n\t\tvalid: errors.length === 0,\n\t\terrors,\n\t};\n};\n","// Serialization utilities\n// JSON import/export for canvas data\n\nimport type { CanvasElement, Connection } from \"@/types/elements\";\nimport { validateCanvasData } from \"./validation\";\n\nexport interface CanvasData {\n\tversion: string;\n\telements: CanvasElement[];\n\tconnections: Connection[];\n\tmetadata?: Record<string, unknown>;\n}\n\nconst CURRENT_VERSION = \"1.0.0\";\n\n/**\n * Serialize canvas data to JSON string\n */\nexport const serializeToJSON = (\n\telements: CanvasElement[],\n\tconnections: Connection[],\n\tmetadata?: Record<string, unknown>,\n): string => {\n\tconst data: CanvasData = {\n\t\tversion: CURRENT_VERSION,\n\t\telements,\n\t\tconnections,\n\t\tmetadata,\n\t};\n\treturn JSON.stringify(data, null, 2);\n};\n\n/**\n * Deserialize JSON string to canvas data\n */\nexport const deserializeFromJSON = (json: string): CanvasData => {\n\tconst data = JSON.parse(json) as CanvasData;\n\n\tconst validation = validateCanvasData(data);\n\tif (!validation.valid) {\n\t\tthrow new Error(`Invalid canvas data: ${validation.errors.join(\", \")}`);\n\t}\n\n\treturn data;\n};\n\n/**\n * Export canvas as SVG string\n */\nexport const exportToSVG = (\n\tsvgElement: SVGSVGElement,\n\toptions?: { includeStyles?: boolean },\n): string => {\n\tconst clone = svgElement.cloneNode(true) as SVGSVGElement;\n\n\t// Add XML namespace if not present\n\tif (!clone.getAttribute(\"xmlns\")) {\n\t\tclone.setAttribute(\"xmlns\", \"http://www.w3.org/2000/svg\");\n\t}\n\n\t// Optionally include inline styles\n\tif (options?.includeStyles) {\n\t\tconst styles = document.createElement(\"style\");\n\t\tstyles.textContent = getComputedStyles(svgElement);\n\t\tclone.insertBefore(styles, clone.firstChild);\n\t}\n\n\tconst serializer = new XMLSerializer();\n\treturn serializer.serializeToString(clone);\n};\n\n/**\n * Get computed styles from SVG element\n */\nconst getComputedStyles = (svg: SVGSVGElement): string => {\n\t// Get all unique tag names\n\tconst tags = new Set<string>();\n\tsvg.querySelectorAll(\"*\").forEach((el) => tags.add(el.tagName.toLowerCase()));\n\n\t// Basic SVG styles\n\treturn `\n    svg { font-family: system-ui, sans-serif; }\n    text { user-select: none; }\n  `;\n};\n\n/**\n * Download string content as file\n */\nexport const downloadAsFile = (\n\tcontent: string,\n\tfilename: string,\n\tmimeType: string,\n): void => {\n\tconst blob = new Blob([content], { type: mimeType });\n\tconst url = URL.createObjectURL(blob);\n\tconst link = document.createElement(\"a\");\n\tlink.href = url;\n\tlink.download = filename;\n\tdocument.body.appendChild(link);\n\tlink.click();\n\tdocument.body.removeChild(link);\n\tURL.revokeObjectURL(url);\n};\n\nexport type ImageFormat = \"png\" | \"jpeg\";\n\nexport interface ExportImageOptions {\n\t/** Image format: 'png' or 'jpeg' */\n\tformat?: ImageFormat;\n\t/** Quality for JPEG format (0-1), default 0.92 */\n\tquality?: number;\n\t/** Background color (default: transparent for PNG, white for JPEG) */\n\tbackgroundColor?: string;\n\t/** Scale factor for higher resolution (default: 1) */\n\tscale?: number;\n}\n\n/**\n * Export SVG canvas as PNG or JPEG image\n * Returns a Promise with the image as a data URL or Blob\n */\nexport const exportToImage = async (\n\tsvgElement: SVGSVGElement,\n\toptions: ExportImageOptions = {},\n): Promise<Blob> => {\n\tconst { format = \"png\", quality = 0.92, backgroundColor, scale = 1 } = options;\n\n\t// Get SVG dimensions\n\tconst svgRect = svgElement.getBoundingClientRect();\n\tconst width = svgRect.width * scale;\n\tconst height = svgRect.height * scale;\n\n\t// Clone and prepare SVG\n\tconst clone = svgElement.cloneNode(true) as SVGSVGElement;\n\tclone.setAttribute(\"xmlns\", \"http://www.w3.org/2000/svg\");\n\tclone.setAttribute(\"xmlns:xlink\", \"http://www.w3.org/1999/xlink\");\n\n\t// Add inline styles\n\tconst styleEl = document.createElementNS(\"http://www.w3.org/2000/svg\", \"style\");\n\tstyleEl.textContent = getComputedStyles(svgElement);\n\tclone.insertBefore(styleEl, clone.firstChild);\n\n\t// Serialize SVG to string\n\tconst serializer = new XMLSerializer();\n\tconst svgString = serializer.serializeToString(clone);\n\n\t// Create a Blob from SVG string\n\tconst svgBlob = new Blob([svgString], { type: \"image/svg+xml;charset=utf-8\" });\n\tconst svgUrl = URL.createObjectURL(svgBlob);\n\n\treturn new Promise((resolve, reject) => {\n\t\tconst img = new Image();\n\n\t\timg.onload = () => {\n\t\t\t// Create canvas\n\t\t\tconst canvas = document.createElement(\"canvas\");\n\t\t\tcanvas.width = width;\n\t\t\tcanvas.height = height;\n\t\t\tconst ctx = canvas.getContext(\"2d\");\n\n\t\t\tif (!ctx) {\n\t\t\t\tURL.revokeObjectURL(svgUrl);\n\t\t\t\treject(new Error(\"Failed to get canvas context\"));\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Apply background color\n\t\t\tconst bgColor = backgroundColor ?? (format === \"jpeg\" ? \"#ffffff\" : \"transparent\");\n\t\t\tif (bgColor !== \"transparent\") {\n\t\t\t\tctx.fillStyle = bgColor;\n\t\t\t\tctx.fillRect(0, 0, width, height);\n\t\t\t}\n\n\t\t\t// Scale and draw image\n\t\t\tctx.scale(scale, scale);\n\t\t\tctx.drawImage(img, 0, 0);\n\n\t\t\t// Convert to blob\n\t\t\tcanvas.toBlob(\n\t\t\t\t(blob) => {\n\t\t\t\t\tURL.revokeObjectURL(svgUrl);\n\t\t\t\t\tif (blob) {\n\t\t\t\t\t\tresolve(blob);\n\t\t\t\t\t} else {\n\t\t\t\t\t\treject(new Error(\"Failed to create image blob\"));\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tformat === \"jpeg\" ? \"image/jpeg\" : \"image/png\",\n\t\t\t\tformat === \"jpeg\" ? quality : undefined,\n\t\t\t);\n\t\t};\n\n\t\timg.onerror = () => {\n\t\t\tURL.revokeObjectURL(svgUrl);\n\t\t\treject(new Error(\"Failed to load SVG as image\"));\n\t\t};\n\n\t\timg.src = svgUrl;\n\t});\n};\n\n/**\n * Download canvas as image file\n */\nexport const downloadAsImage = async (\n\tsvgElement: SVGSVGElement,\n\tfilename: string,\n\toptions: ExportImageOptions = {},\n): Promise<void> => {\n\tconst { format = \"png\" } = options;\n\tconst blob = await exportToImage(svgElement, options);\n\tconst url = URL.createObjectURL(blob);\n\tconst link = document.createElement(\"a\");\n\tlink.href = url;\n\tlink.download = `${filename}.${format}`;\n\tdocument.body.appendChild(link);\n\tlink.click();\n\tdocument.body.removeChild(link);\n\tURL.revokeObjectURL(url);\n};\n","// Theme Context\n// Manages theming (light/dark/custom)\n\nimport React, { createContext, useContext, useMemo } from 'react';\nimport type { Theme } from '@/types/theme';\nimport { deepMerge } from '@/core/utils';\n\n// Default light theme\nexport const lightTheme: Theme = {\n  name: 'light',\n  colors: {\n    background: '#ffffff',\n    surface: '#f8f9fa',\n    border: '#dee2e6',\n    text: {\n      primary: '#212529',\n      secondary: '#6c757d',\n      disabled: '#adb5bd',\n    },\n    selection: {\n      fill: 'rgba(59, 130, 246, 0.1)',\n      stroke: '#3b82f6',\n    },\n    element: {\n      fill: '#ffffff',\n      stroke: '#212529',\n      hover: '#f1f5f9',\n      active: '#e2e8f0',\n    },\n    handle: {\n      fill: '#ffffff',\n      stroke: '#3b82f6',\n    },\n    grid: {\n      line: '#e5e7eb',\n      dot: '#d1d5db',\n    },\n    connection: {\n      line: '#64748b',\n      arrow: '#64748b',\n    },\n  },\n  spacing: {\n    xs: 4,\n    sm: 8,\n    md: 16,\n    lg: 24,\n    xl: 32,\n  },\n  borderRadius: {\n    sm: 2,\n    md: 4,\n    lg: 8,\n  },\n  fontSize: {\n    xs: 10,\n    sm: 12,\n    md: 14,\n    lg: 16,\n    xl: 20,\n  },\n  strokeWidth: {\n    thin: 1,\n    normal: 2,\n    thick: 3,\n  },\n  shadows: {\n    sm: '0 1px 2px rgba(0,0,0,0.05)',\n    md: '0 4px 6px rgba(0,0,0,0.1)',\n    lg: '0 10px 15px rgba(0,0,0,0.1)',\n    element: '0 2px 4px rgba(0,0,0,0.1)',\n    handle: '0 1px 2px rgba(0,0,0,0.1)',\n  },\n};\n\n// Default dark theme\nexport const darkTheme: Theme = {\n  name: 'dark',\n  colors: {\n    background: '#1e1e1e',\n    surface: '#252526',\n    border: '#3c3c3c',\n    text: {\n      primary: '#ffffff',\n      secondary: '#a0a0a0',\n      disabled: '#5a5a5a',\n    },\n    selection: {\n      fill: 'rgba(59, 130, 246, 0.2)',\n      stroke: '#60a5fa',\n    },\n    element: {\n      fill: '#2d2d2d',\n      stroke: '#ffffff',\n      hover: '#383838',\n      active: '#454545',\n    },\n    handle: {\n      fill: '#2d2d2d',\n      stroke: '#60a5fa',\n    },\n    grid: {\n      line: '#333333',\n      dot: '#444444',\n    },\n    connection: {\n      line: '#94a3b8',\n      arrow: '#94a3b8',\n    },\n  },\n  spacing: lightTheme.spacing,\n  borderRadius: lightTheme.borderRadius,\n  fontSize: lightTheme.fontSize,\n  strokeWidth: lightTheme.strokeWidth,\n  shadows: {\n    sm: '0 1px 2px rgba(0,0,0,0.3)',\n    md: '0 4px 6px rgba(0,0,0,0.4)',\n    lg: '0 10px 15px rgba(0,0,0,0.5)',\n    element: '0 2px 4px rgba(0,0,0,0.3)',\n    handle: '0 1px 2px rgba(0,0,0,0.3)',\n  },\n};\n\n// Context value interface\ninterface ThemeContextValue {\n  theme: Theme;\n  themeName: 'light' | 'dark' | 'custom';\n}\n\n// Create context with default light theme\nconst ThemeContext = createContext<ThemeContextValue>({\n  theme: lightTheme,\n  themeName: 'light',\n});\n\n// Hook to use theme\nexport const useTheme = (): ThemeContextValue => {\n  const context = useContext(ThemeContext);\n  if (!context) {\n    throw new Error('useTheme must be used within a ThemeProvider');\n  }\n  return context;\n};\n\n// Provider props\ninterface ThemeProviderProps {\n  children: React.ReactNode;\n  theme?: 'light' | 'dark' | Theme;\n}\n\n// Theme Provider component\nexport const ThemeProvider: React.FC<ThemeProviderProps> = ({ children, theme = 'light' }) => {\n  const value = useMemo<ThemeContextValue>(() => {\n    if (theme === 'light') {\n      return { theme: lightTheme, themeName: 'light' };\n    }\n    if (theme === 'dark') {\n      return { theme: darkTheme, themeName: 'dark' };\n    }\n    // Custom theme: merge with light theme as base\n    return {\n      theme: deepMerge(lightTheme, theme) as Theme,\n      themeName: 'custom',\n    };\n  }, [theme]);\n\n  return React.createElement(ThemeContext.Provider, { value }, children);\n};\n\n// CSS custom properties generator\nexport const getThemeCSSVariables = (theme: Theme): Record<string, string> => {\n  return {\n    '--canvas-bg': theme.colors.background,\n    '--canvas-surface': theme.colors.surface,\n    '--canvas-border': theme.colors.border,\n    '--canvas-text-primary': theme.colors.text.primary,\n    '--canvas-text-secondary': theme.colors.text.secondary,\n    '--canvas-text-disabled': theme.colors.text.disabled,\n    '--canvas-selection-fill': theme.colors.selection.fill,\n    '--canvas-selection-stroke': theme.colors.selection.stroke,\n    '--canvas-element-fill': theme.colors.element.fill,\n    '--canvas-element-stroke': theme.colors.element.stroke,\n    '--canvas-element-hover': theme.colors.element.hover,\n    '--canvas-element-active': theme.colors.element.active,\n    '--canvas-handle-fill': theme.colors.handle.fill,\n    '--canvas-handle-stroke': theme.colors.handle.stroke,\n    '--canvas-grid-line': theme.colors.grid.line,\n    '--canvas-grid-dot': theme.colors.grid.dot,\n    '--canvas-connection-line': theme.colors.connection.line,\n    '--canvas-connection-arrow': theme.colors.connection.arrow,\n    '--canvas-spacing-xs': `${theme.spacing.xs}px`,\n    '--canvas-spacing-sm': `${theme.spacing.sm}px`,\n    '--canvas-spacing-md': `${theme.spacing.md}px`,\n    '--canvas-spacing-lg': `${theme.spacing.lg}px`,\n    '--canvas-spacing-xl': `${theme.spacing.xl}px`,\n    '--canvas-radius-sm': `${theme.borderRadius.sm}px`,\n    '--canvas-radius-md': `${theme.borderRadius.md}px`,\n    '--canvas-radius-lg': `${theme.borderRadius.lg}px`,\n    '--canvas-font-xs': `${theme.fontSize.xs}px`,\n    '--canvas-font-sm': `${theme.fontSize.sm}px`,\n    '--canvas-font-md': `${theme.fontSize.md}px`,\n    '--canvas-font-lg': `${theme.fontSize.lg}px`,\n    '--canvas-font-xl': `${theme.fontSize.xl}px`,\n    '--canvas-stroke-thin': `${theme.strokeWidth.thin}px`,\n    '--canvas-stroke-normal': `${theme.strokeWidth.normal}px`,\n    '--canvas-stroke-thick': `${theme.strokeWidth.thick}px`,\n    '--canvas-shadow-sm': theme.shadows.sm,\n    '--canvas-shadow-md': theme.shadows.md,\n    '--canvas-shadow-lg': theme.shadows.lg,\n    '--canvas-shadow-element': theme.shadows.element,\n    '--canvas-shadow-handle': theme.shadows.handle,\n  };\n};\n\nexport { ThemeContext };\n","// Viewport Context\n// Manages zoom, pan, and coordinate transformations\n\nimport React, { createContext, useContext, useReducer, useCallback, useMemo } from 'react';\nimport type { Point, Bounds } from '@/types/elements';\nimport type { ViewportState } from '@/types/canvas';\n\n// Default viewport state\nconst defaultViewport: ViewportState = {\n  zoom: 1,\n  pan: { x: 0, y: 0 },\n  minZoom: 0.1,\n  maxZoom: 5,\n};\n\n// Action types\ntype ViewportAction =\n  | { type: 'SET_ZOOM'; payload: number }\n  | { type: 'ZOOM_IN' }\n  | { type: 'ZOOM_OUT' }\n  | { type: 'ZOOM_TO_FIT'; payload: { bounds: Bounds; padding?: number } }\n  | { type: 'SET_PAN'; payload: Point }\n  | { type: 'PAN_BY'; payload: Point }\n  | { type: 'RESET' }\n  | { type: 'SET_CONSTRAINTS'; payload: { minZoom?: number; maxZoom?: number } };\n\n// Reducer\nconst viewportReducer = (state: ViewportState, action: ViewportAction): ViewportState => {\n  switch (action.type) {\n    case 'SET_ZOOM': {\n      const zoom = Math.max(state.minZoom, Math.min(state.maxZoom, action.payload));\n      return { ...state, zoom };\n    }\n\n    case 'ZOOM_IN': {\n      const zoom = Math.min(state.maxZoom, state.zoom * 1.2);\n      return { ...state, zoom };\n    }\n\n    case 'ZOOM_OUT': {\n      const zoom = Math.max(state.minZoom, state.zoom / 1.2);\n      return { ...state, zoom };\n    }\n\n    case 'ZOOM_TO_FIT': {\n      const { bounds, padding = 50 } = action.payload;\n      // Calculate zoom to fit bounds with padding (using x, y, width, height format)\n      const zoom = Math.max(state.minZoom, Math.min(state.maxZoom, 1));\n      const pan = {\n        x: -(bounds.x - padding),\n        y: -(bounds.y - padding),\n      };\n      return { ...state, zoom, pan };\n    }\n\n    case 'SET_PAN':\n      return { ...state, pan: action.payload };\n\n    case 'PAN_BY':\n      return {\n        ...state,\n        pan: {\n          x: state.pan.x + action.payload.x,\n          y: state.pan.y + action.payload.y,\n        },\n      };\n\n    case 'RESET':\n      return { ...defaultViewport, minZoom: state.minZoom, maxZoom: state.maxZoom };\n\n    case 'SET_CONSTRAINTS':\n      return {\n        ...state,\n        minZoom: action.payload.minZoom ?? state.minZoom,\n        maxZoom: action.payload.maxZoom ?? state.maxZoom,\n      };\n\n    default:\n      return state;\n  }\n};\n\n// Context value interface\ninterface ViewportContextValue {\n  // State\n  viewport: ViewportState;\n\n  // Actions\n  setZoom: (zoom: number) => void;\n  zoomIn: () => void;\n  zoomOut: () => void;\n  zoomToFit: (bounds: Bounds, padding?: number) => void;\n  setPan: (pan: Point) => void;\n  panBy: (delta: Point) => void;\n  resetViewport: () => void;\n  setConstraints: (constraints: { minZoom?: number; maxZoom?: number }) => void;\n\n  // Coordinate transformations\n  screenToCanvas: (point: Point) => Point;\n  canvasToScreen: (point: Point) => Point;\n}\n\n// Create context\nconst ViewportContext = createContext<ViewportContextValue | null>(null);\n\n// Hook to use viewport\nexport const useViewport = (): ViewportContextValue => {\n  const context = useContext(ViewportContext);\n  if (!context) {\n    throw new Error('useViewport must be used within a ViewportProvider');\n  }\n  return context;\n};\n\n// Provider props\ninterface ViewportProviderProps {\n  children: React.ReactNode;\n  initialViewport?: Partial<ViewportState>;\n}\n\n// Viewport Provider component\nexport const ViewportProvider: React.FC<ViewportProviderProps> = ({\n  children,\n  initialViewport,\n}) => {\n  const [viewport, dispatch] = useReducer(viewportReducer, {\n    ...defaultViewport,\n    ...initialViewport,\n  });\n\n  // Actions\n  const setZoom = useCallback((zoom: number) => {\n    dispatch({ type: 'SET_ZOOM', payload: zoom });\n  }, []);\n\n  const zoomIn = useCallback(() => {\n    dispatch({ type: 'ZOOM_IN' });\n  }, []);\n\n  const zoomOut = useCallback(() => {\n    dispatch({ type: 'ZOOM_OUT' });\n  }, []);\n\n  const zoomToFit = useCallback((bounds: Bounds, padding?: number) => {\n    dispatch({ type: 'ZOOM_TO_FIT', payload: { bounds, padding } });\n  }, []);\n\n  const setPan = useCallback((pan: Point) => {\n    dispatch({ type: 'SET_PAN', payload: pan });\n  }, []);\n\n  const panBy = useCallback((delta: Point) => {\n    dispatch({ type: 'PAN_BY', payload: delta });\n  }, []);\n\n  const resetViewport = useCallback(() => {\n    dispatch({ type: 'RESET' });\n  }, []);\n\n  const setConstraints = useCallback(\n    (constraints: { minZoom?: number; maxZoom?: number }) => {\n      dispatch({ type: 'SET_CONSTRAINTS', payload: constraints });\n    },\n    []\n  );\n\n  // Coordinate transformations\n  const screenToCanvas = useCallback(\n    (point: Point): Point => {\n      return {\n        x: (point.x - viewport.pan.x) / viewport.zoom,\n        y: (point.y - viewport.pan.y) / viewport.zoom,\n      };\n    },\n    [viewport.zoom, viewport.pan]\n  );\n\n  const canvasToScreen = useCallback(\n    (point: Point): Point => {\n      return {\n        x: point.x * viewport.zoom + viewport.pan.x,\n        y: point.y * viewport.zoom + viewport.pan.y,\n      };\n    },\n    [viewport.zoom, viewport.pan]\n  );\n\n  const value = useMemo<ViewportContextValue>(\n    () => ({\n      viewport,\n      setZoom,\n      zoomIn,\n      zoomOut,\n      zoomToFit,\n      setPan,\n      panBy,\n      resetViewport,\n      setConstraints,\n      screenToCanvas,\n      canvasToScreen,\n    }),\n    [\n      viewport,\n      setZoom,\n      zoomIn,\n      zoomOut,\n      zoomToFit,\n      setPan,\n      panBy,\n      resetViewport,\n      setConstraints,\n      screenToCanvas,\n      canvasToScreen,\n    ]\n  );\n\n  return React.createElement(ViewportContext.Provider, { value }, children);\n};\n\nexport { ViewportContext };\n","// Selection Context\n// Manages element selection state (single and multi-select)\n\nimport React, { createContext, useContext, useReducer, useCallback, useMemo } from 'react';\n\n// Selection state\ninterface SelectionState {\n  selectedIds: Set<string>;\n  lastSelectedId: string | null;\n}\n\n// Default state\nconst defaultSelection: SelectionState = {\n  selectedIds: new Set(),\n  lastSelectedId: null,\n};\n\n// Action types\ntype SelectionAction =\n  | { type: 'SELECT'; payload: string }\n  | { type: 'SELECT_MULTIPLE'; payload: string[] }\n  | { type: 'ADD_TO_SELECTION'; payload: string }\n  | { type: 'REMOVE_FROM_SELECTION'; payload: string }\n  | { type: 'TOGGLE_SELECTION'; payload: string }\n  | { type: 'CLEAR_SELECTION' }\n  | { type: 'SELECT_ALL'; payload: string[] };\n\n// Reducer\nconst selectionReducer = (state: SelectionState, action: SelectionAction): SelectionState => {\n  switch (action.type) {\n    case 'SELECT':\n      return {\n        selectedIds: new Set([action.payload]),\n        lastSelectedId: action.payload,\n      };\n\n    case 'SELECT_MULTIPLE':\n      return {\n        selectedIds: new Set(action.payload),\n        lastSelectedId: action.payload.length > 0 ? action.payload[action.payload.length - 1] : null,\n      };\n\n    case 'ADD_TO_SELECTION': {\n      const newSet = new Set(state.selectedIds);\n      newSet.add(action.payload);\n      return {\n        selectedIds: newSet,\n        lastSelectedId: action.payload,\n      };\n    }\n\n    case 'REMOVE_FROM_SELECTION': {\n      const newSet = new Set(state.selectedIds);\n      newSet.delete(action.payload);\n      return {\n        selectedIds: newSet,\n        lastSelectedId: newSet.size > 0 ? Array.from(newSet).pop()! : null,\n      };\n    }\n\n    case 'TOGGLE_SELECTION': {\n      const newSet = new Set(state.selectedIds);\n      if (newSet.has(action.payload)) {\n        newSet.delete(action.payload);\n        return {\n          selectedIds: newSet,\n          lastSelectedId: newSet.size > 0 ? Array.from(newSet).pop()! : null,\n        };\n      } else {\n        newSet.add(action.payload);\n        return {\n          selectedIds: newSet,\n          lastSelectedId: action.payload,\n        };\n      }\n    }\n\n    case 'CLEAR_SELECTION':\n      return defaultSelection;\n\n    case 'SELECT_ALL':\n      return {\n        selectedIds: new Set(action.payload),\n        lastSelectedId: action.payload.length > 0 ? action.payload[action.payload.length - 1] : null,\n      };\n\n    default:\n      return state;\n  }\n};\n\n// Context value interface\ninterface SelectionContextValue {\n  // State\n  selectedIds: string[];\n  lastSelectedId: string | null;\n  selectionCount: number;\n  hasSelection: boolean;\n\n  // Queries\n  isSelected: (id: string) => boolean;\n\n  // Actions\n  select: (id: string) => void;\n  selectMultiple: (ids: string[]) => void;\n  addToSelection: (id: string) => void;\n  removeFromSelection: (id: string) => void;\n  toggleSelection: (id: string) => void;\n  clearSelection: () => void;\n  selectAll: (ids: string[]) => void;\n}\n\n// Create context\nconst SelectionContext = createContext<SelectionContextValue | null>(null);\n\n// Hook to use selection\nexport const useSelection = (): SelectionContextValue => {\n  const context = useContext(SelectionContext);\n  if (!context) {\n    throw new Error('useSelection must be used within a SelectionProvider');\n  }\n  return context;\n};\n\n// Provider props\ninterface SelectionProviderProps {\n  children: React.ReactNode;\n  initialSelection?: string[];\n  onSelectionChange?: (selectedIds: string[]) => void;\n}\n\n// Selection Provider component\nexport const SelectionProvider: React.FC<SelectionProviderProps> = ({\n  children,\n  initialSelection,\n  onSelectionChange,\n}) => {\n  const [state, dispatch] = useReducer(selectionReducer, {\n    selectedIds: new Set(initialSelection ?? []),\n    lastSelectedId: initialSelection?.[initialSelection.length - 1] ?? null,\n  });\n\n  // Notify on selection change\n  const selectedIdsArray = useMemo(() => Array.from(state.selectedIds), [state.selectedIds]);\n\n  React.useEffect(() => {\n    onSelectionChange?.(selectedIdsArray);\n  }, [selectedIdsArray, onSelectionChange]);\n\n  // Queries\n  const isSelected = useCallback(\n    (id: string): boolean => {\n      return state.selectedIds.has(id);\n    },\n    [state.selectedIds]\n  );\n\n  // Actions\n  const select = useCallback((id: string) => {\n    dispatch({ type: 'SELECT', payload: id });\n  }, []);\n\n  const selectMultiple = useCallback((ids: string[]) => {\n    dispatch({ type: 'SELECT_MULTIPLE', payload: ids });\n  }, []);\n\n  const addToSelection = useCallback((id: string) => {\n    dispatch({ type: 'ADD_TO_SELECTION', payload: id });\n  }, []);\n\n  const removeFromSelection = useCallback((id: string) => {\n    dispatch({ type: 'REMOVE_FROM_SELECTION', payload: id });\n  }, []);\n\n  const toggleSelection = useCallback((id: string) => {\n    dispatch({ type: 'TOGGLE_SELECTION', payload: id });\n  }, []);\n\n  const clearSelection = useCallback(() => {\n    dispatch({ type: 'CLEAR_SELECTION' });\n  }, []);\n\n  const selectAll = useCallback((ids: string[]) => {\n    dispatch({ type: 'SELECT_ALL', payload: ids });\n  }, []);\n\n  const value = useMemo<SelectionContextValue>(\n    () => ({\n      selectedIds: selectedIdsArray,\n      lastSelectedId: state.lastSelectedId,\n      selectionCount: state.selectedIds.size,\n      hasSelection: state.selectedIds.size > 0,\n      isSelected,\n      select,\n      selectMultiple,\n      addToSelection,\n      removeFromSelection,\n      toggleSelection,\n      clearSelection,\n      selectAll,\n    }),\n    [\n      selectedIdsArray,\n      state.lastSelectedId,\n      state.selectedIds.size,\n      isSelected,\n      select,\n      selectMultiple,\n      addToSelection,\n      removeFromSelection,\n      toggleSelection,\n      clearSelection,\n      selectAll,\n    ]\n  );\n\n  return React.createElement(SelectionContext.Provider, { value }, children);\n};\n\nexport { SelectionContext };\n","// History Context\n// Manages undo/redo history stack\n\nimport React, { createContext, useContext, useReducer, useCallback, useMemo } from 'react';\nimport type { CanvasElement, Connection } from '@/types/elements';\n\n// A snapshot of canvas state\nexport interface CanvasSnapshot {\n  elements: CanvasElement[];\n  connections: Connection[];\n  timestamp: number;\n}\n\n// History state\ninterface HistoryState {\n  past: CanvasSnapshot[];\n  present: CanvasSnapshot;\n  future: CanvasSnapshot[];\n  maxHistorySize: number;\n}\n\n// Action types\ntype HistoryAction =\n  | { type: 'PUSH'; payload: CanvasSnapshot }\n  | { type: 'UNDO' }\n  | { type: 'REDO' }\n  | { type: 'CLEAR' }\n  | { type: 'SET_PRESENT'; payload: CanvasSnapshot }\n  | { type: 'SET_MAX_SIZE'; payload: number };\n\n// Create initial snapshot\nconst createEmptySnapshot = (): CanvasSnapshot => ({\n  elements: [],\n  connections: [],\n  timestamp: Date.now(),\n});\n\n// Reducer\nconst historyReducer = (state: HistoryState, action: HistoryAction): HistoryState => {\n  switch (action.type) {\n    case 'PUSH': {\n      const newPast = [...state.past, state.present];\n      // Limit history size\n      if (newPast.length > state.maxHistorySize) {\n        newPast.shift();\n      }\n      return {\n        ...state,\n        past: newPast,\n        present: action.payload,\n        future: [], // Clear future on new action\n      };\n    }\n\n    case 'UNDO': {\n      if (state.past.length === 0) return state;\n      const previous = state.past[state.past.length - 1];\n      const newPast = state.past.slice(0, -1);\n      return {\n        ...state,\n        past: newPast,\n        present: previous,\n        future: [state.present, ...state.future],\n      };\n    }\n\n    case 'REDO': {\n      if (state.future.length === 0) return state;\n      const next = state.future[0];\n      const newFuture = state.future.slice(1);\n      return {\n        ...state,\n        past: [...state.past, state.present],\n        present: next,\n        future: newFuture,\n      };\n    }\n\n    case 'CLEAR':\n      return {\n        ...state,\n        past: [],\n        present: state.present,\n        future: [],\n      };\n\n    case 'SET_PRESENT':\n      return {\n        ...state,\n        present: action.payload,\n      };\n\n    case 'SET_MAX_SIZE':\n      return {\n        ...state,\n        maxHistorySize: action.payload,\n      };\n\n    default:\n      return state;\n  }\n};\n\n// Context value interface\ninterface HistoryContextValue {\n  // State\n  canUndo: boolean;\n  canRedo: boolean;\n  historySize: number;\n  futureSize: number;\n  present: CanvasSnapshot;\n\n  // Actions\n  pushState: (elements: CanvasElement[], connections: Connection[]) => void;\n  undo: () => void;\n  redo: () => void;\n  clearHistory: () => void;\n  setPresent: (elements: CanvasElement[], connections: Connection[]) => void;\n  setMaxHistorySize: (size: number) => void;\n}\n\n// Create context\nconst HistoryContext = createContext<HistoryContextValue | null>(null);\n\n// Hook to use history\nexport const useHistory = (): HistoryContextValue => {\n  const context = useContext(HistoryContext);\n  if (!context) {\n    throw new Error('useHistory must be used within a HistoryProvider');\n  }\n  return context;\n};\n\n// Provider props\ninterface HistoryProviderProps {\n  children: React.ReactNode;\n  initialElements?: CanvasElement[];\n  initialConnections?: Connection[];\n  maxHistorySize?: number;\n  onStateChange?: (elements: CanvasElement[], connections: Connection[]) => void;\n}\n\n// History Provider component\nexport const HistoryProvider: React.FC<HistoryProviderProps> = ({\n  children,\n  initialElements = [],\n  initialConnections = [],\n  maxHistorySize = 50,\n  onStateChange,\n}) => {\n  const [state, dispatch] = useReducer(historyReducer, {\n    past: [],\n    present: {\n      elements: initialElements,\n      connections: initialConnections,\n      timestamp: Date.now(),\n    },\n    future: [],\n    maxHistorySize,\n  });\n\n  // Notify on state change\n  React.useEffect(() => {\n    onStateChange?.(state.present.elements, state.present.connections);\n  }, [state.present, onStateChange]);\n\n  // Actions\n  const pushState = useCallback((elements: CanvasElement[], connections: Connection[]) => {\n    dispatch({\n      type: 'PUSH',\n      payload: {\n        elements,\n        connections,\n        timestamp: Date.now(),\n      },\n    });\n  }, []);\n\n  const undo = useCallback(() => {\n    dispatch({ type: 'UNDO' });\n  }, []);\n\n  const redo = useCallback(() => {\n    dispatch({ type: 'REDO' });\n  }, []);\n\n  const clearHistory = useCallback(() => {\n    dispatch({ type: 'CLEAR' });\n  }, []);\n\n  const setPresent = useCallback((elements: CanvasElement[], connections: Connection[]) => {\n    dispatch({\n      type: 'SET_PRESENT',\n      payload: {\n        elements,\n        connections,\n        timestamp: Date.now(),\n      },\n    });\n  }, []);\n\n  const setMaxHistorySize = useCallback((size: number) => {\n    dispatch({ type: 'SET_MAX_SIZE', payload: size });\n  }, []);\n\n  const value = useMemo<HistoryContextValue>(\n    () => ({\n      canUndo: state.past.length > 0,\n      canRedo: state.future.length > 0,\n      historySize: state.past.length,\n      futureSize: state.future.length,\n      present: state.present,\n      pushState,\n      undo,\n      redo,\n      clearHistory,\n      setPresent,\n      setMaxHistorySize,\n    }),\n    [state.past.length, state.future.length, state.present, pushState, undo, redo, clearHistory, setPresent, setMaxHistorySize]\n  );\n\n  return React.createElement(HistoryContext.Provider, { value }, children);\n};\n\nexport { HistoryContext };\n","// Canvas Context\n// Manages canvas elements and connections state\n\nimport React, { createContext, useContext, useReducer, useCallback, useMemo } from 'react';\nimport type { CanvasElement, Connection, ElementType } from '@/types/elements';\nimport type { CanvasConfig } from '@/types/canvas';\nimport { generateId, bringToFront, sendToBack, bringForward, sendBackward } from '@/core/utils';\n\n// Canvas state\ninterface CanvasState {\n  elements: CanvasElement[];\n  connections: Connection[];\n  config: CanvasConfig;\n}\n\n// Default config\nconst defaultConfig: CanvasConfig = {\n  width: 800,\n  height: 600,\n  grid: {\n    enabled: false,\n    size: 20,\n    snap: false,\n    visible: false,\n  },\n  readonly: false,\n};\n\n// Action types\ntype CanvasAction =\n  // Element actions\n  | { type: 'ADD_ELEMENT'; payload: CanvasElement }\n  | { type: 'ADD_ELEMENTS'; payload: CanvasElement[] }\n  | { type: 'UPDATE_ELEMENT'; payload: { id: string; updates: Partial<CanvasElement> } }\n  | { type: 'UPDATE_ELEMENTS'; payload: { ids: string[]; updates: Partial<CanvasElement> } }\n  | { type: 'REMOVE_ELEMENT'; payload: string }\n  | { type: 'REMOVE_ELEMENTS'; payload: string[] }\n  | { type: 'MOVE_ELEMENT'; payload: { id: string; x: number; y: number } }\n  | { type: 'MOVE_ELEMENTS'; payload: { ids: string[]; deltaX: number; deltaY: number } }\n  | { type: 'RESIZE_ELEMENT'; payload: { id: string; width: number; height: number; x?: number; y?: number } }\n  | { type: 'BRING_TO_FRONT'; payload: string }\n  | { type: 'SEND_TO_BACK'; payload: string }\n  | { type: 'MOVE_UP'; payload: string }\n  | { type: 'MOVE_DOWN'; payload: string }\n  | { type: 'SET_ELEMENTS'; payload: CanvasElement[] }\n  // Connection actions\n  | { type: 'ADD_CONNECTION'; payload: Connection }\n  | { type: 'UPDATE_CONNECTION'; payload: { id: string; updates: Partial<Connection> } }\n  | { type: 'REMOVE_CONNECTION'; payload: string }\n  | { type: 'SET_CONNECTIONS'; payload: Connection[] }\n  // Config actions\n  | { type: 'UPDATE_CONFIG'; payload: Partial<CanvasConfig> }\n  // Bulk actions\n  | { type: 'CLEAR_CANVAS' }\n  | { type: 'LOAD_STATE'; payload: { elements: CanvasElement[]; connections: Connection[] } };\n\n// Reducer\nconst canvasReducer = (state: CanvasState, action: CanvasAction): CanvasState => {\n  switch (action.type) {\n    // Element actions\n    case 'ADD_ELEMENT':\n      return {\n        ...state,\n        elements: [...state.elements, action.payload],\n      };\n\n    case 'ADD_ELEMENTS':\n      return {\n        ...state,\n        elements: [...state.elements, ...action.payload],\n      };\n\n    case 'UPDATE_ELEMENT':\n      return {\n        ...state,\n        elements: state.elements.map((el) =>\n          el.id === action.payload.id ? { ...el, ...action.payload.updates } : el\n        ),\n      };\n\n    case 'UPDATE_ELEMENTS':\n      return {\n        ...state,\n        elements: state.elements.map((el) =>\n          action.payload.ids.includes(el.id) ? { ...el, ...action.payload.updates } : el\n        ),\n      };\n\n    case 'REMOVE_ELEMENT': {\n      const elementId = action.payload;\n      return {\n        ...state,\n        elements: state.elements.filter((el) => el.id !== elementId),\n        // Also remove connections involving this element\n        connections: state.connections.filter(\n          (conn) => conn.fromId !== elementId && conn.toId !== elementId\n        ),\n      };\n    }\n\n    case 'REMOVE_ELEMENTS': {\n      const idsToRemove = new Set(action.payload);\n      return {\n        ...state,\n        elements: state.elements.filter((el) => !idsToRemove.has(el.id)),\n        connections: state.connections.filter(\n          (conn) => !idsToRemove.has(conn.fromId) && !idsToRemove.has(conn.toId)\n        ),\n      };\n    }\n\n    case 'MOVE_ELEMENT':\n      return {\n        ...state,\n        elements: state.elements.map((el) =>\n          el.id === action.payload.id\n            ? { ...el, x: action.payload.x, y: action.payload.y }\n            : el\n        ),\n      };\n\n    case 'MOVE_ELEMENTS':\n      return {\n        ...state,\n        elements: state.elements.map((el) =>\n          action.payload.ids.includes(el.id)\n            ? { ...el, x: el.x + action.payload.deltaX, y: el.y + action.payload.deltaY }\n            : el\n        ),\n      };\n\n    case 'RESIZE_ELEMENT':\n      return {\n        ...state,\n        elements: state.elements.map((el) =>\n          el.id === action.payload.id\n            ? {\n                ...el,\n                width: action.payload.width,\n                height: action.payload.height,\n                ...(action.payload.x !== undefined && { x: action.payload.x }),\n                ...(action.payload.y !== undefined && { y: action.payload.y }),\n              }\n            : el\n        ),\n      };\n\n    case 'BRING_TO_FRONT':\n      return {\n        ...state,\n        elements: bringToFront(state.elements, action.payload),\n      };\n\n    case 'SEND_TO_BACK':\n      return {\n        ...state,\n        elements: sendToBack(state.elements, action.payload),\n      };\n\n    case 'MOVE_UP':\n      return {\n        ...state,\n        elements: bringForward(state.elements, action.payload),\n      };\n\n    case 'MOVE_DOWN':\n      return {\n        ...state,\n        elements: sendBackward(state.elements, action.payload),\n      };\n\n    case 'SET_ELEMENTS':\n      return {\n        ...state,\n        elements: action.payload,\n      };\n\n    // Connection actions\n    case 'ADD_CONNECTION':\n      return {\n        ...state,\n        connections: [...state.connections, action.payload],\n      };\n\n    case 'UPDATE_CONNECTION':\n      return {\n        ...state,\n        connections: state.connections.map((conn) =>\n          conn.id === action.payload.id ? { ...conn, ...action.payload.updates } : conn\n        ),\n      };\n\n    case 'REMOVE_CONNECTION':\n      return {\n        ...state,\n        connections: state.connections.filter((conn) => conn.id !== action.payload),\n      };\n\n    case 'SET_CONNECTIONS':\n      return {\n        ...state,\n        connections: action.payload,\n      };\n\n    // Config actions\n    case 'UPDATE_CONFIG':\n      return {\n        ...state,\n        config: { ...state.config, ...action.payload },\n      };\n\n    // Bulk actions\n    case 'CLEAR_CANVAS':\n      return {\n        ...state,\n        elements: [],\n        connections: [],\n      };\n\n    case 'LOAD_STATE':\n      return {\n        ...state,\n        elements: action.payload.elements,\n        connections: action.payload.connections,\n      };\n\n    default:\n      return state;\n  }\n};\n\n// Context value interface\ninterface CanvasContextValue {\n  // State\n  elements: CanvasElement[];\n  connections: Connection[];\n  config: CanvasConfig;\n\n  // Element queries\n  getElementById: (id: string) => CanvasElement | undefined;\n  getElementsByType: (type: ElementType) => CanvasElement[];\n\n  // Element actions\n  addElement: (element: Omit<CanvasElement, 'id'> & { id?: string }) => string;\n  addElements: (elements: Array<Omit<CanvasElement, 'id'> & { id?: string }>) => string[];\n  updateElement: (id: string, updates: Partial<CanvasElement>) => void;\n  updateElements: (ids: string[], updates: Partial<CanvasElement>) => void;\n  removeElement: (id: string) => void;\n  removeElements: (ids: string[]) => void;\n  moveElement: (id: string, x: number, y: number) => void;\n  moveElements: (ids: string[], deltaX: number, deltaY: number) => void;\n  resizeElement: (id: string, width: number, height: number, x?: number, y?: number) => void;\n  bringToFront: (id: string) => void;\n  sendToBack: (id: string) => void;\n  moveUp: (id: string) => void;\n  moveDown: (id: string) => void;\n  setElements: (elements: CanvasElement[]) => void;\n\n  // Connection queries\n  getConnectionById: (id: string) => Connection | undefined;\n  getConnectionsForElement: (elementId: string) => Connection[];\n\n  // Connection actions\n  addConnection: (connection: Omit<Connection, 'id'> & { id?: string }) => string;\n  updateConnection: (id: string, updates: Partial<Connection>) => void;\n  removeConnection: (id: string) => void;\n  setConnections: (connections: Connection[]) => void;\n\n  // Config actions\n  updateConfig: (config: Partial<CanvasConfig>) => void;\n\n  // Bulk actions\n  clearCanvas: () => void;\n  loadState: (elements: CanvasElement[], connections: Connection[]) => void;\n}\n\n// Create context\nconst CanvasContext = createContext<CanvasContextValue | null>(null);\n\n// Hook to use canvas\nexport const useCanvas = (): CanvasContextValue => {\n  const context = useContext(CanvasContext);\n  if (!context) {\n    throw new Error('useCanvas must be used within a CanvasProvider');\n  }\n  return context;\n};\n\n// Provider props\ninterface CanvasProviderProps {\n  children: React.ReactNode;\n  initialElements?: CanvasElement[];\n  initialConnections?: Connection[];\n  config?: Partial<CanvasConfig>;\n  onChange?: (elements: CanvasElement[], connections: Connection[]) => void;\n}\n\n// Canvas Provider component\nexport const CanvasProvider: React.FC<CanvasProviderProps> = ({\n  children,\n  initialElements = [],\n  initialConnections = [],\n  config: initialConfig,\n  onChange,\n}) => {\n  const [state, dispatch] = useReducer(canvasReducer, {\n    elements: initialElements,\n    connections: initialConnections,\n    config: { ...defaultConfig, ...initialConfig },\n  });\n\n  // Notify on change\n  React.useEffect(() => {\n    onChange?.(state.elements, state.connections);\n  }, [state.elements, state.connections, onChange]);\n\n  // Element queries\n  const getElementById = useCallback(\n    (id: string) => state.elements.find((el) => el.id === id),\n    [state.elements]\n  );\n\n  const getElementsByType = useCallback(\n    (type: ElementType) => state.elements.filter((el) => el.type === type),\n    [state.elements]\n  );\n\n  // Element actions\n  const addElement = useCallback(\n    (element: Omit<CanvasElement, 'id'> & { id?: string }): string => {\n      const id = element.id ?? generateId();\n      const maxZIndex = state.elements.length > 0\n        ? Math.max(...state.elements.map((el) => el.zIndex))\n        : 0;\n      dispatch({\n        type: 'ADD_ELEMENT',\n        payload: { ...element, id, zIndex: element.zIndex ?? maxZIndex + 1 } as CanvasElement,\n      });\n      return id;\n    },\n    [state.elements]\n  );\n\n  const addElements = useCallback(\n    (elements: Array<Omit<CanvasElement, 'id'> & { id?: string }>): string[] => {\n      const maxZIndex = state.elements.length > 0\n        ? Math.max(...state.elements.map((el) => el.zIndex))\n        : 0;\n      const newElements = elements.map((el, i) => ({\n        ...el,\n        id: el.id ?? generateId(),\n        zIndex: el.zIndex ?? maxZIndex + 1 + i,\n      })) as CanvasElement[];\n      dispatch({ type: 'ADD_ELEMENTS', payload: newElements });\n      return newElements.map((el) => el.id);\n    },\n    [state.elements]\n  );\n\n  const updateElement = useCallback((id: string, updates: Partial<CanvasElement>) => {\n    dispatch({ type: 'UPDATE_ELEMENT', payload: { id, updates } });\n  }, []);\n\n  const updateElements = useCallback((ids: string[], updates: Partial<CanvasElement>) => {\n    dispatch({ type: 'UPDATE_ELEMENTS', payload: { ids, updates } });\n  }, []);\n\n  const removeElement = useCallback((id: string) => {\n    dispatch({ type: 'REMOVE_ELEMENT', payload: id });\n  }, []);\n\n  const removeElements = useCallback((ids: string[]) => {\n    dispatch({ type: 'REMOVE_ELEMENTS', payload: ids });\n  }, []);\n\n  const moveElement = useCallback((id: string, x: number, y: number) => {\n    dispatch({ type: 'MOVE_ELEMENT', payload: { id, x, y } });\n  }, []);\n\n  const moveElements = useCallback((ids: string[], deltaX: number, deltaY: number) => {\n    dispatch({ type: 'MOVE_ELEMENTS', payload: { ids, deltaX, deltaY } });\n  }, []);\n\n  const resizeElement = useCallback(\n    (id: string, width: number, height: number, x?: number, y?: number) => {\n      dispatch({ type: 'RESIZE_ELEMENT', payload: { id, width, height, x, y } });\n    },\n    []\n  );\n\n  const bringToFrontAction = useCallback((id: string) => {\n    dispatch({ type: 'BRING_TO_FRONT', payload: id });\n  }, []);\n\n  const sendToBackAction = useCallback((id: string) => {\n    dispatch({ type: 'SEND_TO_BACK', payload: id });\n  }, []);\n\n  const moveUpAction = useCallback((id: string) => {\n    dispatch({ type: 'MOVE_UP', payload: id });\n  }, []);\n\n  const moveDownAction = useCallback((id: string) => {\n    dispatch({ type: 'MOVE_DOWN', payload: id });\n  }, []);\n\n  const setElements = useCallback((elements: CanvasElement[]) => {\n    dispatch({ type: 'SET_ELEMENTS', payload: elements });\n  }, []);\n\n  // Connection queries\n  const getConnectionById = useCallback(\n    (id: string) => state.connections.find((conn) => conn.id === id),\n    [state.connections]\n  );\n\n  const getConnectionsForElement = useCallback(\n    (elementId: string) =>\n      state.connections.filter(\n        (conn) => conn.fromId === elementId || conn.toId === elementId\n      ),\n    [state.connections]\n  );\n\n  // Connection actions\n  const addConnection = useCallback(\n    (connection: Omit<Connection, 'id'> & { id?: string }): string => {\n      const id = connection.id ?? generateId();\n      dispatch({\n        type: 'ADD_CONNECTION',\n        payload: { ...connection, id } as Connection,\n      });\n      return id;\n    },\n    []\n  );\n\n  const updateConnection = useCallback((id: string, updates: Partial<Connection>) => {\n    dispatch({ type: 'UPDATE_CONNECTION', payload: { id, updates } });\n  }, []);\n\n  const removeConnection = useCallback((id: string) => {\n    dispatch({ type: 'REMOVE_CONNECTION', payload: id });\n  }, []);\n\n  const setConnections = useCallback((connections: Connection[]) => {\n    dispatch({ type: 'SET_CONNECTIONS', payload: connections });\n  }, []);\n\n  // Config actions\n  const updateConfig = useCallback((config: Partial<CanvasConfig>) => {\n    dispatch({ type: 'UPDATE_CONFIG', payload: config });\n  }, []);\n\n  // Bulk actions\n  const clearCanvas = useCallback(() => {\n    dispatch({ type: 'CLEAR_CANVAS' });\n  }, []);\n\n  const loadState = useCallback((elements: CanvasElement[], connections: Connection[]) => {\n    dispatch({ type: 'LOAD_STATE', payload: { elements, connections } });\n  }, []);\n\n  const value = useMemo<CanvasContextValue>(\n    () => ({\n      elements: state.elements,\n      connections: state.connections,\n      config: state.config,\n      getElementById,\n      getElementsByType,\n      addElement,\n      addElements,\n      updateElement,\n      updateElements,\n      removeElement,\n      removeElements,\n      moveElement,\n      moveElements,\n      resizeElement,\n      bringToFront: bringToFrontAction,\n      sendToBack: sendToBackAction,\n      moveUp: moveUpAction,\n      moveDown: moveDownAction,\n      setElements,\n      getConnectionById,\n      getConnectionsForElement,\n      addConnection,\n      updateConnection,\n      removeConnection,\n      setConnections,\n      updateConfig,\n      clearCanvas,\n      loadState,\n    }),\n    [\n      state.elements,\n      state.connections,\n      state.config,\n      getElementById,\n      getElementsByType,\n      addElement,\n      addElements,\n      updateElement,\n      updateElements,\n      removeElement,\n      removeElements,\n      moveElement,\n      moveElements,\n      resizeElement,\n      bringToFrontAction,\n      sendToBackAction,\n      moveUpAction,\n      moveDownAction,\n      setElements,\n      getConnectionById,\n      getConnectionsForElement,\n      addConnection,\n      updateConnection,\n      removeConnection,\n      setConnections,\n      updateConfig,\n      clearCanvas,\n      loadState,\n    ]\n  );\n\n  return React.createElement(CanvasContext.Provider, { value }, children);\n};\n\nexport { CanvasContext };\n","// Combined Canvas Provider\n// Composes all context providers into a single provider\n\nimport React from 'react';\nimport type { CanvasElement, Connection } from '@/types/elements';\nimport type { CanvasConfig, ViewportState } from '@/types/canvas';\nimport type { Theme } from '@/types/theme';\nimport { ThemeProvider } from './ThemeContext';\nimport { ViewportProvider } from './ViewportContext';\nimport { SelectionProvider } from './SelectionContext';\nimport { HistoryProvider } from './HistoryContext';\nimport { CanvasProvider as CanvasStateProvider } from './CanvasContext';\n\nexport interface CombinedCanvasProviderProps {\n  children: React.ReactNode;\n\n  // Initial data\n  initialElements?: CanvasElement[];\n  initialConnections?: Connection[];\n\n  // Configuration\n  config?: Partial<CanvasConfig>;\n  theme?: 'light' | 'dark' | Theme;\n\n  // Viewport settings\n  initialViewport?: Partial<ViewportState>;\n\n  // History settings\n  maxHistorySize?: number;\n\n  // Callbacks\n  onElementsChange?: (elements: CanvasElement[], connections: Connection[]) => void;\n  onSelectionChange?: (selectedIds: string[]) => void;\n\n  // Controlled mode support\n  elements?: CanvasElement[];\n  connections?: Connection[];\n  selectedIds?: string[];\n}\n\n/**\n * Combined provider that composes all canvas contexts\n * Use this for full-featured canvas components\n */\nexport const CombinedCanvasProvider: React.FC<CombinedCanvasProviderProps> = ({\n  children,\n  initialElements = [],\n  initialConnections = [],\n  config,\n  theme = 'light',\n  initialViewport,\n  maxHistorySize = 50,\n  onElementsChange,\n  onSelectionChange,\n  elements,\n  connections,\n  selectedIds,\n}) => {\n  // Use controlled elements if provided, otherwise use initial\n  const effectiveElements = elements ?? initialElements;\n  const effectiveConnections = connections ?? initialConnections;\n\n  return (\n    <ThemeProvider theme={theme}>\n      <ViewportProvider initialViewport={initialViewport}>\n        <SelectionProvider\n          initialSelection={selectedIds}\n          onSelectionChange={onSelectionChange}\n        >\n          <HistoryProvider\n            initialElements={effectiveElements}\n            initialConnections={effectiveConnections}\n            maxHistorySize={maxHistorySize}\n          >\n            <CanvasStateProvider\n              initialElements={effectiveElements}\n              initialConnections={effectiveConnections}\n              config={config}\n              onChange={onElementsChange}\n            >\n              {children}\n            </CanvasStateProvider>\n          </HistoryProvider>\n        </SelectionProvider>\n      </ViewportProvider>\n    </ThemeProvider>\n  );\n};\n\nexport default CombinedCanvasProvider;\n","// useDraggable hook\n// Provides drag functionality for elements\n\nimport { useCallback, useRef, useState } from \"react\";\nimport type { Point } from \"@/types/elements\";\nimport { useViewport } from \"@/core/context\";\n\nexport interface DragState {\n\tisDragging: boolean;\n\tstartPosition: Point | null;\n\tcurrentPosition: Point | null;\n\tdelta: Point;\n}\n\nexport interface UseDraggableOptions {\n\tonDragStart?: (position: Point) => void;\n\tonDrag?: (position: Point, delta: Point) => void;\n\tonDragEnd?: (position: Point, delta: Point) => void;\n\tdisabled?: boolean;\n\tthreshold?: number; // Minimum movement to start dragging\n\tconstrainToParent?: boolean;\n}\n\nexport interface UseDraggableReturn {\n\tdragState: DragState;\n\thandlers: {\n\t\tonMouseDown: (e: React.MouseEvent) => void;\n\t\tonTouchStart: (e: React.TouchEvent) => void;\n\t};\n\tisDragging: boolean;\n}\n\nexport const useDraggable = (\n\toptions: UseDraggableOptions = {},\n): UseDraggableReturn => {\n\tconst {\n\t\tonDragStart,\n\t\tonDrag,\n\t\tonDragEnd,\n\t\tdisabled = false,\n\t\tthreshold = 3,\n\t} = options;\n\n\tconst [dragState, setDragState] = useState<DragState>({\n\t\tisDragging: false,\n\t\tstartPosition: null,\n\t\tcurrentPosition: null,\n\t\tdelta: { x: 0, y: 0 },\n\t});\n\n\tconst startRef = useRef<Point | null>(null);\n\tconst hasPassedThreshold = useRef(false);\n\tconst { screenToCanvas } = useViewport();\n\n\tconst getEventPosition = useCallback(\n\t\t(e: MouseEvent | TouchEvent): Point => {\n\t\t\tif (\"touches\" in e) {\n\t\t\t\tconst touch = e.touches[0] || e.changedTouches[0];\n\t\t\t\treturn screenToCanvas({ x: touch.clientX, y: touch.clientY });\n\t\t\t}\n\t\t\treturn screenToCanvas({ x: e.clientX, y: e.clientY });\n\t\t},\n\t\t[screenToCanvas],\n\t);\n\n\tconst handleMove = useCallback(\n\t\t(e: MouseEvent | TouchEvent) => {\n\t\t\tif (!startRef.current) return;\n\n\t\t\tconst currentPos = getEventPosition(e);\n\t\t\tconst delta = {\n\t\t\t\tx: currentPos.x - startRef.current.x,\n\t\t\t\ty: currentPos.y - startRef.current.y,\n\t\t\t};\n\n\t\t\t// Check threshold\n\t\t\tif (!hasPassedThreshold.current) {\n\t\t\t\tconst distance = Math.sqrt(delta.x ** 2 + delta.y ** 2);\n\t\t\t\tif (distance < threshold) return;\n\t\t\t\thasPassedThreshold.current = true;\n\t\t\t\tonDragStart?.(startRef.current);\n\t\t\t}\n\n\t\t\tsetDragState({\n\t\t\t\tisDragging: true,\n\t\t\t\tstartPosition: startRef.current,\n\t\t\t\tcurrentPosition: currentPos,\n\t\t\t\tdelta,\n\t\t\t});\n\n\t\t\tonDrag?.(currentPos, delta);\n\t\t},\n\t\t[getEventPosition, threshold, onDragStart, onDrag],\n\t);\n\n\tconst handleEnd = useCallback(\n\t\t(e: MouseEvent | TouchEvent) => {\n\t\t\tif (!startRef.current) return;\n\n\t\t\tconst endPos = getEventPosition(e);\n\t\t\tconst delta = {\n\t\t\t\tx: endPos.x - startRef.current.x,\n\t\t\t\ty: endPos.y - startRef.current.y,\n\t\t\t};\n\n\t\t\tif (hasPassedThreshold.current) {\n\t\t\t\tonDragEnd?.(endPos, delta);\n\t\t\t}\n\n\t\t\tsetDragState({\n\t\t\t\tisDragging: false,\n\t\t\t\tstartPosition: null,\n\t\t\t\tcurrentPosition: null,\n\t\t\t\tdelta: { x: 0, y: 0 },\n\t\t\t});\n\n\t\t\tstartRef.current = null;\n\t\t\thasPassedThreshold.current = false;\n\n\t\t\t// Cleanup listeners\n\t\t\tdocument.removeEventListener(\"mousemove\", handleMove);\n\t\t\tdocument.removeEventListener(\"mouseup\", handleEnd);\n\t\t\tdocument.removeEventListener(\"touchmove\", handleMove);\n\t\t\tdocument.removeEventListener(\"touchend\", handleEnd);\n\t\t},\n\t\t[getEventPosition, handleMove, onDragEnd],\n\t);\n\n\tconst handleStart = useCallback(\n\t\t(clientX: number, clientY: number) => {\n\t\t\tif (disabled) return;\n\n\t\t\tconst startPos = screenToCanvas({ x: clientX, y: clientY });\n\t\t\tstartRef.current = startPos;\n\t\t\thasPassedThreshold.current = false;\n\n\t\t\tsetDragState({\n\t\t\t\tisDragging: false,\n\t\t\t\tstartPosition: startPos,\n\t\t\t\tcurrentPosition: startPos,\n\t\t\t\tdelta: { x: 0, y: 0 },\n\t\t\t});\n\n\t\t\t// Add listeners\n\t\t\tdocument.addEventListener(\"mousemove\", handleMove);\n\t\t\tdocument.addEventListener(\"mouseup\", handleEnd);\n\t\t\tdocument.addEventListener(\"touchmove\", handleMove, { passive: false });\n\t\t\tdocument.addEventListener(\"touchend\", handleEnd);\n\t\t},\n\t\t[disabled, screenToCanvas, handleMove, handleEnd],\n\t);\n\n\tconst onMouseDown = useCallback(\n\t\t(e: React.MouseEvent) => {\n\t\t\tif (e.button !== 0) return; // Only left click\n\t\t\te.preventDefault();\n\t\t\te.stopPropagation();\n\t\t\thandleStart(e.clientX, e.clientY);\n\t\t},\n\t\t[handleStart],\n\t);\n\n\tconst onTouchStart = useCallback(\n\t\t(e: React.TouchEvent) => {\n\t\t\tif (e.touches.length !== 1) return; // Single touch only\n\t\t\tconst touch = e.touches[0];\n\t\t\thandleStart(touch.clientX, touch.clientY);\n\t\t},\n\t\t[handleStart],\n\t);\n\n\treturn {\n\t\tdragState,\n\t\thandlers: {\n\t\t\tonMouseDown,\n\t\t\tonTouchStart,\n\t\t},\n\t\tisDragging: dragState.isDragging,\n\t};\n};\n\nexport default useDraggable;\n","// useResizable hook\n// Provides resize functionality for elements\n\nimport { useCallback, useRef, useState } from \"react\";\nimport type { Point } from \"@/types/elements\";\nimport type { ResizeHandle } from \"@/core/utils/geometry\";\nimport { useViewport } from \"@/core/context\";\n\nexport interface ResizeState {\n\tisResizing: boolean;\n\thandle: ResizeHandle | null;\n\tstartBounds: { x: number; y: number; width: number; height: number } | null;\n\tcurrentBounds: { x: number; y: number; width: number; height: number } | null;\n}\n\nexport interface UseResizableOptions {\n\tonResizeStart?: (handle: ResizeHandle) => void;\n\tonResize?: (bounds: {\n\t\tx: number;\n\t\ty: number;\n\t\twidth: number;\n\t\theight: number;\n\t}) => void;\n\tonResizeEnd?: (bounds: {\n\t\tx: number;\n\t\ty: number;\n\t\twidth: number;\n\t\theight: number;\n\t}) => void;\n\tdisabled?: boolean;\n\tminWidth?: number;\n\tminHeight?: number;\n\tmaxWidth?: number;\n\tmaxHeight?: number;\n\tmaintainAspectRatio?: boolean;\n\taspectRatio?: number;\n}\n\nexport interface UseResizableReturn {\n\tresizeState: ResizeState;\n\tstartResize: (\n\t\thandle: ResizeHandle,\n\t\tbounds: { x: number; y: number; width: number; height: number },\n\t\te: React.MouseEvent | React.TouchEvent,\n\t) => void;\n\tisResizing: boolean;\n}\n\nexport const useResizable = (\n\toptions: UseResizableOptions = {},\n): UseResizableReturn => {\n\tconst {\n\t\tonResizeStart,\n\t\tonResize,\n\t\tonResizeEnd,\n\t\tdisabled = false,\n\t\tminWidth = 20,\n\t\tminHeight = 20,\n\t\tmaxWidth = Infinity,\n\t\tmaxHeight = Infinity,\n\t\tmaintainAspectRatio = false,\n\t\taspectRatio,\n\t} = options;\n\n\tconst [resizeState, setResizeState] = useState<ResizeState>({\n\t\tisResizing: false,\n\t\thandle: null,\n\t\tstartBounds: null,\n\t\tcurrentBounds: null,\n\t});\n\n\tconst startRef = useRef<{\n\t\tposition: Point;\n\t\tbounds: { x: number; y: number; width: number; height: number };\n\t\thandle: ResizeHandle;\n\t\taspectRatio: number;\n\t} | null>(null);\n\n\tconst { screenToCanvas } = useViewport();\n\n\tconst getEventPosition = useCallback(\n\t\t(e: MouseEvent | TouchEvent): Point => {\n\t\t\tif (\"touches\" in e) {\n\t\t\t\tconst touch = e.touches[0] || e.changedTouches[0];\n\t\t\t\treturn screenToCanvas({ x: touch.clientX, y: touch.clientY });\n\t\t\t}\n\t\t\treturn screenToCanvas({ x: e.clientX, y: e.clientY });\n\t\t},\n\t\t[screenToCanvas],\n\t);\n\n\tconst calculateNewBounds = useCallback(\n\t\t(\n\t\t\tcurrentPos: Point,\n\t\t): { x: number; y: number; width: number; height: number } => {\n\t\t\tif (!startRef.current) {\n\t\t\t\treturn { x: 0, y: 0, width: 0, height: 0 };\n\t\t\t}\n\n\t\t\tconst { position: startPos, bounds, handle } = startRef.current;\n\t\t\tconst deltaX = currentPos.x - startPos.x;\n\t\t\tconst deltaY = currentPos.y - startPos.y;\n\n\t\t\tlet newX = bounds.x;\n\t\t\tlet newY = bounds.y;\n\t\t\tlet newWidth = bounds.width;\n\t\t\tlet newHeight = bounds.height;\n\n\t\t\t// Calculate based on handle position\n\t\t\tswitch (handle) {\n\t\t\t\tcase \"nw\":\n\t\t\t\t\tnewX = bounds.x + deltaX;\n\t\t\t\t\tnewY = bounds.y + deltaY;\n\t\t\t\t\tnewWidth = bounds.width - deltaX;\n\t\t\t\t\tnewHeight = bounds.height - deltaY;\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"n\":\n\t\t\t\t\tnewY = bounds.y + deltaY;\n\t\t\t\t\tnewHeight = bounds.height - deltaY;\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"ne\":\n\t\t\t\t\tnewY = bounds.y + deltaY;\n\t\t\t\t\tnewWidth = bounds.width + deltaX;\n\t\t\t\t\tnewHeight = bounds.height - deltaY;\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"e\":\n\t\t\t\t\tnewWidth = bounds.width + deltaX;\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"se\":\n\t\t\t\t\tnewWidth = bounds.width + deltaX;\n\t\t\t\t\tnewHeight = bounds.height + deltaY;\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"s\":\n\t\t\t\t\tnewHeight = bounds.height + deltaY;\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"sw\":\n\t\t\t\t\tnewX = bounds.x + deltaX;\n\t\t\t\t\tnewWidth = bounds.width - deltaX;\n\t\t\t\t\tnewHeight = bounds.height + deltaY;\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"w\":\n\t\t\t\t\tnewX = bounds.x + deltaX;\n\t\t\t\t\tnewWidth = bounds.width - deltaX;\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\t// Apply constraints\n\t\t\tif (newWidth < minWidth) {\n\t\t\t\tif (handle.includes(\"w\")) {\n\t\t\t\t\tnewX = bounds.x + bounds.width - minWidth;\n\t\t\t\t}\n\t\t\t\tnewWidth = minWidth;\n\t\t\t}\n\t\t\tif (newHeight < minHeight) {\n\t\t\t\tif (handle.includes(\"n\")) {\n\t\t\t\t\tnewY = bounds.y + bounds.height - minHeight;\n\t\t\t\t}\n\t\t\t\tnewHeight = minHeight;\n\t\t\t}\n\t\t\tif (newWidth > maxWidth) {\n\t\t\t\tnewWidth = maxWidth;\n\t\t\t}\n\t\t\tif (newHeight > maxHeight) {\n\t\t\t\tnewHeight = maxHeight;\n\t\t\t}\n\n\t\t\t// Maintain aspect ratio if needed\n\t\t\tif (maintainAspectRatio && startRef.current.aspectRatio) {\n\t\t\t\tconst targetRatio = startRef.current.aspectRatio;\n\t\t\t\tconst currentRatio = newWidth / newHeight;\n\n\t\t\t\tif (currentRatio > targetRatio) {\n\t\t\t\t\tnewWidth = newHeight * targetRatio;\n\t\t\t\t} else {\n\t\t\t\t\tnewHeight = newWidth / targetRatio;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn { x: newX, y: newY, width: newWidth, height: newHeight };\n\t\t},\n\t\t[minWidth, minHeight, maxWidth, maxHeight, maintainAspectRatio],\n\t);\n\n\tconst handleMove = useCallback(\n\t\t(e: MouseEvent | TouchEvent) => {\n\t\t\tif (!startRef.current) return;\n\n\t\t\tconst currentPos = getEventPosition(e);\n\t\t\tconst newBounds = calculateNewBounds(currentPos);\n\n\t\t\tsetResizeState((prev) => ({\n\t\t\t\t...prev,\n\t\t\t\tcurrentBounds: newBounds,\n\t\t\t}));\n\n\t\t\tonResize?.(newBounds);\n\t\t},\n\t\t[getEventPosition, calculateNewBounds, onResize],\n\t);\n\n\tconst handleEnd = useCallback(\n\t\t(e: MouseEvent | TouchEvent) => {\n\t\t\tif (!startRef.current) return;\n\n\t\t\tconst endPos = getEventPosition(e);\n\t\t\tconst finalBounds = calculateNewBounds(endPos);\n\n\t\t\tonResizeEnd?.(finalBounds);\n\n\t\t\tsetResizeState({\n\t\t\t\tisResizing: false,\n\t\t\t\thandle: null,\n\t\t\t\tstartBounds: null,\n\t\t\t\tcurrentBounds: null,\n\t\t\t});\n\n\t\t\tstartRef.current = null;\n\n\t\t\t// Cleanup listeners\n\t\t\tdocument.removeEventListener(\"mousemove\", handleMove);\n\t\t\tdocument.removeEventListener(\"mouseup\", handleEnd);\n\t\t\tdocument.removeEventListener(\"touchmove\", handleMove);\n\t\t\tdocument.removeEventListener(\"touchend\", handleEnd);\n\t\t},\n\t\t[getEventPosition, calculateNewBounds, handleMove, onResizeEnd],\n\t);\n\n\tconst startResize = useCallback(\n\t\t(\n\t\t\thandle: ResizeHandle,\n\t\t\tbounds: { x: number; y: number; width: number; height: number },\n\t\t\te: React.MouseEvent | React.TouchEvent,\n\t\t) => {\n\t\t\tif (disabled) return;\n\n\t\t\te.preventDefault();\n\t\t\te.stopPropagation();\n\n\t\t\tconst clientX = \"touches\" in e ? e.touches[0].clientX : e.clientX;\n\t\t\tconst clientY = \"touches\" in e ? e.touches[0].clientY : e.clientY;\n\t\t\tconst startPos = screenToCanvas({ x: clientX, y: clientY });\n\n\t\t\tstartRef.current = {\n\t\t\t\tposition: startPos,\n\t\t\t\tbounds,\n\t\t\t\thandle,\n\t\t\t\taspectRatio: aspectRatio ?? bounds.width / bounds.height,\n\t\t\t};\n\n\t\t\tsetResizeState({\n\t\t\t\tisResizing: true,\n\t\t\t\thandle,\n\t\t\t\tstartBounds: bounds,\n\t\t\t\tcurrentBounds: bounds,\n\t\t\t});\n\n\t\t\tonResizeStart?.(handle);\n\n\t\t\t// Add listeners\n\t\t\tdocument.addEventListener(\"mousemove\", handleMove);\n\t\t\tdocument.addEventListener(\"mouseup\", handleEnd);\n\t\t\tdocument.addEventListener(\"touchmove\", handleMove, { passive: false });\n\t\t\tdocument.addEventListener(\"touchend\", handleEnd);\n\t\t},\n\t\t[\n\t\t\tdisabled,\n\t\t\tscreenToCanvas,\n\t\t\taspectRatio,\n\t\t\tonResizeStart,\n\t\t\thandleMove,\n\t\t\thandleEnd,\n\t\t],\n\t);\n\n\treturn {\n\t\tresizeState,\n\t\tstartResize,\n\t\tisResizing: resizeState.isResizing,\n\t};\n};\n\nexport default useResizable;\n","// useRotatable hook\n// Provides rotation functionality for elements\n\nimport { useCallback, useRef, useState } from \"react\";\nimport type { Point } from \"@/types/elements\";\nimport { useViewport } from \"@/core/context\";\n\nexport interface RotateState {\n\tisRotating: boolean;\n\tstartAngle: number | null;\n\tcurrentAngle: number | null;\n\tdeltaAngle: number;\n}\n\nexport interface UseRotatableOptions {\n\tonRotateStart?: (angle: number) => void;\n\tonRotate?: (angle: number, deltaAngle: number) => void;\n\tonRotateEnd?: (angle: number) => void;\n\tdisabled?: boolean;\n\tsnapAngle?: number; // Snap to multiples of this angle (e.g., 15 for 15 increments)\n\tcenter?: Point; // Center point for rotation\n}\n\nexport interface UseRotatableReturn {\n\trotateState: RotateState;\n\tstartRotate: (\n\t\tcenter: Point,\n\t\tinitialRotation: number,\n\t\te: React.MouseEvent | React.TouchEvent,\n\t) => void;\n\tisRotating: boolean;\n}\n\nexport const useRotatable = (\n\toptions: UseRotatableOptions = {},\n): UseRotatableReturn => {\n\tconst {\n\t\tonRotateStart,\n\t\tonRotate,\n\t\tonRotateEnd,\n\t\tdisabled = false,\n\t\tsnapAngle,\n\t} = options;\n\n\tconst [rotateState, setRotateState] = useState<RotateState>({\n\t\tisRotating: false,\n\t\tstartAngle: null,\n\t\tcurrentAngle: null,\n\t\tdeltaAngle: 0,\n\t});\n\n\tconst startRef = useRef<{\n\t\tcenter: Point;\n\t\tstartMouseAngle: number;\n\t\tinitialRotation: number;\n\t} | null>(null);\n\n\tconst { screenToCanvas } = useViewport();\n\n\tconst getEventPosition = useCallback(\n\t\t(e: MouseEvent | TouchEvent): Point => {\n\t\t\tif (\"touches\" in e) {\n\t\t\t\tconst touch = e.touches[0] || e.changedTouches[0];\n\t\t\t\treturn screenToCanvas({ x: touch.clientX, y: touch.clientY });\n\t\t\t}\n\t\t\treturn screenToCanvas({ x: e.clientX, y: e.clientY });\n\t\t},\n\t\t[screenToCanvas],\n\t);\n\n\t// Calculate angle from center to point\n\tconst getAngle = useCallback((center: Point, point: Point): number => {\n\t\tconst dx = point.x - center.x;\n\t\tconst dy = point.y - center.y;\n\t\treturn Math.atan2(dy, dx) * (180 / Math.PI);\n\t}, []);\n\n\t// Snap angle to nearest multiple\n\tconst snapToAngle = useCallback(\n\t\t(angle: number): number => {\n\t\t\tif (!snapAngle) return angle;\n\t\t\treturn Math.round(angle / snapAngle) * snapAngle;\n\t\t},\n\t\t[snapAngle],\n\t);\n\n\tconst handleMove = useCallback(\n\t\t(e: MouseEvent | TouchEvent) => {\n\t\t\tif (!startRef.current || disabled) return;\n\n\t\t\tconst currentPos = getEventPosition(e);\n\t\t\tconst { center, startMouseAngle, initialRotation } = startRef.current;\n\n\t\t\tconst currentMouseAngle = getAngle(center, currentPos);\n\t\t\tlet deltaAngle = currentMouseAngle - startMouseAngle;\n\t\t\tlet newAngle = initialRotation + deltaAngle;\n\n\t\t\t// Normalize to 0-360\n\t\t\tnewAngle = ((newAngle % 360) + 360) % 360;\n\n\t\t\t// Apply snapping if shift is held\n\t\t\tif ((e as MouseEvent).shiftKey && snapAngle) {\n\t\t\t\tnewAngle = snapToAngle(newAngle);\n\t\t\t}\n\n\t\t\tsetRotateState({\n\t\t\t\tisRotating: true,\n\t\t\t\tstartAngle: initialRotation,\n\t\t\t\tcurrentAngle: newAngle,\n\t\t\t\tdeltaAngle: newAngle - initialRotation,\n\t\t\t});\n\n\t\t\tonRotate?.(newAngle, newAngle - initialRotation);\n\t\t},\n\t\t[disabled, getEventPosition, getAngle, snapAngle, snapToAngle, onRotate],\n\t);\n\n\tconst handleEnd = useCallback(\n\t\t(e: MouseEvent | TouchEvent) => {\n\t\t\tif (!startRef.current) return;\n\n\t\t\tconst currentPos = getEventPosition(e);\n\t\t\tconst { center, startMouseAngle, initialRotation } = startRef.current;\n\n\t\t\tconst currentMouseAngle = getAngle(center, currentPos);\n\t\t\tlet deltaAngle = currentMouseAngle - startMouseAngle;\n\t\t\tlet finalAngle = initialRotation + deltaAngle;\n\n\t\t\t// Normalize to 0-360\n\t\t\tfinalAngle = ((finalAngle % 360) + 360) % 360;\n\n\t\t\t// Apply snapping\n\t\t\tif ((e as MouseEvent).shiftKey && snapAngle) {\n\t\t\t\tfinalAngle = snapToAngle(finalAngle);\n\t\t\t}\n\n\t\t\tonRotateEnd?.(finalAngle);\n\n\t\t\tsetRotateState({\n\t\t\t\tisRotating: false,\n\t\t\t\tstartAngle: null,\n\t\t\t\tcurrentAngle: null,\n\t\t\t\tdeltaAngle: 0,\n\t\t\t});\n\n\t\t\tstartRef.current = null;\n\n\t\t\t// Cleanup listeners\n\t\t\tdocument.removeEventListener(\"mousemove\", handleMove);\n\t\t\tdocument.removeEventListener(\"mouseup\", handleEnd);\n\t\t\tdocument.removeEventListener(\"touchmove\", handleMove);\n\t\t\tdocument.removeEventListener(\"touchend\", handleEnd);\n\t\t},\n\t\t[\n\t\t\tgetEventPosition,\n\t\t\tgetAngle,\n\t\t\tsnapAngle,\n\t\t\tsnapToAngle,\n\t\t\tonRotateEnd,\n\t\t\thandleMove,\n\t\t],\n\t);\n\n\tconst startRotate = useCallback(\n\t\t(\n\t\t\tcenter: Point,\n\t\t\tinitialRotation: number,\n\t\t\te: React.MouseEvent | React.TouchEvent,\n\t\t) => {\n\t\t\tif (disabled) return;\n\n\t\t\te.stopPropagation();\n\t\t\te.preventDefault();\n\n\t\t\tconst startPos = getEventPosition(\n\t\t\t\te.nativeEvent as MouseEvent | TouchEvent,\n\t\t\t);\n\t\t\tconst startMouseAngle = getAngle(center, startPos);\n\n\t\t\tstartRef.current = {\n\t\t\t\tcenter,\n\t\t\t\tstartMouseAngle,\n\t\t\t\tinitialRotation,\n\t\t\t};\n\n\t\t\tsetRotateState({\n\t\t\t\tisRotating: true,\n\t\t\t\tstartAngle: initialRotation,\n\t\t\t\tcurrentAngle: initialRotation,\n\t\t\t\tdeltaAngle: 0,\n\t\t\t});\n\n\t\t\tonRotateStart?.(initialRotation);\n\n\t\t\t// Add listeners\n\t\t\tdocument.addEventListener(\"mousemove\", handleMove);\n\t\t\tdocument.addEventListener(\"mouseup\", handleEnd);\n\t\t\tdocument.addEventListener(\"touchmove\", handleMove);\n\t\t\tdocument.addEventListener(\"touchend\", handleEnd);\n\t\t},\n\t\t[\n\t\t\tdisabled,\n\t\t\tgetEventPosition,\n\t\t\tgetAngle,\n\t\t\tonRotateStart,\n\t\t\thandleMove,\n\t\t\thandleEnd,\n\t\t],\n\t);\n\n\treturn {\n\t\trotateState,\n\t\tstartRotate,\n\t\tisRotating: rotateState.isRotating,\n\t};\n};\n\nexport default useRotatable;\n","// useSelectable hook\n// Provides selection functionality for elements\n\nimport { useCallback } from \"react\";\nimport { useSelection } from \"@/core/context\";\n\nexport interface UseSelectableOptions {\n\tid: string;\n\tdisabled?: boolean;\n\tonSelect?: (selected: boolean) => void;\n}\n\nexport interface UseSelectableReturn {\n\tisSelected: boolean;\n\thandlers: {\n\t\tonClick: (e: React.MouseEvent) => void;\n\t};\n\tselect: () => void;\n\tdeselect: () => void;\n\ttoggle: () => void;\n}\n\nexport const useSelectable = (\n\toptions: UseSelectableOptions,\n): UseSelectableReturn => {\n\tconst { id, disabled = false, onSelect } = options;\n\tconst {\n\t\tisSelected: checkSelected,\n\t\tselect: selectElement,\n\t\taddToSelection,\n\t\tremoveFromSelection,\n\t\ttoggleSelection,\n\t\tclearSelection,\n\t} = useSelection();\n\n\tconst isSelected = checkSelected(id);\n\n\tconst select = useCallback(() => {\n\t\tif (disabled) return;\n\t\tselectElement(id);\n\t\tonSelect?.(true);\n\t}, [disabled, id, selectElement, onSelect]);\n\n\tconst deselect = useCallback(() => {\n\t\tif (disabled) return;\n\t\tremoveFromSelection(id);\n\t\tonSelect?.(false);\n\t}, [disabled, id, removeFromSelection, onSelect]);\n\n\tconst toggle = useCallback(() => {\n\t\tif (disabled) return;\n\t\tconst willBeSelected = !isSelected;\n\t\ttoggleSelection(id);\n\t\tonSelect?.(willBeSelected);\n\t}, [disabled, id, isSelected, toggleSelection, onSelect]);\n\n\tconst onClick = useCallback(\n\t\t(e: React.MouseEvent) => {\n\t\t\tif (disabled) return;\n\n\t\t\te.stopPropagation();\n\n\t\t\t// Multi-select with Ctrl/Cmd or Shift\n\t\t\tif (e.ctrlKey || e.metaKey) {\n\t\t\t\ttoggleSelection(id);\n\t\t\t\tonSelect?.(!isSelected);\n\t\t\t} else if (e.shiftKey) {\n\t\t\t\t// Add to selection\n\t\t\t\taddToSelection(id);\n\t\t\t\tonSelect?.(true);\n\t\t\t} else {\n\t\t\t\t// Single select - clear others and select this\n\t\t\t\tselectElement(id);\n\t\t\t\tonSelect?.(true);\n\t\t\t}\n\t\t},\n\t\t[\n\t\t\tdisabled,\n\t\t\tid,\n\t\t\tisSelected,\n\t\t\ttoggleSelection,\n\t\t\taddToSelection,\n\t\t\tselectElement,\n\t\t\tonSelect,\n\t\t],\n\t);\n\n\treturn {\n\t\tisSelected,\n\t\thandlers: {\n\t\t\tonClick,\n\t\t},\n\t\tselect,\n\t\tdeselect,\n\t\ttoggle,\n\t};\n};\n\nexport default useSelectable;\n","// useKeyboard hook\n// Provides keyboard shortcut handling for canvas\n\nimport { useEffect, useCallback, useRef } from \"react\";\n\nexport type KeyboardShortcut = {\n\tkey: string;\n\tctrl?: boolean;\n\tmeta?: boolean;\n\tshift?: boolean;\n\talt?: boolean;\n\taction: () => void;\n\tpreventDefault?: boolean;\n};\n\nexport interface UseKeyboardOptions {\n\tshortcuts?: KeyboardShortcut[];\n\tenabled?: boolean;\n\ttargetRef?: React.RefObject<HTMLElement>;\n}\n\n/**\n * Matches a keyboard event against a shortcut definition\n */\nconst matchesShortcut = (\n\te: KeyboardEvent,\n\tshortcut: KeyboardShortcut,\n): boolean => {\n\tconst keyMatches = e.key.toLowerCase() === shortcut.key.toLowerCase();\n\tconst ctrlMatches = shortcut.ctrl\n\t\t? e.ctrlKey\n\t\t: !e.ctrlKey || Boolean(shortcut.meta);\n\tconst metaMatches = shortcut.meta\n\t\t? e.metaKey\n\t\t: !e.metaKey || Boolean(shortcut.ctrl);\n\tconst shiftMatches = shortcut.shift ? e.shiftKey : !e.shiftKey;\n\tconst altMatches = shortcut.alt ? e.altKey : !e.altKey;\n\n\t// For Ctrl/Meta, allow either on macOS\n\tconst modifierMatches =\n\t\tshortcut.ctrl || shortcut.meta\n\t\t\t? Boolean(shortcut.ctrl && (e.ctrlKey || e.metaKey)) ||\n\t\t\t\tBoolean(shortcut.meta && e.metaKey)\n\t\t\t: !e.ctrlKey && !e.metaKey;\n\n\treturn keyMatches && modifierMatches && shiftMatches && altMatches;\n};\n\nexport const useKeyboard = (options: UseKeyboardOptions = {}): void => {\n\tconst { shortcuts = [], enabled = true, targetRef } = options;\n\tconst shortcutsRef = useRef(shortcuts);\n\tshortcutsRef.current = shortcuts;\n\n\tconst handleKeyDown = useCallback(\n\t\t(e: KeyboardEvent) => {\n\t\t\tif (!enabled) return;\n\n\t\t\tfor (const shortcut of shortcutsRef.current) {\n\t\t\t\tif (matchesShortcut(e, shortcut)) {\n\t\t\t\t\tif (shortcut.preventDefault !== false) {\n\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t}\n\t\t\t\t\tshortcut.action();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\t[enabled],\n\t);\n\n\tuseEffect(() => {\n\t\tconst target = targetRef?.current ?? document;\n\t\ttarget.addEventListener(\"keydown\", handleKeyDown as EventListener);\n\t\treturn () => {\n\t\t\ttarget.removeEventListener(\"keydown\", handleKeyDown as EventListener);\n\t\t};\n\t}, [handleKeyDown, targetRef]);\n};\n\n/**\n * Common canvas shortcuts preset\n */\nexport const useCanvasKeyboardShortcuts = (actions: {\n\tundo?: () => void;\n\tredo?: () => void;\n\tdelete?: () => void;\n\tselectAll?: () => void;\n\tcopy?: () => void;\n\tpaste?: () => void;\n\tcut?: () => void;\n\tescape?: () => void;\n\tzoomIn?: () => void;\n\tzoomOut?: () => void;\n\tresetZoom?: () => void;\n}): void => {\n\tconst shortcuts: KeyboardShortcut[] = [];\n\n\tif (actions.undo) {\n\t\tshortcuts.push({ key: \"z\", ctrl: true, action: actions.undo });\n\t}\n\tif (actions.redo) {\n\t\tshortcuts.push({ key: \"z\", ctrl: true, shift: true, action: actions.redo });\n\t\tshortcuts.push({ key: \"y\", ctrl: true, action: actions.redo });\n\t}\n\tif (actions.delete) {\n\t\tshortcuts.push({ key: \"Delete\", action: actions.delete });\n\t\tshortcuts.push({ key: \"Backspace\", action: actions.delete });\n\t}\n\tif (actions.selectAll) {\n\t\tshortcuts.push({ key: \"a\", ctrl: true, action: actions.selectAll });\n\t}\n\tif (actions.copy) {\n\t\tshortcuts.push({ key: \"c\", ctrl: true, action: actions.copy });\n\t}\n\tif (actions.paste) {\n\t\tshortcuts.push({ key: \"v\", ctrl: true, action: actions.paste });\n\t}\n\tif (actions.cut) {\n\t\tshortcuts.push({ key: \"x\", ctrl: true, action: actions.cut });\n\t}\n\tif (actions.escape) {\n\t\tshortcuts.push({ key: \"Escape\", action: actions.escape });\n\t}\n\tif (actions.zoomIn) {\n\t\tshortcuts.push({ key: \"+\", ctrl: true, action: actions.zoomIn });\n\t\tshortcuts.push({ key: \"=\", ctrl: true, action: actions.zoomIn });\n\t}\n\tif (actions.zoomOut) {\n\t\tshortcuts.push({ key: \"-\", ctrl: true, action: actions.zoomOut });\n\t}\n\tif (actions.resetZoom) {\n\t\tshortcuts.push({ key: \"0\", ctrl: true, action: actions.resetZoom });\n\t}\n\n\tuseKeyboard({ shortcuts });\n};\n\nexport default useKeyboard;\n","// useCanvasActions hook\n// Combines common canvas operations with history support\n\nimport { useCallback, useRef } from \"react\";\nimport { useCanvas, useSelection, useHistory } from \"@/core/context\";\nimport type { CanvasElement, Connection } from \"@/types/elements\";\n\nexport interface UseCanvasActionsReturn {\n\t// Element operations with history\n\taddElement: (element: Omit<CanvasElement, \"id\"> & { id?: string }) => string;\n\tupdateElement: (id: string, updates: Partial<CanvasElement>) => void;\n\tremoveElement: (id: string) => void;\n\tremoveSelected: () => void;\n\tmoveSelected: (deltaX: number, deltaY: number) => void;\n\tduplicateSelected: () => string[];\n\n\t// Connection operations with history\n\taddConnection: (\n\t\tconnection: Omit<Connection, \"id\"> & { id?: string },\n\t) => string;\n\tremoveConnection: (id: string) => void;\n\n\t// Clipboard operations\n\tcopy: () => void;\n\tcut: () => void;\n\tpaste: () => void;\n\thasCopied: boolean;\n\n\t// History operations\n\tundo: () => void;\n\tredo: () => void;\n\tcanUndo: boolean;\n\tcanRedo: boolean;\n}\n\nexport const useCanvasActions = (): UseCanvasActionsReturn => {\n\tconst canvas = useCanvas();\n\tconst selection = useSelection();\n\tconst history = useHistory();\n\n\t// Clipboard storage\n\tconst clipboardRef = useRef<{\n\t\telements: CanvasElement[];\n\t\tconnections: Connection[];\n\t} | null>(null);\n\n\t// Save state to history before making changes\n\tconst saveState = useCallback(() => {\n\t\thistory.pushState(canvas.elements, canvas.connections);\n\t}, [history, canvas.elements, canvas.connections]);\n\n\t// Element operations\n\tconst addElement = useCallback(\n\t\t(element: Omit<CanvasElement, \"id\"> & { id?: string }): string => {\n\t\t\tsaveState();\n\t\t\treturn canvas.addElement(element);\n\t\t},\n\t\t[canvas, saveState],\n\t);\n\n\tconst updateElement = useCallback(\n\t\t(id: string, updates: Partial<CanvasElement>) => {\n\t\t\tsaveState();\n\t\t\tcanvas.updateElement(id, updates);\n\t\t},\n\t\t[canvas, saveState],\n\t);\n\n\tconst removeElement = useCallback(\n\t\t(id: string) => {\n\t\t\tsaveState();\n\t\t\tcanvas.removeElement(id);\n\t\t},\n\t\t[canvas, saveState],\n\t);\n\n\tconst removeSelected = useCallback(() => {\n\t\tif (selection.selectedIds.length === 0) return;\n\t\tsaveState();\n\t\tcanvas.removeElements(selection.selectedIds);\n\t\tselection.clearSelection();\n\t}, [canvas, selection, saveState]);\n\n\tconst moveSelected = useCallback(\n\t\t(deltaX: number, deltaY: number) => {\n\t\t\tif (selection.selectedIds.length === 0) return;\n\t\t\tsaveState();\n\t\t\tcanvas.moveElements(selection.selectedIds, deltaX, deltaY);\n\t\t},\n\t\t[canvas, selection, saveState],\n\t);\n\n\tconst duplicateSelected = useCallback((): string[] => {\n\t\tif (selection.selectedIds.length === 0) return [];\n\n\t\tsaveState();\n\n\t\tconst selectedElements = canvas.elements.filter((el) =>\n\t\t\tselection.selectedIds.includes(el.id),\n\t\t);\n\n\t\t// Create duplicates with offset\n\t\tconst duplicates = selectedElements.map((el) => ({\n\t\t\t...el,\n\t\t\tid: undefined, // Will be auto-generated\n\t\t\tx: el.x + 20,\n\t\t\ty: el.y + 20,\n\t\t}));\n\n\t\tconst newIds = canvas.addElements(duplicates);\n\t\tselection.selectMultiple(newIds);\n\t\treturn newIds;\n\t}, [canvas, selection, saveState]);\n\n\t// Connection operations\n\tconst addConnection = useCallback(\n\t\t(connection: Omit<Connection, \"id\"> & { id?: string }): string => {\n\t\t\tsaveState();\n\t\t\treturn canvas.addConnection(connection);\n\t\t},\n\t\t[canvas, saveState],\n\t);\n\n\tconst removeConnection = useCallback(\n\t\t(id: string) => {\n\t\t\tsaveState();\n\t\t\tcanvas.removeConnection(id);\n\t\t},\n\t\t[canvas, saveState],\n\t);\n\n\t// Clipboard operations\n\tconst copy = useCallback(() => {\n\t\tif (selection.selectedIds.length === 0) return;\n\n\t\tconst selectedElements = canvas.elements.filter((el) =>\n\t\t\tselection.selectedIds.includes(el.id),\n\t\t);\n\t\tconst selectedIds = new Set(selection.selectedIds);\n\t\tconst relevantConnections = canvas.connections.filter(\n\t\t\t(conn) => selectedIds.has(conn.fromId) && selectedIds.has(conn.toId),\n\t\t);\n\n\t\tclipboardRef.current = {\n\t\t\telements: selectedElements,\n\t\t\tconnections: relevantConnections,\n\t\t};\n\t}, [canvas.elements, canvas.connections, selection.selectedIds]);\n\n\tconst cut = useCallback(() => {\n\t\tcopy();\n\t\tremoveSelected();\n\t}, [copy, removeSelected]);\n\n\tconst paste = useCallback(() => {\n\t\tif (!clipboardRef.current) return;\n\n\t\tsaveState();\n\n\t\t// Create ID mapping for connections\n\t\tconst idMap = new Map<string, string>();\n\n\t\t// Paste elements with offset and new IDs\n\t\tconst newElements = clipboardRef.current.elements.map((el) => ({\n\t\t\t...el,\n\t\t\tid: undefined,\n\t\t\tx: el.x + 20,\n\t\t\ty: el.y + 20,\n\t\t}));\n\n\t\tconst newIds = canvas.addElements(newElements);\n\n\t\t// Map old IDs to new IDs\n\t\tclipboardRef.current.elements.forEach((el, i) => {\n\t\t\tidMap.set(el.id, newIds[i]);\n\t\t});\n\n\t\t// Paste connections with updated IDs\n\t\tclipboardRef.current.connections.forEach((conn) => {\n\t\t\tconst newFromId = idMap.get(conn.fromId);\n\t\t\tconst newToId = idMap.get(conn.toId);\n\t\t\tif (newFromId && newToId) {\n\t\t\t\tcanvas.addConnection({\n\t\t\t\t\t...conn,\n\t\t\t\t\tid: undefined,\n\t\t\t\t\tfromId: newFromId,\n\t\t\t\t\ttoId: newToId,\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\n\t\tselection.selectMultiple(newIds);\n\t}, [canvas, selection, saveState]);\n\n\t// History operations\n\tconst undo = useCallback(() => {\n\t\tif (!history.canUndo) return;\n\t\thistory.undo();\n\t\tcanvas.loadState(history.present.elements, history.present.connections);\n\t}, [history, canvas]);\n\n\tconst redo = useCallback(() => {\n\t\tif (!history.canRedo) return;\n\t\thistory.redo();\n\t\tcanvas.loadState(history.present.elements, history.present.connections);\n\t}, [history, canvas]);\n\n\treturn {\n\t\taddElement,\n\t\tupdateElement,\n\t\tremoveElement,\n\t\tremoveSelected,\n\t\tmoveSelected,\n\t\tduplicateSelected,\n\t\taddConnection,\n\t\tremoveConnection,\n\t\tcopy,\n\t\tcut,\n\t\tpaste,\n\t\thasCopied: clipboardRef.current !== null,\n\t\tundo,\n\t\tredo,\n\t\tcanUndo: history.canUndo,\n\t\tcanRedo: history.canRedo,\n\t};\n};\n\nexport default useCanvasActions;\n","// ElementBase component\n// Base wrapper for all canvas elements with common functionality\n\nimport React, { forwardRef, useCallback, useMemo } from 'react';\nimport type { CanvasElement } from '@/types/elements';\nimport { useSelectable, useDraggable, useResizable, useRotatable } from '@/core/hooks';\nimport { useCanvas, useTheme } from '@/core/context';\nimport { cx, getResizeHandles } from '@/core/utils';\nimport type { ResizeHandle } from '@/core/utils/geometry';\n\nexport interface ElementBaseProps {\n  element: CanvasElement;\n  children: React.ReactNode;\n  className?: string;\n  style?: React.CSSProperties;\n  disabled?: boolean;\n  showHandles?: boolean;\n  enableRotation?: boolean;\n  onSelect?: (selected: boolean) => void;\n  onDragStart?: () => void;\n  onDrag?: (x: number, y: number) => void;\n  onDragEnd?: (x: number, y: number) => void;\n  onResizeStart?: () => void;\n  onResize?: (width: number, height: number, x: number, y: number) => void;\n  onResizeEnd?: (width: number, height: number, x: number, y: number) => void;\n  onRotateStart?: () => void;\n  onRotate?: (rotation: number) => void;\n  onRotateEnd?: (rotation: number) => void;\n}\n\nconst HANDLE_SIZE = 8;\nconst ROTATION_HANDLE_OFFSET = 25; // Distance above the element\n\nexport const ElementBase = forwardRef<SVGGElement, ElementBaseProps>(\n  (\n    {\n      element,\n      children,\n      className,\n      style,\n      disabled = false,\n      showHandles = true,\n      enableRotation = true,\n      onSelect,\n      onDragStart,\n      onDrag,\n      onDragEnd,\n      onResizeStart,\n      onResize,\n      onResizeEnd,\n      onRotateStart,\n      onRotate,\n      onRotateEnd,\n    },\n    ref\n  ) => {\n    const { updateElement } = useCanvas();\n    const { theme } = useTheme();\n    const isReadonly = element.locked || disabled;\n\n    // Selection\n    const { isSelected, handlers: selectionHandlers } = useSelectable({\n      id: element.id,\n      disabled: isReadonly,\n      onSelect,\n    });\n\n    // Dragging\n    const { isDragging, dragState, handlers: dragHandlers } = useDraggable({\n      disabled: isReadonly || !isSelected,\n      onDragStart: () => {\n        onDragStart?.();\n      },\n      onDrag: (pos, delta) => {\n        const newX = element.x + delta.x;\n        const newY = element.y + delta.y;\n        onDrag?.(newX, newY);\n      },\n      onDragEnd: (pos, delta) => {\n        const newX = element.x + delta.x;\n        const newY = element.y + delta.y;\n        updateElement(element.id, { x: newX, y: newY });\n        onDragEnd?.(newX, newY);\n      },\n    });\n\n    // Resizing\n    const { isResizing, resizeState, startResize } = useResizable({\n      disabled: isReadonly || !isSelected,\n      minWidth: element.minWidth ?? 20,\n      minHeight: element.minHeight ?? 20,\n      maxWidth: element.maxWidth,\n      maxHeight: element.maxHeight,\n      onResizeStart: () => {\n        onResizeStart?.();\n      },\n      onResize: (bounds) => {\n        onResize?.(bounds.width, bounds.height, bounds.x, bounds.y);\n      },\n      onResizeEnd: (bounds) => {\n        updateElement(element.id, {\n          x: bounds.x,\n          y: bounds.y,\n          width: bounds.width,\n          height: bounds.height,\n        });\n        onResizeEnd?.(bounds.width, bounds.height, bounds.x, bounds.y);\n      },\n    });\n\n    // Rotation\n    const { isRotating, rotateState, startRotate } = useRotatable({\n      disabled: isReadonly || !isSelected || !enableRotation,\n      snapAngle: 15,\n      onRotateStart: () => {\n        onRotateStart?.();\n      },\n      onRotate: (angle) => {\n        onRotate?.(angle);\n      },\n      onRotateEnd: (angle) => {\n        updateElement(element.id, { rotation: angle });\n        onRotateEnd?.(angle);\n      },\n    });\n\n    // Current rotation (accounting for live rotation)\n    const displayRotation = useMemo(() => {\n      if (isRotating && rotateState.currentAngle !== null) {\n        return rotateState.currentAngle;\n      }\n      return element.rotation ?? 0;\n    }, [isRotating, rotateState.currentAngle, element.rotation]);\n\n    // Calculate display bounds (accounting for drag and resize)\n    const displayBounds = useMemo(() => {\n      if (isResizing && resizeState.currentBounds) {\n        return resizeState.currentBounds;\n      }\n      if (isDragging) {\n        return {\n          x: element.x + dragState.delta.x,\n          y: element.y + dragState.delta.y,\n          width: element.width,\n          height: element.height,\n        };\n      }\n      return {\n        x: element.x,\n        y: element.y,\n        width: element.width,\n        height: element.height,\n      };\n    }, [isResizing, resizeState.currentBounds, isDragging, dragState.delta, element.x, element.y, element.width, element.height]);\n\n    // Calculate scale for resize preview\n    const resizeScale = useMemo(() => {\n      if (!isResizing || !resizeState.currentBounds) return { x: 1, y: 1 };\n      return {\n        x: resizeState.currentBounds.width / element.width,\n        y: resizeState.currentBounds.height / element.height,\n      };\n    }, [isResizing, resizeState.currentBounds, element.width, element.height]);\n\n    // Resize handles - use display bounds for correct positioning during resize\n    const handles = useMemo(() => {\n      if (!isSelected || !showHandles || isReadonly) return [];\n      return getResizeHandles(\n        { x: 0, y: 0, width: displayBounds.width, height: displayBounds.height },\n        HANDLE_SIZE\n      );\n    }, [isSelected, showHandles, isReadonly, displayBounds.width, displayBounds.height]);\n\n    // Handle resize start\n    const handleResizeStart = useCallback(\n      (handle: ResizeHandle, e: React.MouseEvent) => {\n        startResize(\n          handle,\n          { x: element.x, y: element.y, width: element.width, height: element.height },\n          e\n        );\n      },\n      [startResize, element]\n    );\n\n    // Handle rotation start\n    const handleRotateStart = useCallback(\n      (e: React.MouseEvent) => {\n        // Center point for rotation (in canvas coordinates)\n        const centerX = displayBounds.x + displayBounds.width / 2;\n        const centerY = displayBounds.y + displayBounds.height / 2;\n        startRotate(\n          { x: centerX, y: centerY },\n          element.rotation ?? 0,\n          e\n        );\n      },\n      [startRotate, displayBounds, element.rotation]\n    );\n\n    // Combined mouse handlers\n    const handleMouseDown = useCallback(\n      (e: React.MouseEvent) => {\n        selectionHandlers.onClick(e);\n        if (isSelected) {\n          dragHandlers.onMouseDown(e);\n        }\n      },\n      [selectionHandlers, dragHandlers, isSelected]\n    );\n\n    // Styles\n    const groupStyle: React.CSSProperties = {\n      cursor: isDragging ? 'grabbing' : isSelected ? 'grab' : 'pointer',\n      opacity: element.visible === false ? 0.5 : 1,\n      ...style,\n    };\n\n    return React.createElement(\n      'g',\n      {\n        ref,\n        className: cx('canvas-element', className, {\n          'canvas-element--selected': isSelected,\n          'canvas-element--dragging': isDragging,\n          'canvas-element--resizing': isResizing,\n          'canvas-element--rotating': isRotating,\n          'canvas-element--locked': element.locked,\n        }),\n        transform: `translate(${displayBounds.x}, ${displayBounds.y})${\n          displayRotation ? ` rotate(${displayRotation}, ${displayBounds.width / 2}, ${displayBounds.height / 2})` : ''\n        }`,\n        style: groupStyle,\n        onMouseDown: handleMouseDown,\n        onTouchStart: dragHandlers.onTouchStart,\n        'data-element-id': element.id,\n        'data-element-type': element.type,\n      },\n      // Element content - scale during resize for visual feedback\n      isResizing\n        ? React.createElement(\n            'g',\n            { transform: `scale(${resizeScale.x}, ${resizeScale.y})` },\n            children\n          )\n        : children,\n\n      // Selection outline - use display bounds for accurate sizing\n      isSelected &&\n        React.createElement('rect', {\n          className: 'canvas-element__selection',\n          x: -2,\n          y: -2,\n          width: displayBounds.width + 4,\n          height: displayBounds.height + 4,\n          fill: 'none',\n          stroke: theme.colors.selection.stroke,\n          strokeWidth: 1,\n          strokeDasharray: '4 2',\n          pointerEvents: 'none',\n        }),\n\n      // Resize handles\n      handles.map((handle) =>\n        React.createElement('rect', {\n          key: handle.position,\n          className: `canvas-element__handle canvas-element__handle--${handle.position}`,\n          x: handle.x,\n          y: handle.y,\n          width: HANDLE_SIZE,\n          height: HANDLE_SIZE,\n          fill: theme.colors.handle.fill,\n          stroke: theme.colors.handle.stroke,\n          strokeWidth: 1,\n          cursor: getCursorForHandle(handle.position),\n          onMouseDown: (e: React.MouseEvent) => handleResizeStart(handle.position, e),\n        })\n      ),\n\n      // Rotation handle (circular, above the element)\n      isSelected && showHandles && enableRotation && !isReadonly &&\n        React.createElement('g', {\n          key: 'rotation-handle',\n          className: 'canvas-element__rotation-handle',\n        },\n          // Line connecting to element\n          React.createElement('line', {\n            x1: displayBounds.width / 2,\n            y1: 0,\n            x2: displayBounds.width / 2,\n            y2: -ROTATION_HANDLE_OFFSET,\n            stroke: theme.colors.selection.stroke,\n            strokeWidth: 1,\n            pointerEvents: 'none',\n          }),\n          // Rotation handle circle\n          React.createElement('circle', {\n            cx: displayBounds.width / 2,\n            cy: -ROTATION_HANDLE_OFFSET,\n            r: HANDLE_SIZE / 2 + 2,\n            fill: theme.colors.handle.fill,\n            stroke: theme.colors.handle.stroke,\n            strokeWidth: 1,\n            cursor: 'grab',\n            onMouseDown: handleRotateStart,\n          })\n        )\n    );\n  }\n);\n\nElementBase.displayName = 'ElementBase';\n\n// Helper to get cursor for resize handle\nfunction getCursorForHandle(position: ResizeHandle): string {\n  const cursors: Record<ResizeHandle, string> = {\n    nw: 'nwse-resize',\n    n: 'ns-resize',\n    ne: 'nesw-resize',\n    e: 'ew-resize',\n    se: 'nwse-resize',\n    s: 'ns-resize',\n    sw: 'nesw-resize',\n    w: 'ew-resize',\n  };\n  return cursors[position];\n}\n\nexport default ElementBase;\n","// withElementBehavior HOC\n// Wraps SVG elements with canvas behavior (selection, drag, resize)\n\nimport React, { ComponentType, forwardRef } from 'react';\nimport type { CanvasElement } from '@/types/elements';\nimport { ElementBase } from './ElementBase';\n\n/**\n * Props that the wrapped component receives\n */\nexport interface ElementRenderProps {\n  element: CanvasElement;\n  isSelected: boolean;\n  isDragging: boolean;\n  isResizing: boolean;\n  isRotating: boolean;\n}\n\n/**\n * Props for the wrapped component with element behavior\n */\nexport interface WithElementBehaviorProps {\n  element: CanvasElement;\n  disabled?: boolean;\n  showHandles?: boolean;\n  enableRotation?: boolean;\n  onSelect?: (selected: boolean) => void;\n  onDragStart?: () => void;\n  onDrag?: (x: number, y: number) => void;\n  onDragEnd?: (x: number, y: number) => void;\n  onResizeStart?: () => void;\n  onResize?: (width: number, height: number, x: number, y: number) => void;\n  onResizeEnd?: (width: number, height: number, x: number, y: number) => void;\n  onRotateStart?: () => void;\n  onRotate?: (rotation: number) => void;\n  onRotateEnd?: (rotation: number) => void;\n  className?: string;\n  style?: React.CSSProperties;\n}\n\n/**\n * HOC that wraps a render function with element behavior\n * \n * @example\n * const MyElement = withElementBehavior(({ element }) => (\n *   <rect\n *     width={element.width}\n *     height={element.height}\n *     fill={element.style?.fill ?? '#fff'}\n *   />\n * ));\n */\nexport function withElementBehavior<P extends ElementRenderProps>(\n  RenderComponent: ComponentType<P>\n) {\n  type WrapperProps = WithElementBehaviorProps & Omit<P, keyof ElementRenderProps>;\n  \n  const WrappedComponent = forwardRef<SVGGElement, WrapperProps>((allProps, ref) => {\n    // Destructure with explicit casting to avoid TypeScript inference issues\n    const typedProps = allProps as WrapperProps;\n    const element = typedProps.element;\n    const disabled = typedProps.disabled;\n    const showHandles = typedProps.showHandles;\n    const enableRotation = typedProps.enableRotation;\n    const onSelect = typedProps.onSelect;\n    const onDragStart = typedProps.onDragStart;\n    const onDrag = typedProps.onDrag;\n    const onDragEnd = typedProps.onDragEnd;\n    const onResizeStart = typedProps.onResizeStart;\n    const onResize = typedProps.onResize;\n    const onResizeEnd = typedProps.onResizeEnd;\n    const onRotateStart = typedProps.onRotateStart;\n    const onRotate = typedProps.onRotate;\n    const onRotateEnd = typedProps.onRotateEnd;\n    const className = typedProps.className;\n    const style = typedProps.style;\n    \n    // Remove WithElementBehaviorProps keys to get remaining props for RenderComponent\n    const {\n      element: _e, disabled: _d, showHandles: _sh, enableRotation: _er, onSelect: _os,\n      onDragStart: _ods, onDrag: _od, onDragEnd: _ode,\n      onResizeStart: _ors, onResize: _or, onResizeEnd: _ore,\n      onRotateStart: _orts, onRotate: _ort, onRotateEnd: _orte,\n      className: _c, style: _s,\n      ...rest\n    } = typedProps;\n\n    // Track interaction states via ElementBase\n    const [interactionState, setInteractionState] = React.useState({\n      isSelected: false,\n      isDragging: false,\n      isResizing: false,\n      isRotating: false,\n    });\n\n    const handleSelect = React.useCallback((selected: boolean) => {\n      setInteractionState((prev) => ({ ...prev, isSelected: selected }));\n      onSelect?.(selected);\n    }, [onSelect]);\n\n    const handleDragStart = React.useCallback(() => {\n      setInteractionState((prev) => ({ ...prev, isDragging: true }));\n      onDragStart?.();\n    }, [onDragStart]);\n\n    const handleDragEnd = React.useCallback((x: number, y: number) => {\n      setInteractionState((prev) => ({ ...prev, isDragging: false }));\n      onDragEnd?.(x, y);\n    }, [onDragEnd]);\n\n    const handleResizeStart = React.useCallback(() => {\n      setInteractionState((prev) => ({ ...prev, isResizing: true }));\n      onResizeStart?.();\n    }, [onResizeStart]);\n\n    const handleResizeEnd = React.useCallback((w: number, h: number, x: number, y: number) => {\n      setInteractionState((prev) => ({ ...prev, isResizing: false }));\n      onResizeEnd?.(w, h, x, y);\n    }, [onResizeEnd]);\n\n    const handleRotateStart = React.useCallback(() => {\n      setInteractionState((prev) => ({ ...prev, isRotating: true }));\n      onRotateStart?.();\n    }, [onRotateStart]);\n\n    const handleRotateEnd = React.useCallback((rotation: number) => {\n      setInteractionState((prev) => ({ ...prev, isRotating: false }));\n      onRotateEnd?.(rotation);\n    }, [onRotateEnd]);\n\n    const renderProps = {\n      element,\n      ...interactionState,\n    };\n\n    return (\n      <ElementBase\n        ref={ref}\n        element={element}\n        disabled={disabled}\n        showHandles={showHandles}\n        enableRotation={enableRotation}\n        className={className}\n        style={style}\n        onSelect={handleSelect}\n        onDragStart={handleDragStart}\n        onDrag={onDrag}\n        onDragEnd={handleDragEnd}\n        onResizeStart={handleResizeStart}\n        onResize={onResize}\n        onResizeEnd={handleResizeEnd}\n        onRotateStart={handleRotateStart}\n        onRotate={onRotate}\n        onRotateEnd={handleRotateEnd}\n      >\n        <RenderComponent {...renderProps as P} {...rest} />\n      </ElementBase>\n    );\n  });\n\n  WrappedComponent.displayName = `withElementBehavior(${\n    RenderComponent.displayName || RenderComponent.name || 'Component'\n  })`;\n\n  return WrappedComponent;\n}\n\nexport default withElementBehavior;\n","// Rectangle element component\n\nimport React from 'react';\nimport { withElementBehavior, type ElementRenderProps } from '../withElementBehavior';\nimport { useTheme } from '@/core/context';\n\nexport interface RectangleProps extends ElementRenderProps {}\n\nconst RectangleRender: React.FC<RectangleProps> = ({ element }) => {\n  const { theme } = useTheme();\n  const { width, height, style } = element;\n\n  return React.createElement('rect', {\n    width,\n    height,\n    fill: style?.fill ?? theme.colors.element.fill,\n    stroke: style?.stroke ?? theme.colors.element.stroke,\n    strokeWidth: style?.strokeWidth ?? theme.strokeWidth.normal,\n    rx: style?.cornerRadius ?? 0,\n    ry: style?.cornerRadius ?? 0,\n    opacity: style?.opacity ?? 1,\n  });\n};\n\nexport const Rectangle = withElementBehavior(RectangleRender);\n\nRectangle.displayName = 'Rectangle';\n\nexport default Rectangle;\n","// Ellipse element component (also used for Circle and Oval)\n\nimport React from 'react';\nimport { withElementBehavior, type ElementRenderProps } from '../withElementBehavior';\nimport { useTheme } from '@/core/context';\n\nexport interface EllipseProps extends ElementRenderProps {}\n\nconst EllipseRender: React.FC<EllipseProps> = ({ element }) => {\n  const { theme } = useTheme();\n  const { width, height, style } = element;\n\n  const cx = width / 2;\n  const cy = height / 2;\n  const rx = width / 2;\n  const ry = height / 2;\n\n  return React.createElement('ellipse', {\n    cx,\n    cy,\n    rx,\n    ry,\n    fill: style?.fill ?? theme.colors.element.fill,\n    stroke: style?.stroke ?? theme.colors.element.stroke,\n    strokeWidth: style?.strokeWidth ?? theme.strokeWidth.normal,\n    opacity: style?.opacity ?? 1,\n  });\n};\n\nexport const Ellipse = withElementBehavior(EllipseRender);\n\nEllipse.displayName = 'Ellipse';\n\n/**\n * Circle is an Ellipse with equal width and height\n * Use at component level: <Ellipse element={{ ...element, width: size, height: size }} />\n */\nexport const Circle = Ellipse;\nCircle.displayName = 'Circle';\n\n/**\n * Oval is an alias for Ellipse\n */\nexport const Oval = Ellipse;\nOval.displayName = 'Oval';\n\nexport default Ellipse;\n","// Diamond element component\n\nimport React from 'react';\nimport { withElementBehavior, type ElementRenderProps } from '../withElementBehavior';\nimport { useTheme } from '@/core/context';\n\nexport interface DiamondProps extends ElementRenderProps {}\n\nconst DiamondRender: React.FC<DiamondProps> = ({ element }) => {\n  const { theme } = useTheme();\n  const { width, height, style } = element;\n\n  // Diamond points: top, right, bottom, left\n  const points = [\n    `${width / 2},0`,\n    `${width},${height / 2}`,\n    `${width / 2},${height}`,\n    `0,${height / 2}`,\n  ].join(' ');\n\n  return React.createElement('polygon', {\n    points,\n    fill: style?.fill ?? theme.colors.element.fill,\n    stroke: style?.stroke ?? theme.colors.element.stroke,\n    strokeWidth: style?.strokeWidth ?? theme.strokeWidth.normal,\n    opacity: style?.opacity ?? 1,\n  });\n};\n\nexport const Diamond = withElementBehavior(DiamondRender);\n\nDiamond.displayName = 'Diamond';\n\nexport default Diamond;\n","// Text element component with inline editing support\n\nimport React, { forwardRef, useState, useCallback, useRef, useEffect } from 'react';\nimport { ElementBase } from '../ElementBase';\nimport { useTheme, useCanvas } from '@/core/context';\nimport type { TextElement as TextElementType } from '@/types/elements';\n\nexport interface TextProps {\n  element: TextElementType;\n  disabled?: boolean;\n  showHandles?: boolean;\n  enableRotation?: boolean;\n  onSelect?: (selected: boolean) => void;\n  onDragStart?: () => void;\n  onDrag?: (x: number, y: number) => void;\n  onDragEnd?: (x: number, y: number) => void;\n  onResizeStart?: () => void;\n  onResize?: (width: number, height: number, x: number, y: number) => void;\n  onResizeEnd?: (width: number, height: number, x: number, y: number) => void;\n  onRotateStart?: () => void;\n  onRotate?: (rotation: number) => void;\n  onRotateEnd?: (rotation: number) => void;\n  onTextChange?: (text: string) => void;\n  className?: string;\n  style?: React.CSSProperties;\n}\n\nexport const TextElement = forwardRef<SVGGElement, TextProps>(\n  (\n    {\n      element,\n      disabled,\n      showHandles,\n      enableRotation,\n      onSelect,\n      onDragStart,\n      onDrag,\n      onDragEnd,\n      onResizeStart,\n      onResize,\n      onResizeEnd,\n      onRotateStart,\n      onRotate,\n      onRotateEnd,\n      onTextChange,\n      className,\n      style,\n    },\n    ref\n  ) => {\n    const { theme } = useTheme();\n    const { updateElement } = useCanvas();\n    const [isEditing, setIsEditing] = useState(false);\n    const [editText, setEditText] = useState(element.text ?? '');\n    const inputRef = useRef<HTMLTextAreaElement>(null);\n\n    const { width, height, style: elementStyle, text = '', fontSize, fontFamily, fontWeight, textAlign } = element;\n\n    // Measure text dimensions using SVG text element\n    const measureText = useCallback((textContent: string): { width: number; height: number } => {\n      // Create temporary SVG to measure text\n      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');\n      svg.style.position = 'absolute';\n      svg.style.visibility = 'hidden';\n      svg.style.pointerEvents = 'none';\n      document.body.appendChild(svg);\n\n      const textEl = document.createElementNS('http://www.w3.org/2000/svg', 'text');\n      textEl.setAttribute('font-size', String(fontSize ?? theme.fontSize.md));\n      textEl.setAttribute('font-family', fontFamily ?? 'sans-serif');\n      textEl.setAttribute('font-weight', fontWeight ?? 'normal');\n      \n      // Handle multi-line text\n      const lines = textContent.split('\\n');\n      const lineHeight = (fontSize ?? theme.fontSize.md) * 1.2;\n      \n      let maxWidth = 0;\n      lines.forEach((line, index) => {\n        const tspan = document.createElementNS('http://www.w3.org/2000/svg', 'tspan');\n        tspan.textContent = line || ' '; // Use space for empty lines\n        tspan.setAttribute('x', '0');\n        tspan.setAttribute('dy', index === 0 ? '0' : String(lineHeight));\n        textEl.appendChild(tspan);\n      });\n      \n      svg.appendChild(textEl);\n      \n      const bbox = textEl.getBBox();\n      maxWidth = bbox.width;\n      const totalHeight = lines.length * lineHeight;\n      \n      document.body.removeChild(svg);\n      \n      // Add padding\n      const padding = 16;\n      return {\n        width: Math.max(maxWidth + padding, 40), // Minimum width\n        height: Math.max(totalHeight + padding, 24), // Minimum height\n      };\n    }, [fontSize, fontFamily, fontWeight, theme.fontSize.md]);\n\n    // Calculate text anchor based on alignment\n    const getTextAnchor = useCallback((): 'start' | 'middle' | 'end' => {\n      switch (textAlign) {\n        case 'right':\n          return 'end';\n        case 'center':\n          return 'middle';\n        default:\n          return 'start';\n      }\n    }, [textAlign]);\n\n    // Calculate x position based on alignment\n    const getXPosition = useCallback((): number => {\n      switch (textAlign) {\n        case 'right':\n          return width;\n        case 'center':\n          return width / 2;\n        default:\n          return 0;\n      }\n    }, [textAlign, width]);\n\n    // Handle double click to start editing\n    const handleDoubleClick = useCallback((e: React.MouseEvent) => {\n      if (element.locked || disabled) return;\n      e.stopPropagation();\n      e.preventDefault();\n      setEditText(text);\n      setIsEditing(true);\n    }, [element.locked, disabled, text]);\n\n    // Save text and exit editing mode, auto-resize to fit text\n    const saveAndExit = useCallback(() => {\n      const trimmedText = editText.trim();\n      if (trimmedText !== text || trimmedText !== '') {\n        // Measure the new text dimensions\n        const newSize = measureText(trimmedText);\n        \n        // Update element with new text and dimensions\n        updateElement(element.id, { \n          text: trimmedText,\n          width: newSize.width,\n          height: newSize.height,\n        } as Partial<TextElementType>);\n        \n        onTextChange?.(trimmedText);\n      }\n      setIsEditing(false);\n    }, [editText, text, measureText, updateElement, element.id, onTextChange]);\n\n    // Cancel editing\n    const cancelEdit = useCallback(() => {\n      setEditText(text);\n      setIsEditing(false);\n    }, [text]);\n\n    // Handle key events in textarea\n    const handleKeyDown = useCallback((e: React.KeyboardEvent) => {\n      if (e.key === 'Escape') {\n        e.preventDefault();\n        cancelEdit();\n      } else if (e.key === 'Enter' && !e.shiftKey) {\n        e.preventDefault();\n        saveAndExit();\n      }\n      // Shift+Enter allows multi-line\n      e.stopPropagation();\n    }, [cancelEdit, saveAndExit]);\n\n    // Focus input when entering edit mode\n    useEffect(() => {\n      if (isEditing && inputRef.current) {\n        inputRef.current.focus();\n        inputRef.current.select();\n      }\n    }, [isEditing]);\n\n    // Render text content\n    const renderContent = () => {\n      if (isEditing) {\n        // Use foreignObject to embed HTML input for editing\n        return React.createElement(\n          'foreignObject',\n          {\n            x: 0,\n            y: 0,\n            width: width,\n            height: height,\n          },\n          React.createElement(\n            'div',\n            {\n              xmlns: 'http://www.w3.org/1999/xhtml',\n              style: {\n                width: '100%',\n                height: '100%',\n                display: 'flex',\n                alignItems: 'center',\n                justifyContent: textAlign === 'center' ? 'center' : textAlign === 'right' ? 'flex-end' : 'flex-start',\n              },\n            },\n            React.createElement('textarea', {\n              ref: inputRef,\n              value: editText,\n              onChange: (e: React.ChangeEvent<HTMLTextAreaElement>) => setEditText(e.target.value),\n              onBlur: saveAndExit,\n              onKeyDown: handleKeyDown,\n              style: {\n                width: '100%',\n                height: '100%',\n                padding: '4px',\n                border: `2px solid ${theme.colors.selection.stroke}`,\n                borderRadius: '2px',\n                outline: 'none',\n                resize: 'none',\n                backgroundColor: theme.colors.background,\n                color: elementStyle?.fill ?? theme.colors.text.primary,\n                fontSize: fontSize ?? theme.fontSize.md,\n                fontFamily: fontFamily ?? 'sans-serif',\n                fontWeight: fontWeight ?? 'normal',\n                textAlign: textAlign ?? 'left',\n                boxSizing: 'border-box',\n              },\n            })\n          )\n        );\n      }\n\n      // Normal text display\n      return React.createElement(\n        'g',\n        { onDoubleClick: handleDoubleClick },\n        // Background (for selection area)\n        React.createElement('rect', {\n          width,\n          height,\n          fill: 'transparent',\n        }),\n        // Text\n        React.createElement(\n          'text',\n          {\n            x: getXPosition(),\n            y: height / 2,\n            dominantBaseline: 'central',\n            textAnchor: getTextAnchor(),\n            fill: elementStyle?.fill ?? theme.colors.text.primary,\n            fontSize: fontSize ?? theme.fontSize.md,\n            fontFamily: fontFamily ?? 'sans-serif',\n            fontWeight: fontWeight ?? 'normal',\n            opacity: elementStyle?.opacity ?? 1,\n            style: { pointerEvents: 'none' },\n          },\n          text\n        )\n      );\n    };\n\n    return React.createElement(\n      ElementBase,\n      {\n        ref,\n        element,\n        children: renderContent(),\n        disabled: disabled || isEditing, // Disable drag/resize while editing\n        showHandles: showHandles && !isEditing,\n        enableRotation,\n        className,\n        style,\n        onSelect,\n        onDragStart,\n        onDrag,\n        onDragEnd,\n        onResizeStart,\n        onResize,\n        onResizeEnd,\n        onRotateStart,\n        onRotate,\n        onRotateEnd,\n      }\n    );\n  }\n);\n\nTextElement.displayName = 'TextElement';\n\nexport default TextElement;\n","// LineBase component\n// Specialized base wrapper for line elements with endpoint handles\n\nimport React, { forwardRef, useCallback, useMemo, useRef, useState } from 'react';\nimport type { LineElement, Point } from '@/types/elements';\nimport { useSelectable, useDraggable, useRotatable } from '@/core/hooks';\nimport { useCanvas, useTheme, useViewport } from '@/core/context';\nimport { cx } from '@/core/utils';\n\nexport interface LineBaseProps {\n  element: LineElement;\n  children?: React.ReactNode;\n  /** Callback to render with current points during endpoint drag */\n  renderLine: (points: Point[], isEndpointDragging: boolean) => React.ReactNode;\n  className?: string;\n  style?: React.CSSProperties;\n  disabled?: boolean;\n  showHandles?: boolean;\n  enableRotation?: boolean;\n  onSelect?: (selected: boolean) => void;\n  onDragStart?: () => void;\n  onDrag?: (x: number, y: number) => void;\n  onDragEnd?: (x: number, y: number) => void;\n  onPointsChange?: (points: Point[]) => void;\n  onRotateStart?: () => void;\n  onRotate?: (rotation: number) => void;\n  onRotateEnd?: (rotation: number) => void;\n}\n\nconst HANDLE_SIZE = 8;\nconst ROTATION_HANDLE_OFFSET = 25;\n\ninterface EndpointDragState {\n  isDragging: boolean;\n  endpointIndex: number | null;\n  startPosition: Point | null;\n  currentPoints: Point[] | null;\n}\n\nexport const LineBase = forwardRef<SVGGElement, LineBaseProps>(\n  (\n    {\n      element,\n      children,\n      renderLine,\n      className,\n      style,\n      disabled = false,\n      showHandles = true,\n      enableRotation = true,\n      onSelect,\n      onDragStart,\n      onDrag,\n      onDragEnd,\n      onPointsChange,\n      onRotateStart,\n      onRotate,\n      onRotateEnd,\n    },\n    ref\n  ) => {\n    const { updateElement } = useCanvas();\n    const { theme } = useTheme();\n    const { screenToCanvas } = useViewport();\n    const isReadonly = element.locked || disabled;\n\n    // Endpoint dragging state\n    const [endpointDrag, setEndpointDrag] = useState<EndpointDragState>({\n      isDragging: false,\n      endpointIndex: null,\n      startPosition: null,\n      currentPoints: null,\n    });\n\n    const endpointDragRef = useRef<{\n      endpointIndex: number;\n      startMousePos: Point;\n      originalPoints: Point[];\n    } | null>(null);\n\n    // Get current points\n    const basePoints = useMemo(() => {\n      return element.points ?? [\n        { x: 0, y: element.height / 2 },\n        { x: element.width, y: element.height / 2 },\n      ];\n    }, [element.points, element.width, element.height]);\n\n    // Selection\n    const { isSelected, handlers: selectionHandlers } = useSelectable({\n      id: element.id,\n      disabled: isReadonly,\n      onSelect,\n    });\n\n    // Dragging (whole line)\n    const { isDragging, dragState, handlers: dragHandlers } = useDraggable({\n      disabled: isReadonly || !isSelected || endpointDrag.isDragging,\n      onDragStart: () => {\n        onDragStart?.();\n      },\n      onDrag: (pos, delta) => {\n        const newX = element.x + delta.x;\n        const newY = element.y + delta.y;\n        onDrag?.(newX, newY);\n      },\n      onDragEnd: (pos, delta) => {\n        const newX = element.x + delta.x;\n        const newY = element.y + delta.y;\n        updateElement(element.id, { x: newX, y: newY });\n        onDragEnd?.(newX, newY);\n      },\n    });\n\n    // Rotation\n    const { isRotating, rotateState, startRotate } = useRotatable({\n      disabled: isReadonly || !isSelected || !enableRotation,\n      snapAngle: 15,\n      onRotateStart: () => {\n        onRotateStart?.();\n      },\n      onRotate: (angle) => {\n        onRotate?.(angle);\n      },\n      onRotateEnd: (angle) => {\n        updateElement(element.id, { rotation: angle });\n        onRotateEnd?.(angle);\n      },\n    });\n\n    // Current display values\n    const displayRotation = useMemo(() => {\n      if (isRotating && rotateState.currentAngle !== null) {\n        return rotateState.currentAngle;\n      }\n      return element.rotation ?? 0;\n    }, [isRotating, rotateState.currentAngle, element.rotation]);\n\n    const displayBounds = useMemo(() => {\n      if (isDragging) {\n        return {\n          x: element.x + dragState.delta.x,\n          y: element.y + dragState.delta.y,\n          width: element.width,\n          height: element.height,\n        };\n      }\n      return {\n        x: element.x,\n        y: element.y,\n        width: element.width,\n        height: element.height,\n      };\n    }, [isDragging, dragState.delta, element.x, element.y, element.width, element.height]);\n\n    // Current points to display (accounting for endpoint drag)\n    const displayPoints = useMemo(() => {\n      if (endpointDrag.isDragging && endpointDrag.currentPoints) {\n        return endpointDrag.currentPoints;\n      }\n      return basePoints;\n    }, [endpointDrag.isDragging, endpointDrag.currentPoints, basePoints]);\n\n    // Endpoint drag handlers\n    const handleEndpointMouseDown = useCallback(\n      (endpointIndex: number, e: React.MouseEvent) => {\n        if (isReadonly || !isSelected) return;\n        \n        e.stopPropagation();\n        e.preventDefault();\n\n        const startPos = screenToCanvas({ x: e.clientX, y: e.clientY });\n        \n        endpointDragRef.current = {\n          endpointIndex,\n          startMousePos: startPos,\n          originalPoints: [...basePoints],\n        };\n\n        setEndpointDrag({\n          isDragging: true,\n          endpointIndex,\n          startPosition: startPos,\n          currentPoints: [...basePoints],\n        });\n\n        // Add global listeners\n        const handleMouseMove = (moveEvent: MouseEvent) => {\n          if (!endpointDragRef.current) return;\n\n          const currentPos = screenToCanvas({ x: moveEvent.clientX, y: moveEvent.clientY });\n          const { endpointIndex: idx, startMousePos, originalPoints } = endpointDragRef.current;\n\n          const deltaX = currentPos.x - startMousePos.x;\n          const deltaY = currentPos.y - startMousePos.y;\n\n          // Create new points array with updated endpoint\n          const newPoints = originalPoints.map((p, i) => {\n            if (i === idx) {\n              return { x: p.x + deltaX, y: p.y + deltaY };\n            }\n            return { ...p };\n          });\n\n          setEndpointDrag(prev => ({\n            ...prev,\n            currentPoints: newPoints,\n          }));\n        };\n\n        const handleMouseUp = () => {\n          if (!endpointDragRef.current) return;\n\n          const currentState = endpointDragRef.current;\n          \n          // Get the final points from state\n          setEndpointDrag(prev => {\n            if (prev.currentPoints) {\n              // Calculate new bounding box from points\n              const points = prev.currentPoints;\n              const xs = points.map(p => p.x);\n              const ys = points.map(p => p.y);\n              const minX = Math.min(...xs);\n              const minY = Math.min(...ys);\n              const maxX = Math.max(...xs);\n              const maxY = Math.max(...ys);\n              \n              // Normalize points relative to new bounding box\n              const normalizedPoints = points.map(p => ({\n                x: p.x - minX,\n                y: p.y - minY,\n              }));\n\n              const newWidth = Math.max(maxX - minX, 1);\n              const newHeight = Math.max(maxY - minY, 1);\n\n              // Update element with new position, size, and normalized points\n              // Cast to any because updateElement expects Partial<CanvasElement> \n              // but points is specific to LineElement\n              updateElement(element.id, {\n                x: element.x + minX,\n                y: element.y + minY,\n                width: newWidth,\n                height: newHeight,\n                points: normalizedPoints,\n              } as Partial<LineElement>);\n\n              onPointsChange?.(normalizedPoints);\n            }\n\n            return {\n              isDragging: false,\n              endpointIndex: null,\n              startPosition: null,\n              currentPoints: null,\n            };\n          });\n\n          endpointDragRef.current = null;\n          document.removeEventListener('mousemove', handleMouseMove);\n          document.removeEventListener('mouseup', handleMouseUp);\n        };\n\n        document.addEventListener('mousemove', handleMouseMove);\n        document.addEventListener('mouseup', handleMouseUp);\n      },\n      [isReadonly, isSelected, basePoints, screenToCanvas, updateElement, element.id, element.x, element.y, onPointsChange]\n    );\n\n    // Handle rotation start - use line center (midpoint between endpoints)\n    const handleRotateStart = useCallback(\n      (e: React.MouseEvent) => {\n        // Calculate true center of the line\n        const p1 = displayPoints[0];\n        const p2 = displayPoints[displayPoints.length - 1];\n        const lineCenterX = (p1.x + p2.x) / 2;\n        const lineCenterY = (p1.y + p2.y) / 2;\n        \n        // Convert to canvas coordinates\n        const centerX = displayBounds.x + lineCenterX;\n        const centerY = displayBounds.y + lineCenterY;\n        \n        startRotate(\n          { x: centerX, y: centerY },\n          element.rotation ?? 0,\n          e\n        );\n      },\n      [startRotate, displayBounds, displayPoints, element.rotation]\n    );\n\n    // Combined mouse handlers\n    const handleMouseDown = useCallback(\n      (e: React.MouseEvent) => {\n        selectionHandlers.onClick(e);\n        if (isSelected && !endpointDrag.isDragging) {\n          dragHandlers.onMouseDown(e);\n        }\n      },\n      [selectionHandlers, dragHandlers, isSelected, endpointDrag.isDragging]\n    );\n\n    // Styles\n    const groupStyle: React.CSSProperties = {\n      cursor: isDragging ? 'grabbing' : isSelected ? 'grab' : 'pointer',\n      opacity: element.visible === false ? 0.5 : 1,\n      ...style,\n    };\n\n    // Calculate endpoint handle positions in local coordinates\n    const handlePositions = useMemo(() => {\n      return displayPoints.map(p => ({ x: p.x, y: p.y }));\n    }, [displayPoints]);\n\n    // Calculate rotation handle position (perpendicular to line direction)\n    const rotationHandlePos = useMemo(() => {\n      if (displayPoints.length < 2) return { cx: 0, cy: 0, x1: 0, y1: 0, x2: 0, y2: 0 };\n      \n      const p1 = displayPoints[0];\n      const p2 = displayPoints[displayPoints.length - 1];\n      \n      // Line center\n      const centerX = (p1.x + p2.x) / 2;\n      const centerY = (p1.y + p2.y) / 2;\n      \n      // Line direction vector\n      const dx = p2.x - p1.x;\n      const dy = p2.y - p1.y;\n      const length = Math.sqrt(dx * dx + dy * dy) || 1;\n      \n      // Perpendicular unit vector (rotate 90 degrees counterclockwise)\n      // This points \"above\" the line in standard orientation\n      const perpX = -dy / length;\n      const perpY = dx / length;\n      \n      // Handle position offset from center\n      const handleX = centerX + perpX * ROTATION_HANDLE_OFFSET;\n      const handleY = centerY + perpY * ROTATION_HANDLE_OFFSET;\n      \n      return {\n        cx: handleX,\n        cy: handleY,\n        x1: centerX,\n        y1: centerY,\n        x2: handleX,\n        y2: handleY,\n      };\n    }, [displayPoints]);\n\n    return React.createElement(\n      'g',\n      {\n        ref,\n        className: cx('canvas-element canvas-line', className, {\n          'canvas-element--selected': isSelected,\n          'canvas-element--dragging': isDragging,\n          'canvas-element--endpoint-dragging': endpointDrag.isDragging,\n          'canvas-element--rotating': isRotating,\n          'canvas-element--locked': element.locked,\n        }),\n        transform: `translate(${displayBounds.x}, ${displayBounds.y})${\n          displayRotation ? ` rotate(${displayRotation}, ${displayBounds.width / 2}, ${displayBounds.height / 2})` : ''\n        }`,\n        style: groupStyle,\n        onMouseDown: handleMouseDown,\n        onTouchStart: dragHandlers.onTouchStart,\n        'data-element-id': element.id,\n        'data-element-type': element.type,\n      },\n      // Render line with current points\n      renderLine(displayPoints, endpointDrag.isDragging),\n\n      // Endpoint handles (only when selected)\n      isSelected && showHandles && !isReadonly &&\n        handlePositions.map((pos, index) =>\n          React.createElement('circle', {\n            key: `endpoint-handle-${index}`,\n            className: 'canvas-line__endpoint-handle',\n            cx: pos.x,\n            cy: pos.y,\n            r: HANDLE_SIZE / 2 + 2,\n            fill: theme.colors.handle.fill,\n            stroke: theme.colors.handle.stroke,\n            strokeWidth: 1.5,\n            cursor: 'move',\n            onMouseDown: (e: React.MouseEvent) => handleEndpointMouseDown(index, e),\n          })\n        ),\n\n      // Rotation handle (perpendicular to line direction)\n      isSelected && showHandles && enableRotation && !isReadonly &&\n        React.createElement('g', {\n          key: 'rotation-handle',\n          className: 'canvas-line__rotation-handle',\n        },\n          // Line connecting to element center\n          React.createElement('line', {\n            x1: rotationHandlePos.x1,\n            y1: rotationHandlePos.y1,\n            x2: rotationHandlePos.x2,\n            y2: rotationHandlePos.y2,\n            stroke: theme.colors.selection.stroke,\n            strokeWidth: 1,\n            pointerEvents: 'none',\n          }),\n          // Rotation handle circle\n          React.createElement('circle', {\n            cx: rotationHandlePos.cx,\n            cy: rotationHandlePos.cy,\n            r: HANDLE_SIZE / 2 + 2,\n            fill: theme.colors.handle.fill,\n            stroke: theme.colors.handle.stroke,\n            strokeWidth: 1,\n            cursor: 'grab',\n            onMouseDown: handleRotateStart,\n          })\n        )\n    );\n  }\n);\n\nLineBase.displayName = 'LineBase';\n\nexport default LineBase;\n","// Line element component\n// Uses LineBase for specialized endpoint-based resizing instead of standard 8-handle resize\n\nimport React, { forwardRef, useCallback } from 'react';\nimport { LineBase } from '../LineBase';\nimport { useTheme } from '@/core/context';\nimport type { LineElement as LineElementType, Point } from '@/types/elements';\n\nexport interface LineProps {\n  element: LineElementType;\n  disabled?: boolean;\n  showHandles?: boolean;\n  enableRotation?: boolean;\n  onSelect?: (selected: boolean) => void;\n  onDragStart?: () => void;\n  onDrag?: (x: number, y: number) => void;\n  onDragEnd?: (x: number, y: number) => void;\n  onPointsChange?: (points: Point[]) => void;\n  onRotateStart?: () => void;\n  onRotate?: (rotation: number) => void;\n  onRotateEnd?: (rotation: number) => void;\n  className?: string;\n  style?: React.CSSProperties;\n}\n\nexport const Line = forwardRef<SVGGElement, LineProps>(\n  (\n    {\n      element,\n      disabled,\n      showHandles,\n      enableRotation,\n      onSelect,\n      onDragStart,\n      onDrag,\n      onDragEnd,\n      onPointsChange,\n      onRotateStart,\n      onRotate,\n      onRotateEnd,\n      className,\n      style,\n    },\n    ref\n  ) => {\n    const { theme } = useTheme();\n    const { style: elementStyle, lineType = 'solid' } = element;\n\n    // Get stroke dasharray based on line type\n    const getStrokeDasharray = useCallback((): string | undefined => {\n      switch (lineType) {\n        case 'dashed':\n          return '8 4';\n        case 'dotted':\n          return '2 2';\n        default:\n          return undefined;\n      }\n    }, [lineType]);\n\n    const strokeColor = elementStyle?.stroke ?? theme.colors.element.stroke;\n    const strokeWidth = elementStyle?.strokeWidth ?? theme.strokeWidth.normal;\n\n    // Render function for the line itself\n    const renderLine = useCallback((points: Point[], isEndpointDragging: boolean) => {\n      // Build path from points\n      const pathData = points\n        .map((point, index) => (index === 0 ? `M ${point.x} ${point.y}` : `L ${point.x} ${point.y}`))\n        .join(' ');\n\n      return React.createElement(\n        'g',\n        null,\n        // Invisible wider path for easier selection (follows the line shape)\n        React.createElement('path', {\n          d: pathData,\n          fill: 'none',\n          stroke: 'transparent',\n          strokeWidth: 20, // Wide hit area\n          strokeLinecap: 'round',\n        }),\n        // Visible line\n        React.createElement('path', {\n          d: pathData,\n          fill: 'none',\n          stroke: strokeColor,\n          strokeWidth: strokeWidth,\n          strokeDasharray: getStrokeDasharray(),\n          strokeLinecap: 'round',\n          strokeLinejoin: 'round',\n          opacity: elementStyle?.opacity ?? 1,\n        })\n      );\n    }, [strokeColor, strokeWidth, getStrokeDasharray, elementStyle?.opacity]);\n\n    return React.createElement(LineBase, {\n      ref,\n      element,\n      disabled,\n      showHandles,\n      enableRotation,\n      className,\n      style,\n      onSelect,\n      onDragStart,\n      onDrag,\n      onDragEnd,\n      onPointsChange,\n      onRotateStart,\n      onRotate,\n      onRotateEnd,\n      renderLine,\n    });\n  }\n);\n\nLine.displayName = 'Line';\n\nexport default Line;\n","// Actor element component (UML stick figure)\n\nimport React from 'react';\nimport { withElementBehavior, type ElementRenderProps } from '../withElementBehavior';\nimport { useTheme } from '@/core/context';\nimport type { ActorElement as ActorElementType } from '@/types/elements';\n\nexport interface ActorProps extends ElementRenderProps {\n  element: ActorElementType;\n}\n\nconst ActorRender: React.FC<ActorProps> = ({ element }) => {\n  const { theme } = useTheme();\n  const { width, height, style, label } = element;\n\n  // Actor proportions\n  const headRadius = Math.min(width, height) * 0.15;\n  const centerX = width / 2;\n  const bodyTop = headRadius * 2 + 4;\n  const bodyBottom = height * 0.6;\n  const armY = bodyTop + (bodyBottom - bodyTop) * 0.3;\n  const armSpan = width * 0.4;\n  const legSpan = width * 0.35;\n  const labelY = height - 4;\n\n  const strokeColor = style?.stroke ?? theme.colors.element.stroke;\n  const strokeWidth = style?.strokeWidth ?? theme.strokeWidth.normal;\n\n  return React.createElement(\n    'g',\n    null,\n    // Invisible background for selection\n    React.createElement('rect', {\n      width,\n      height,\n      fill: 'transparent',\n    }),\n\n    // Head (circle)\n    React.createElement('circle', {\n      cx: centerX,\n      cy: headRadius + 2,\n      r: headRadius,\n      fill: style?.fill ?? 'none',\n      stroke: strokeColor,\n      strokeWidth,\n    }),\n\n    // Body (vertical line)\n    React.createElement('line', {\n      x1: centerX,\n      y1: bodyTop,\n      x2: centerX,\n      y2: bodyBottom,\n      stroke: strokeColor,\n      strokeWidth,\n    }),\n\n    // Arms (horizontal line)\n    React.createElement('line', {\n      x1: centerX - armSpan,\n      y1: armY,\n      x2: centerX + armSpan,\n      y2: armY,\n      stroke: strokeColor,\n      strokeWidth,\n    }),\n\n    // Left leg\n    React.createElement('line', {\n      x1: centerX,\n      y1: bodyBottom,\n      x2: centerX - legSpan,\n      y2: height * 0.85,\n      stroke: strokeColor,\n      strokeWidth,\n    }),\n\n    // Right leg\n    React.createElement('line', {\n      x1: centerX,\n      y1: bodyBottom,\n      x2: centerX + legSpan,\n      y2: height * 0.85,\n      stroke: strokeColor,\n      strokeWidth,\n    }),\n\n    // Label\n    label &&\n      React.createElement(\n        'text',\n        {\n          x: centerX,\n          y: labelY,\n          textAnchor: 'middle',\n          dominantBaseline: 'text-bottom',\n          fill: style?.fill ?? theme.colors.text.primary,\n          fontSize: theme.fontSize.sm,\n          fontFamily: 'sans-serif',\n        },\n        label\n      )\n  );\n};\n\nexport const Actor = withElementBehavior(ActorRender);\n\nActor.displayName = 'Actor';\n\nexport default Actor;\n","// Lifeline element component (UML sequence diagram)\n\nimport React from 'react';\nimport { withElementBehavior, type ElementRenderProps } from '../withElementBehavior';\nimport { useTheme } from '@/core/context';\nimport type { LifelineElement as LifelineElementType } from '@/types/elements';\n\nexport interface LifelineProps extends ElementRenderProps {\n  element: LifelineElementType;\n}\n\nconst LifelineRender: React.FC<LifelineProps> = ({ element }) => {\n  const { theme } = useTheme();\n  const { width, height, style, label } = element;\n\n  const centerX = width / 2;\n  const headerHeight = 40;\n  const strokeColor = style?.stroke ?? theme.colors.element.stroke;\n  const strokeWidth = style?.strokeWidth ?? theme.strokeWidth.normal;\n\n  return React.createElement(\n    'g',\n    null,\n    // Header box\n    React.createElement('rect', {\n      x: 0,\n      y: 0,\n      width,\n      height: headerHeight,\n      fill: style?.fill ?? theme.colors.element.fill,\n      stroke: strokeColor,\n      strokeWidth,\n    }),\n\n    // Label in header\n    label &&\n      React.createElement(\n        'text',\n        {\n          x: centerX,\n          y: headerHeight / 2,\n          textAnchor: 'middle',\n          dominantBaseline: 'central',\n          fill: theme.colors.text.primary,\n          fontSize: theme.fontSize.sm,\n          fontFamily: 'sans-serif',\n        },\n        label\n      ),\n\n    // Dashed lifeline\n    React.createElement('line', {\n      x1: centerX,\n      y1: headerHeight,\n      x2: centerX,\n      y2: height,\n      stroke: strokeColor,\n      strokeWidth,\n      strokeDasharray: '8 4',\n    })\n  );\n};\n\nexport const Lifeline = withElementBehavior(LifelineRender);\n\nLifeline.displayName = 'Lifeline';\n\nexport default Lifeline;\n","// Message element component (UML sequence diagram arrow)\n\nimport React from 'react';\nimport { withElementBehavior, type ElementRenderProps } from '../withElementBehavior';\nimport { useTheme } from '@/core/context';\nimport type { MessageElement as MessageElementType, MessageType } from '@/types/elements';\n\nexport interface MessageProps extends ElementRenderProps {\n  element: MessageElementType;\n}\n\nconst MessageRender: React.FC<MessageProps> = ({ element }) => {\n  const { theme } = useTheme();\n  const { width, height, style, label, messageType = 'sync' } = element;\n\n  const strokeColor = style?.stroke ?? theme.colors.connection.line;\n  const strokeWidth = style?.strokeWidth ?? theme.strokeWidth.normal;\n  const arrowSize = 10;\n\n  // Line from left to right\n  const y = height / 2;\n\n  // Get stroke style based on message type\n  const getStrokeDasharray = (): string | undefined => {\n    switch (messageType) {\n      case 'return':\n        return '8 4';\n      case 'create':\n        return '4 2';\n      default:\n        return undefined;\n    }\n  };\n\n  // Get arrow marker\n  const renderArrow = () => {\n    if (messageType === 'async') {\n      // Open arrow\n      return React.createElement('polyline', {\n        points: `${width - arrowSize},${y - arrowSize / 2} ${width},${y} ${width - arrowSize},${y + arrowSize / 2}`,\n        fill: 'none',\n        stroke: strokeColor,\n        strokeWidth,\n      });\n    }\n\n    // Filled arrow for sync and others\n    return React.createElement('polygon', {\n      points: `${width},${y} ${width - arrowSize},${y - arrowSize / 2} ${width - arrowSize},${y + arrowSize / 2}`,\n      fill: strokeColor,\n      stroke: strokeColor,\n      strokeWidth: 1,\n    });\n  };\n\n  return React.createElement(\n    'g',\n    null,\n    // Invisible background for selection\n    React.createElement('rect', {\n      width,\n      height,\n      fill: 'transparent',\n    }),\n\n    // Main line\n    React.createElement('line', {\n      x1: 0,\n      y1: y,\n      x2: width - (messageType === 'async' ? 0 : arrowSize / 2),\n      y2: y,\n      stroke: strokeColor,\n      strokeWidth,\n      strokeDasharray: getStrokeDasharray(),\n    }),\n\n    // Arrow head\n    renderArrow(),\n\n    // Label above the line\n    label &&\n      React.createElement(\n        'text',\n        {\n          x: width / 2,\n          y: y - 8,\n          textAnchor: 'middle',\n          dominantBaseline: 'text-bottom',\n          fill: theme.colors.text.primary,\n          fontSize: theme.fontSize.sm,\n          fontFamily: 'sans-serif',\n        },\n        label\n      )\n  );\n};\n\nexport const Message = withElementBehavior(MessageRender);\n\nMessage.displayName = 'Message';\n\nexport default Message;\n","// ActivationBar element component (UML sequence diagram activation)\n\nimport React from 'react';\nimport { withElementBehavior, type ElementRenderProps } from '../withElementBehavior';\nimport { useTheme } from '@/core/context';\n\nexport interface ActivationBarProps extends ElementRenderProps {}\n\nconst ActivationBarRender: React.FC<ActivationBarProps> = ({ element }) => {\n  const { theme } = useTheme();\n  const { width, height, style } = element;\n\n  return React.createElement('rect', {\n    width: width || 12, // Default narrow width\n    height,\n    fill: style?.fill ?? theme.colors.element.fill,\n    stroke: style?.stroke ?? theme.colors.element.stroke,\n    strokeWidth: style?.strokeWidth ?? theme.strokeWidth.normal,\n  });\n};\n\nexport const ActivationBar = withElementBehavior(ActivationBarRender);\n\nActivationBar.displayName = 'ActivationBar';\n\nexport default ActivationBar;\n","// DrawingCanvas component\n// SVG container that renders all canvas elements\n\nimport React, { forwardRef, useCallback, useMemo } from 'react';\nimport type { CanvasElement, ElementType } from '@/types/elements';\nimport { useCanvas, useSelection, useViewport, useTheme } from '@/core/context';\nimport { cx, sortByZIndex } from '@/core/utils';\n\n// Element components map\nimport { Rectangle, Ellipse, Diamond, TextElement, Line } from '@/elements/shapes';\nimport { Actor, Lifeline, Message, ActivationBar } from '@/elements/uml';\n\nexport interface DrawingCanvasProps {\n  width?: number;\n  height?: number;\n  className?: string;\n  style?: React.CSSProperties;\n  showGrid?: boolean;\n  gridSize?: number;\n  onCanvasClick?: (e: React.MouseEvent) => void;\n  onCanvasDoubleClick?: (e: React.MouseEvent) => void;\n  children?: React.ReactNode;\n}\n\n// Map element types to components\nconst elementComponents: Record<ElementType, React.ComponentType<any>> = {\n  rectangle: Rectangle,\n  ellipse: Ellipse,\n  circle: Ellipse,\n  diamond: Diamond,\n  text: TextElement,\n  line: Line,\n  actor: Actor,\n  lifeline: Lifeline,\n  message: Message,\n  activationBar: ActivationBar,\n  // Default fallback for custom types\n  custom: Rectangle,\n};\n\nexport const DrawingCanvas = forwardRef<SVGSVGElement, DrawingCanvasProps>(\n  (\n    {\n      width: propWidth,\n      height: propHeight,\n      className,\n      style,\n      showGrid: propShowGrid,\n      gridSize: propGridSize,\n      onCanvasClick,\n      onCanvasDoubleClick,\n      children,\n    },\n    ref\n  ) => {\n    const { elements, config } = useCanvas();\n    const { clearSelection } = useSelection();\n    const { viewport } = useViewport();\n    const { theme } = useTheme();\n\n    const width = propWidth ?? config.width;\n    const height = propHeight ?? config.height;\n    const showGrid = propShowGrid ?? config.grid?.visible;\n    const gridSize = propGridSize ?? config.grid?.size ?? 20;\n\n    // Sort elements by z-index\n    const sortedElements = useMemo(() => sortByZIndex(elements), [elements]);\n\n    // Handle mousedown on canvas background (deselect)\n    const handleBackgroundMouseDown = useCallback(\n      (e: React.MouseEvent) => {\n        // Only deselect on direct click, not during drag operations\n        // stopPropagation from elements prevents this from firing on element clicks\n        clearSelection();\n        onCanvasClick?.(e);\n      },\n      [clearSelection, onCanvasClick]\n    );\n\n    // Render grid pattern\n    const renderGrid = () => {\n      if (!showGrid) return null;\n\n      const patternId = 'canvas-grid-pattern';\n\n      return React.createElement(\n        React.Fragment,\n        null,\n        React.createElement(\n          'defs',\n          null,\n          React.createElement(\n            'pattern',\n            {\n              id: patternId,\n              width: gridSize,\n              height: gridSize,\n              patternUnits: 'userSpaceOnUse',\n            },\n            React.createElement('path', {\n              d: `M ${gridSize} 0 L 0 0 0 ${gridSize}`,\n              fill: 'none',\n              stroke: theme.colors.grid.line,\n              strokeWidth: 0.5,\n            })\n          )\n        ),\n        React.createElement('rect', {\n          width: '100%',\n          height: '100%',\n          fill: `url(#${patternId})`,\n          pointerEvents: 'none', // Let clicks pass through to background\n        })\n      );\n    };\n\n    // Render background rect for capturing clicks on empty areas\n    const renderBackground = () => {\n      return React.createElement('rect', {\n        className: 'canvas-background',\n        width: '100%',\n        height: '100%',\n        fill: 'transparent',\n        onMouseDown: handleBackgroundMouseDown,\n      });\n    };\n\n    // Render a single element\n    const renderElement = (element: CanvasElement) => {\n      const Component = elementComponents[element.type] ?? elementComponents.custom;\n\n      return React.createElement(Component, {\n        key: element.id,\n        element,\n      });\n    };\n\n    return React.createElement(\n      'svg',\n      {\n        ref,\n        className: cx('canvas-drawing', className),\n        width,\n        height,\n        viewBox: `0 0 ${width} ${height}`,\n        style: {\n          backgroundColor: theme.colors.background,\n          cursor: 'default',\n          userSelect: 'none',\n          ...style,\n        },\n        onDoubleClick: onCanvasDoubleClick,\n      },\n      // Transform group for zoom and pan\n      React.createElement(\n        'g',\n        {\n          transform: `translate(${viewport.pan.x}, ${viewport.pan.y}) scale(${viewport.zoom})`,\n        },\n        // Background rect for capturing clicks on empty areas\n        renderBackground(),\n\n        // Grid (pointer-events: none, so clicks pass through)\n        renderGrid(),\n\n        // Elements\n        sortedElements.map(renderElement),\n\n        // Additional children (e.g., selection boxes, connection handles)\n        children\n      )\n    );\n  }\n);\n\nDrawingCanvas.displayName = 'DrawingCanvas';\n\nexport default DrawingCanvas;\n","// Canvas component\n// Main component that combines providers and drawing canvas\n\nimport React, { forwardRef, useImperativeHandle, useRef, useCallback } from 'react';\nimport type { CanvasElement, Connection, ElementType } from '@/types/elements';\nimport type { CanvasConfig, ViewportState } from '@/types/canvas';\nimport type { Theme } from '@/types/theme';\nimport { CombinedCanvasProvider, useCanvas, useSelection, useViewport } from '@/core/context';\nimport { useCanvasActions, useCanvasKeyboardShortcuts } from '@/core/hooks';\nimport { DrawingCanvas } from './DrawingCanvas';\nimport { cx, deserializeFromJSON, exportToImage } from '@/core/utils';\nimport type { ExportImageOptions, CanvasData } from '@/core/utils';\n\nexport interface CanvasProps {\n  // Data (controlled mode)\n  elements?: CanvasElement[];\n  connections?: Connection[];\n  selectedIds?: string[];\n\n  // Data (uncontrolled mode)\n  defaultElements?: CanvasElement[];\n  defaultConnections?: Connection[];\n\n  // Configuration\n  width?: number;\n  height?: number;\n  config?: Partial<CanvasConfig>;\n  theme?: 'light' | 'dark' | Theme;\n  readonly?: boolean;\n\n  // Viewport settings\n  initialViewport?: Partial<ViewportState>;\n\n  // History settings\n  maxHistorySize?: number;\n\n  // Features\n  showGrid?: boolean;\n  gridSize?: number;\n  enableKeyboardShortcuts?: boolean;\n\n  // Callbacks\n  onChange?: (elements: CanvasElement[], connections: Connection[]) => void;\n  onSelectionChange?: (selectedIds: string[]) => void;\n  onElementAdd?: (element: CanvasElement) => void;\n  onElementUpdate?: (id: string, updates: Partial<CanvasElement>) => void;\n  onElementRemove?: (id: string) => void;\n\n  // Styling\n  className?: string;\n  style?: React.CSSProperties;\n\n  // Children (for custom overlays)\n  children?: React.ReactNode;\n}\n\nexport interface CanvasRef {\n  // Element operations\n  addElement: (element: Omit<CanvasElement, 'id'> & { id?: string }) => string;\n  updateElement: (id: string, updates: Partial<CanvasElement>) => void;\n  removeElement: (id: string) => void;\n  getElement: (id: string) => CanvasElement | undefined;\n  getElementsByType: (type: ElementType) => CanvasElement[];\n\n  // Selection\n  select: (id: string) => void;\n  selectMultiple: (ids: string[]) => void;\n  clearSelection: () => void;\n  getSelectedIds: () => string[];\n\n  // Viewport\n  zoomIn: () => void;\n  zoomOut: () => void;\n  setZoom: (zoom: number) => void;\n  resetViewport: () => void;\n\n  // History\n  undo: () => void;\n  redo: () => void;\n  canUndo: boolean;\n  canRedo: boolean;\n\n  // Export\n  toJSON: () => { elements: CanvasElement[]; connections: Connection[] };\n  toSVG: () => string;\n  toImage: (options?: ExportImageOptions) => Promise<Blob>;\n\n  // Import\n  fromJSON: (json: string) => CanvasData;\n}\n\n// Inner component that uses the contexts\nconst CanvasInner = forwardRef<CanvasRef, CanvasProps>(\n  (\n    {\n      width,\n      height,\n      readonly = false,\n      showGrid,\n      gridSize,\n      enableKeyboardShortcuts = true,\n      className,\n      style,\n      children,\n    },\n    ref\n  ) => {\n    const svgRef = useRef<SVGSVGElement>(null);\n    const canvas = useCanvas();\n    const selection = useSelection();\n    const viewport = useViewport();\n    const actions = useCanvasActions();\n\n    // Keyboard shortcuts\n    useCanvasKeyboardShortcuts(\n      enableKeyboardShortcuts\n        ? {\n            undo: actions.undo,\n            redo: actions.redo,\n            delete: actions.removeSelected,\n            selectAll: () => selection.selectAll(canvas.elements.map((el) => el.id)),\n            copy: actions.copy,\n            paste: actions.paste,\n            cut: actions.cut,\n            escape: selection.clearSelection,\n            zoomIn: viewport.zoomIn,\n            zoomOut: viewport.zoomOut,\n            resetZoom: viewport.resetViewport,\n          }\n        : {}\n    );\n\n    // Expose ref API\n    useImperativeHandle(\n      ref,\n      () => ({\n        addElement: actions.addElement,\n        updateElement: actions.updateElement,\n        removeElement: actions.removeElement,\n        getElement: canvas.getElementById,\n        getElementsByType: canvas.getElementsByType,\n        select: selection.select,\n        selectMultiple: selection.selectMultiple,\n        clearSelection: selection.clearSelection,\n        getSelectedIds: () => selection.selectedIds,\n        zoomIn: viewport.zoomIn,\n        zoomOut: viewport.zoomOut,\n        setZoom: viewport.setZoom,\n        resetViewport: viewport.resetViewport,\n        undo: actions.undo,\n        redo: actions.redo,\n        canUndo: actions.canUndo,\n        canRedo: actions.canRedo,\n        toJSON: () => ({\n          elements: canvas.elements,\n          connections: canvas.connections,\n        }),\n        toSVG: () => svgRef.current?.outerHTML ?? '',\n        toImage: async (options?: ExportImageOptions) => {\n          if (!svgRef.current) {\n            throw new Error('SVG element not available');\n          }\n          return exportToImage(svgRef.current, options);\n        },\n        fromJSON: (json: string) => {\n          const data = deserializeFromJSON(json);\n          canvas.setElements(data.elements);\n          canvas.setConnections(data.connections);\n          selection.clearSelection();\n          return data;\n        },\n      }),\n      [canvas, selection, viewport, actions]\n    );\n\n    return (\n      <div\n        className={cx('canvas-container', className, {\n          'canvas-container--readonly': readonly,\n        })}\n        style={{\n          position: 'relative',\n          overflow: 'hidden',\n          ...style,\n        }}\n        tabIndex={0}\n      >\n        <DrawingCanvas\n          ref={svgRef}\n          width={width}\n          height={height}\n          showGrid={showGrid}\n          gridSize={gridSize}\n        />\n        {children}\n      </div>\n    );\n  }\n);\n\nCanvasInner.displayName = 'CanvasInner';\n\n// Main Canvas component with providers\nexport const Canvas = forwardRef<CanvasRef, CanvasProps>(\n  (\n    {\n      elements,\n      connections,\n      selectedIds,\n      defaultElements = [],\n      defaultConnections = [],\n      config,\n      theme = 'light',\n      initialViewport,\n      maxHistorySize,\n      onChange,\n      onSelectionChange,\n      ...innerProps\n    },\n    ref\n  ) => {\n    return (\n      <CombinedCanvasProvider\n        initialElements={defaultElements}\n        initialConnections={defaultConnections}\n        elements={elements}\n        connections={connections}\n        selectedIds={selectedIds}\n        config={config}\n        theme={theme}\n        initialViewport={initialViewport}\n        maxHistorySize={maxHistorySize}\n        onElementsChange={onChange}\n        onSelectionChange={onSelectionChange}\n      >\n        <CanvasInner {...innerProps} ref={ref} />\n      </CombinedCanvasProvider>\n    );\n  }\n);\n\nCanvas.displayName = 'Canvas';\n\nexport default Canvas;\n","// ElementFactory\n// Pure factory function for creating canvas elements\n\nimport type {\n\tCanvasElement,\n\tElementType,\n\tElementStyle,\n\tPoint,\n\tTextElement,\n\tLineElement,\n\tActorElement,\n\tLifelineElement,\n\tMessageElement,\n} from \"@/types/elements\";\nimport { generateId } from \"@/core/utils\";\n\nexport interface CreateElementOptions {\n\tid?: string;\n\tx?: number;\n\ty?: number;\n\twidth?: number;\n\theight?: number;\n\tstyle?: ElementStyle;\n\tzIndex?: number;\n\tlocked?: boolean;\n\tvisible?: boolean;\n\tdata?: Record<string, unknown>;\n}\n\nexport interface CreateTextElementOptions extends CreateElementOptions {\n\ttext?: string;\n\tfontSize?: number;\n\tfontFamily?: string;\n\tfontWeight?: \"normal\" | \"bold\";\n\ttextAlign?: \"left\" | \"center\" | \"right\";\n}\n\nexport interface CreateLineElementOptions extends CreateElementOptions {\n\tpoints?: Point[];\n\tlineType?: \"solid\" | \"dashed\" | \"dotted\";\n}\n\nexport interface CreateActorElementOptions extends CreateElementOptions {\n\tlabel?: string;\n}\n\nexport interface CreateLifelineElementOptions extends CreateElementOptions {\n\tlabel?: string;\n}\n\nexport interface CreateMessageElementOptions extends CreateElementOptions {\n\tlabel?: string;\n\tmessageType?: \"sync\" | \"async\" | \"return\" | \"create\";\n\tfromId?: string;\n\ttoId?: string;\n}\n\n// Default dimensions by element type\nconst defaultDimensions: Record<\n\tElementType,\n\t{ width: number; height: number }\n> = {\n\trectangle: { width: 120, height: 80 },\n\tellipse: { width: 120, height: 80 },\n\tcircle: { width: 80, height: 80 },\n\tdiamond: { width: 100, height: 100 },\n\ttext: { width: 100, height: 30 },\n\tline: { width: 100, height: 2 },\n\tactor: { width: 60, height: 100 },\n\tlifeline: { width: 100, height: 300 },\n\tmessage: { width: 150, height: 30 },\n\tactivationBar: { width: 12, height: 60 },\n\tcustom: { width: 100, height: 100 },\n};\n\n/**\n * Create a base element with common properties\n */\nconst createBaseElement = (\n\ttype: ElementType,\n\toptions: CreateElementOptions = {},\n): CanvasElement => {\n\tconst defaults = defaultDimensions[type] ?? defaultDimensions.custom;\n\n\treturn {\n\t\tid: options.id ?? generateId(),\n\t\ttype,\n\t\tx: options.x ?? 0,\n\t\ty: options.y ?? 0,\n\t\twidth: options.width ?? defaults.width,\n\t\theight: options.height ?? defaults.height,\n\t\tzIndex: options.zIndex ?? 0,\n\t\tstyle: options.style,\n\t\tlocked: options.locked ?? false,\n\t\tvisible: options.visible ?? true,\n\t\tdata: options.data,\n\t};\n};\n\n/**\n * Create a rectangle element\n */\nexport const createRectangle = (\n\toptions: CreateElementOptions = {},\n): CanvasElement => {\n\treturn createBaseElement(\"rectangle\", options);\n};\n\n/**\n * Create an ellipse element\n */\nexport const createEllipse = (\n\toptions: CreateElementOptions = {},\n): CanvasElement => {\n\treturn createBaseElement(\"ellipse\", options);\n};\n\n/**\n * Create a circle element (ellipse with equal dimensions)\n */\nexport const createCircle = (\n\toptions: CreateElementOptions = {},\n): CanvasElement => {\n\tconst size = options.width ?? options.height ?? 80;\n\treturn createBaseElement(\"circle\", { ...options, width: size, height: size });\n};\n\n/**\n * Create a diamond element\n */\nexport const createDiamond = (\n\toptions: CreateElementOptions = {},\n): CanvasElement => {\n\treturn createBaseElement(\"diamond\", options);\n};\n\n/**\n * Create a text element\n */\nexport const createText = (\n\toptions: CreateTextElementOptions = {},\n): TextElement => {\n\tconst { text, fontSize, fontFamily, fontWeight, textAlign, ...baseOptions } =\n\t\toptions;\n\n\treturn {\n\t\t...createBaseElement(\"text\", baseOptions),\n\t\ttype: \"text\",\n\t\ttext: text ?? \"\",\n\t\tfontSize,\n\t\tfontFamily,\n\t\tfontWeight,\n\t\ttextAlign,\n\t};\n};\n\n/**\n * Create a line element\n * Points are automatically normalized to be relative to (0,0)\n * and element x,y is set to the bounding box origin\n */\nexport const createLine = (\n\toptions: CreateLineElementOptions = {},\n): LineElement => {\n\tconst { points: inputPoints, lineType, x, y, ...baseOptions } = options;\n\n\t// Default HORIZONTAL line if no points specified\n\tconst defaultWidth = baseOptions.width ?? 100;\n\tlet points = inputPoints ?? [\n\t\t{ x: x ?? 0, y: y ?? 0 },\n\t\t{ x: (x ?? 0) + defaultWidth, y: y ?? 0 },\n\t];\n\n\t// Calculate bounding box from points\n\tconst xs = points.map((p) => p.x);\n\tconst ys = points.map((p) => p.y);\n\tconst minX = Math.min(...xs);\n\tconst minY = Math.min(...ys);\n\tconst maxX = Math.max(...xs);\n\tconst maxY = Math.max(...ys);\n\n\t// Normalize points to be relative to (0,0)\n\tconst normalizedPoints = points.map((p) => ({\n\t\tx: p.x - minX,\n\t\ty: p.y - minY,\n\t}));\n\n\t// Calculate dimensions\n\t// For horizontal/vertical lines, ensure minimum size for selection\n\tconst rawWidth = maxX - minX;\n\tconst rawHeight = maxY - minY;\n\tconst width = Math.max(rawWidth, 10);\n\tconst height = Math.max(rawHeight, 10);\n\n\t// Adjust normalized points if we expanded the bounding box\n\tconst adjustedPoints = normalizedPoints.map((p) => ({\n\t\tx: rawWidth < 10 ? p.x + (10 - rawWidth) / 2 : p.x,\n\t\ty: rawHeight < 10 ? p.y + (10 - rawHeight) / 2 : p.y,\n\t}));\n\n\treturn {\n\t\t...createBaseElement(\"line\", {\n\t\t\t...baseOptions,\n\t\t\tx: rawWidth < 10 ? minX - (10 - rawWidth) / 2 : minX,\n\t\t\ty: rawHeight < 10 ? minY - (10 - rawHeight) / 2 : minY,\n\t\t\twidth,\n\t\t\theight,\n\t\t}),\n\t\ttype: \"line\",\n\t\tpoints: adjustedPoints,\n\t\tlineType: lineType ?? \"solid\",\n\t};\n};\n\n/**\n * Create an actor element (UML)\n */\nexport const createActor = (\n\toptions: CreateActorElementOptions = {},\n): ActorElement => {\n\tconst { label, ...baseOptions } = options;\n\n\treturn {\n\t\t...createBaseElement(\"actor\", baseOptions),\n\t\ttype: \"actor\",\n\t\tlabel,\n\t};\n};\n\n/**\n * Create a lifeline element (UML)\n */\nexport const createLifeline = (\n\toptions: CreateLifelineElementOptions = {},\n): LifelineElement => {\n\tconst { label, ...baseOptions } = options;\n\n\treturn {\n\t\t...createBaseElement(\"lifeline\", baseOptions),\n\t\ttype: \"lifeline\",\n\t\tlabel,\n\t};\n};\n\n/**\n * Create a message element (UML)\n */\nexport const createMessage = (\n\toptions: CreateMessageElementOptions = {},\n): MessageElement => {\n\tconst { label, messageType, fromId, toId, ...baseOptions } = options;\n\n\treturn {\n\t\t...createBaseElement(\"message\", baseOptions),\n\t\ttype: \"message\",\n\t\tlabel,\n\t\tmessageType: messageType ?? \"sync\",\n\t\tfromId,\n\t\ttoId,\n\t};\n};\n\n/**\n * Create an activation bar element (UML)\n */\nexport const createActivationBar = (\n\toptions: CreateElementOptions = {},\n): CanvasElement => {\n\treturn createBaseElement(\"activationBar\", options);\n};\n\n/**\n * Factory function to create any element by type\n */\nexport const createElement = (\n\ttype: ElementType,\n\toptions: CreateElementOptions & Record<string, unknown> = {},\n): CanvasElement => {\n\tswitch (type) {\n\t\tcase \"rectangle\":\n\t\t\treturn createRectangle(options);\n\t\tcase \"ellipse\":\n\t\t\treturn createEllipse(options);\n\t\tcase \"circle\":\n\t\t\treturn createCircle(options);\n\t\tcase \"diamond\":\n\t\t\treturn createDiamond(options);\n\t\tcase \"text\":\n\t\t\treturn createText(options as CreateTextElementOptions);\n\t\tcase \"line\":\n\t\t\treturn createLine(options as CreateLineElementOptions);\n\t\tcase \"actor\":\n\t\t\treturn createActor(options as CreateActorElementOptions);\n\t\tcase \"lifeline\":\n\t\t\treturn createLifeline(options as CreateLifelineElementOptions);\n\t\tcase \"message\":\n\t\t\treturn createMessage(options as CreateMessageElementOptions);\n\t\tcase \"activationBar\":\n\t\t\treturn createActivationBar(options);\n\t\tdefault:\n\t\t\treturn createBaseElement(type, options);\n\t}\n};\n\n// Export factory as default\nexport const ElementFactory = {\n\tcreate: createElement,\n\trectangle: createRectangle,\n\tellipse: createEllipse,\n\tcircle: createCircle,\n\tdiamond: createDiamond,\n\ttext: createText,\n\tline: createLine,\n\tactor: createActor,\n\tlifeline: createLifeline,\n\tmessage: createMessage,\n\tactivationBar: createActivationBar,\n};\n\nexport default ElementFactory;\n"],"names":["generateId","cx","args","classes","arg","inner","key","value","deepMerge","target","source","output","sourceVal","targetVal","distance","p1","p2","dx","dy","isPointInBounds","point","bounds","boundsIntersect","a","b","snapToGrid","gridSize","getResizeHandles","handleSize","x","y","width","height","halfHandle","sortByZIndex","elements","getMaxZIndex","el","getMinZIndex","bringToFront","elementId","maxZ","sendToBack","minZ","bringForward","sorted","index","current","above","sendBackward","below","validateCanvasData","data","errors","obj","element","elementErrors","validateElement","connection","connectionErrors","validateConnection","prefix","conn","CURRENT_VERSION","serializeToJSON","connections","metadata","deserializeFromJSON","json","validation","exportToSVG","svgElement","options","clone","styles","getComputedStyles","svg","tags","downloadAsFile","content","filename","mimeType","blob","url","link","exportToImage","format","quality","backgroundColor","scale","svgRect","styleEl","svgString","svgBlob","svgUrl","resolve","reject","img","canvas","ctx","bgColor","downloadAsImage","lightTheme","darkTheme","ThemeContext","createContext","useTheme","context","useContext","ThemeProvider","children","theme","useMemo","React","getThemeCSSVariables","defaultViewport","viewportReducer","state","action","zoom","padding","pan","ViewportContext","useViewport","ViewportProvider","initialViewport","viewport","dispatch","useReducer","setZoom","useCallback","zoomIn","zoomOut","zoomToFit","setPan","panBy","delta","resetViewport","setConstraints","constraints","screenToCanvas","canvasToScreen","defaultSelection","selectionReducer","newSet","SelectionContext","useSelection","SelectionProvider","initialSelection","onSelectionChange","selectedIdsArray","isSelected","id","select","selectMultiple","ids","addToSelection","removeFromSelection","toggleSelection","clearSelection","selectAll","historyReducer","newPast","previous","next","newFuture","HistoryContext","useHistory","HistoryProvider","initialElements","initialConnections","maxHistorySize","onStateChange","pushState","undo","redo","clearHistory","setPresent","setMaxHistorySize","size","defaultConfig","canvasReducer","idsToRemove","CanvasContext","useCanvas","CanvasProvider","initialConfig","onChange","getElementById","getElementsByType","type","addElement","maxZIndex","addElements","newElements","i","updateElement","updates","updateElements","removeElement","removeElements","moveElement","moveElements","deltaX","deltaY","resizeElement","bringToFrontAction","sendToBackAction","moveUpAction","moveDownAction","setElements","getConnectionById","getConnectionsForElement","addConnection","updateConnection","removeConnection","setConnections","updateConfig","config","clearCanvas","loadState","CombinedCanvasProvider","onElementsChange","selectedIds","effectiveElements","effectiveConnections","jsx","CanvasStateProvider","useDraggable","onDragStart","onDrag","onDragEnd","disabled","threshold","dragState","setDragState","useState","startRef","useRef","hasPassedThreshold","getEventPosition","e","touch","handleMove","currentPos","handleEnd","endPos","handleStart","clientX","clientY","startPos","onMouseDown","onTouchStart","useResizable","onResizeStart","onResize","onResizeEnd","minWidth","minHeight","maxWidth","maxHeight","maintainAspectRatio","aspectRatio","resizeState","setResizeState","calculateNewBounds","handle","newX","newY","newWidth","newHeight","targetRatio","newBounds","prev","finalBounds","startResize","useRotatable","onRotateStart","onRotate","onRotateEnd","snapAngle","rotateState","setRotateState","getAngle","center","snapToAngle","angle","startMouseAngle","initialRotation","deltaAngle","newAngle","finalAngle","startRotate","useSelectable","onSelect","checkSelected","selectElement","deselect","toggle","willBeSelected","onClick","matchesShortcut","shortcut","keyMatches","shiftMatches","altMatches","modifierMatches","useKeyboard","shortcuts","enabled","targetRef","shortcutsRef","handleKeyDown","useEffect","useCanvasKeyboardShortcuts","actions","useCanvasActions","selection","history","clipboardRef","saveState","removeSelected","moveSelected","duplicateSelected","duplicates","newIds","copy","selectedElements","relevantConnections","cut","paste","idMap","newFromId","newToId","HANDLE_SIZE","ElementBase","forwardRef","className","style","showHandles","enableRotation","ref","isReadonly","selectionHandlers","isDragging","dragHandlers","pos","isResizing","isRotating","displayRotation","displayBounds","resizeScale","handles","handleResizeStart","handleRotateStart","centerX","centerY","handleMouseDown","groupStyle","getCursorForHandle","position","withElementBehavior","RenderComponent","WrappedComponent","allProps","typedProps","_e","_d","_sh","_er","_os","_ods","_od","_ode","_ors","_or","_ore","_orts","_ort","_orte","_c","_s","rest","interactionState","setInteractionState","handleSelect","selected","handleDragStart","handleDragEnd","handleResizeEnd","w","h","handleRotateEnd","rotation","renderProps","RectangleRender","Rectangle","EllipseRender","cy","rx","ry","Ellipse","Circle","Oval","DiamondRender","points","Diamond","TextElement","onTextChange","isEditing","setIsEditing","editText","setEditText","inputRef","elementStyle","text","fontSize","fontFamily","fontWeight","textAlign","measureText","textContent","textEl","lines","lineHeight","line","tspan","totalHeight","getTextAnchor","getXPosition","handleDoubleClick","saveAndExit","trimmedText","newSize","cancelEdit","renderContent","ROTATION_HANDLE_OFFSET","LineBase","renderLine","onPointsChange","endpointDrag","setEndpointDrag","endpointDragRef","basePoints","displayPoints","handleEndpointMouseDown","endpointIndex","handleMouseMove","moveEvent","idx","startMousePos","originalPoints","newPoints","p","handleMouseUp","xs","ys","minX","minY","maxX","maxY","normalizedPoints","lineCenterX","lineCenterY","handlePositions","rotationHandlePos","length","perpX","perpY","handleX","handleY","Line","lineType","getStrokeDasharray","strokeColor","strokeWidth","isEndpointDragging","pathData","ActorRender","label","headRadius","bodyTop","bodyBottom","armY","armSpan","legSpan","labelY","Actor","LifelineRender","headerHeight","Lifeline","MessageRender","messageType","arrowSize","renderArrow","Message","ActivationBarRender","ActivationBar","elementComponents","DrawingCanvas","propWidth","propHeight","propShowGrid","propGridSize","onCanvasClick","onCanvasDoubleClick","showGrid","sortedElements","handleBackgroundMouseDown","renderGrid","patternId","renderBackground","renderElement","Component","CanvasInner","readonly","enableKeyboardShortcuts","svgRef","useImperativeHandle","jsxs","Canvas","defaultElements","defaultConnections","innerProps","defaultDimensions","createBaseElement","defaults","createRectangle","createEllipse","createCircle","createDiamond","createText","baseOptions","createLine","inputPoints","defaultWidth","rawWidth","rawHeight","adjustedPoints","createActor","createLifeline","createMessage","fromId","toId","createActivationBar","createElement","ElementFactory"],"mappings":"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"}