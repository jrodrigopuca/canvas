"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const s=require("react"),K=require("react/jsx-runtime"),ue=()=>typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,11)}`,le=(...e)=>{const t=[];for(const n of e)if(n){if(typeof n=="string"||typeof n=="number")t.push(String(n));else if(Array.isArray(n)){const r=le(...n);r&&t.push(r)}else if(typeof n=="object")for(const[r,o]of Object.entries(n))o&&t.push(r)}return t.join(" ")};function Ee(e,t){const n={...e};for(const r in t)if(Object.prototype.hasOwnProperty.call(t,r)){const o=t[r],a=e[r];o!==null&&typeof o=="object"&&!Array.isArray(o)&&a!==null&&typeof a=="object"&&!Array.isArray(a)?n[r]=Ee(a,o):o!==void 0&&(n[r]=o)}return n}const kt=(e,t)=>{const n=t.x-e.x,r=t.y-e.y;return Math.sqrt(n*n+r*r)},wt=(e,t)=>e.x>=t.x&&e.x<=t.x+t.width&&e.y>=t.y&&e.y<=t.y+t.height,St=(e,t)=>!(e.x+e.width<t.x||t.x+t.width<e.x||e.y+e.height<t.y||t.y+t.height<e.y),bt=(e,t)=>Math.round(e/t)*t,Fe=(e,t)=>{const{x:n,y:r,width:o,height:a}=e,c=t/2;return[{position:"nw",x:n-c,y:r-c},{position:"n",x:n+o/2-c,y:r-c},{position:"ne",x:n+o-c,y:r-c},{position:"e",x:n+o-c,y:r+a/2-c},{position:"se",x:n+o-c,y:r+a-c},{position:"s",x:n+o/2-c,y:r+a-c},{position:"sw",x:n-c,y:r+a-c},{position:"w",x:n-c,y:r+a/2-c}]},pe=e=>[...e].sort((t,n)=>t.zIndex-n.zIndex),Ct=e=>e.length===0?0:Math.max(...e.map(t=>t.zIndex)),Rt=e=>e.length===0?0:Math.min(...e.map(t=>t.zIndex)),Ye=(e,t)=>{const n=Ct(e);return e.map(r=>r.id===t?{...r,zIndex:n+1}:r)},je=(e,t)=>{const n=Rt(e);return e.map(r=>r.id===t?{...r,zIndex:n-1}:r)},Tt=(e,t)=>{const n=pe(e),r=n.findIndex(c=>c.id===t);if(r===-1||r===n.length-1)return e;const o=n[r],a=n[r+1];return e.map(c=>c.id===o.id?{...c,zIndex:a.zIndex+1}:c)},It=(e,t)=>{const n=pe(e),r=n.findIndex(c=>c.id===t);if(r<=0)return e;const o=n[r],a=n[r-1];return e.map(c=>c.id===o.id?{...c,zIndex:a.zIndex-1}:c)},Ke=e=>{const t=[];if(!e||typeof e!="object")return{valid:!1,errors:["Data must be an object"]};const n=e;return typeof n.version!="string"&&t.push("Missing or invalid version field"),Array.isArray(n.elements)?n.elements.forEach((r,o)=>{const a=Mt(r,o);t.push(...a)}):t.push("Elements must be an array"),Array.isArray(n.connections)?n.connections.forEach((r,o)=>{const a=zt(r,o);t.push(...a)}):t.push("Connections must be an array"),{valid:t.length===0,errors:t}},Mt=(e,t)=>{const n=[],r=`Element[${t}]`;if(!e||typeof e!="object")return[`${r}: Must be an object`];const o=e;return(typeof o.id!="string"||o.id.length===0)&&n.push(`${r}: Missing or invalid id`),(typeof o.type!="string"||o.type.length===0)&&n.push(`${r}: Missing or invalid type`),(typeof o.x!="number"||isNaN(o.x))&&n.push(`${r}: Missing or invalid x coordinate`),(typeof o.y!="number"||isNaN(o.y))&&n.push(`${r}: Missing or invalid y coordinate`),(typeof o.width!="number"||isNaN(o.width)||o.width<0)&&n.push(`${r}: Missing or invalid width`),(typeof o.height!="number"||isNaN(o.height)||o.height<0)&&n.push(`${r}: Missing or invalid height`),(typeof o.zIndex!="number"||isNaN(o.zIndex))&&n.push(`${r}: Missing or invalid zIndex`),n},zt=(e,t)=>{const n=[],r=`Connection[${t}]`;if(!e||typeof e!="object")return[`${r}: Must be an object`];const o=e;return(typeof o.id!="string"||o.id.length===0)&&n.push(`${r}: Missing or invalid id`),(typeof o.fromId!="string"||o.fromId.length===0)&&n.push(`${r}: Missing or invalid fromId`),(typeof o.toId!="string"||o.toId.length===0)&&n.push(`${r}: Missing or invalid toId`),n},Nt="1.0.0",Dt=(e,t,n)=>JSON.stringify({version:Nt,elements:e,connections:t,metadata:n},null,2),At=e=>{const t=JSON.parse(e),n=Ke(t);if(!n.valid)throw new Error(`Invalid canvas data: ${n.errors.join(", ")}`);return t},Ot=(e,t)=>{const n=e.cloneNode(!0);if(n.getAttribute("xmlns")||n.setAttribute("xmlns","http://www.w3.org/2000/svg"),t?.includeStyles){const o=document.createElement("style");o.textContent=_t(e),n.insertBefore(o,n.firstChild)}return new XMLSerializer().serializeToString(n)},_t=e=>{const t=new Set;return e.querySelectorAll("*").forEach(n=>t.add(n.tagName.toLowerCase())),`
    svg { font-family: system-ui, sans-serif; }
    text { user-select: none; }
  `},Lt=(e,t,n)=>{const r=new Blob([e],{type:n}),o=URL.createObjectURL(r),a=document.createElement("a");a.href=o,a.download=t,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(o)},oe={name:"light",colors:{background:"#ffffff",surface:"#f8f9fa",border:"#dee2e6",text:{primary:"#212529",secondary:"#6c757d",disabled:"#adb5bd"},selection:{fill:"rgba(59, 130, 246, 0.1)",stroke:"#3b82f6"},element:{fill:"#ffffff",stroke:"#212529",hover:"#f1f5f9",active:"#e2e8f0"},handle:{fill:"#ffffff",stroke:"#3b82f6"},grid:{line:"#e5e7eb",dot:"#d1d5db"},connection:{line:"#64748b",arrow:"#64748b"}},spacing:{xs:4,sm:8,md:16,lg:24,xl:32},borderRadius:{sm:2,md:4,lg:8},fontSize:{xs:10,sm:12,md:14,lg:16,xl:20},strokeWidth:{thin:1,normal:2,thick:3},shadows:{sm:"0 1px 2px rgba(0,0,0,0.05)",md:"0 4px 6px rgba(0,0,0,0.1)",lg:"0 10px 15px rgba(0,0,0,0.1)",element:"0 2px 4px rgba(0,0,0,0.1)",handle:"0 1px 2px rgba(0,0,0,0.1)"}},Ge={name:"dark",colors:{background:"#1e1e1e",surface:"#252526",border:"#3c3c3c",text:{primary:"#ffffff",secondary:"#a0a0a0",disabled:"#5a5a5a"},selection:{fill:"rgba(59, 130, 246, 0.2)",stroke:"#60a5fa"},element:{fill:"#2d2d2d",stroke:"#ffffff",hover:"#383838",active:"#454545"},handle:{fill:"#2d2d2d",stroke:"#60a5fa"},grid:{line:"#333333",dot:"#444444"},connection:{line:"#94a3b8",arrow:"#94a3b8"}},spacing:oe.spacing,borderRadius:oe.borderRadius,fontSize:oe.fontSize,strokeWidth:oe.strokeWidth,shadows:{sm:"0 1px 2px rgba(0,0,0,0.3)",md:"0 4px 6px rgba(0,0,0,0.4)",lg:"0 10px 15px rgba(0,0,0,0.5)",element:"0 2px 4px rgba(0,0,0,0.3)",handle:"0 1px 2px rgba(0,0,0,0.3)"}},Je=s.createContext({theme:oe,themeName:"light"}),X=()=>{const e=s.useContext(Je);if(!e)throw new Error("useTheme must be used within a ThemeProvider");return e},qe=({children:e,theme:t="light"})=>{const n=s.useMemo(()=>t==="light"?{theme:oe,themeName:"light"}:t==="dark"?{theme:Ge,themeName:"dark"}:{theme:Ee(oe,t),themeName:"custom"},[t]);return s.createElement(Je.Provider,{value:n},e)},Pt=e=>({"--canvas-bg":e.colors.background,"--canvas-surface":e.colors.surface,"--canvas-border":e.colors.border,"--canvas-text-primary":e.colors.text.primary,"--canvas-text-secondary":e.colors.text.secondary,"--canvas-text-disabled":e.colors.text.disabled,"--canvas-selection-fill":e.colors.selection.fill,"--canvas-selection-stroke":e.colors.selection.stroke,"--canvas-element-fill":e.colors.element.fill,"--canvas-element-stroke":e.colors.element.stroke,"--canvas-element-hover":e.colors.element.hover,"--canvas-element-active":e.colors.element.active,"--canvas-handle-fill":e.colors.handle.fill,"--canvas-handle-stroke":e.colors.handle.stroke,"--canvas-grid-line":e.colors.grid.line,"--canvas-grid-dot":e.colors.grid.dot,"--canvas-connection-line":e.colors.connection.line,"--canvas-connection-arrow":e.colors.connection.arrow,"--canvas-spacing-xs":`${e.spacing.xs}px`,"--canvas-spacing-sm":`${e.spacing.sm}px`,"--canvas-spacing-md":`${e.spacing.md}px`,"--canvas-spacing-lg":`${e.spacing.lg}px`,"--canvas-spacing-xl":`${e.spacing.xl}px`,"--canvas-radius-sm":`${e.borderRadius.sm}px`,"--canvas-radius-md":`${e.borderRadius.md}px`,"--canvas-radius-lg":`${e.borderRadius.lg}px`,"--canvas-font-xs":`${e.fontSize.xs}px`,"--canvas-font-sm":`${e.fontSize.sm}px`,"--canvas-font-md":`${e.fontSize.md}px`,"--canvas-font-lg":`${e.fontSize.lg}px`,"--canvas-font-xl":`${e.fontSize.xl}px`,"--canvas-stroke-thin":`${e.strokeWidth.thin}px`,"--canvas-stroke-normal":`${e.strokeWidth.normal}px`,"--canvas-stroke-thick":`${e.strokeWidth.thick}px`,"--canvas-shadow-sm":e.shadows.sm,"--canvas-shadow-md":e.shadows.md,"--canvas-shadow-lg":e.shadows.lg,"--canvas-shadow-element":e.shadows.element,"--canvas-shadow-handle":e.shadows.handle}),Qe={zoom:1,pan:{x:0,y:0},minZoom:.1,maxZoom:5},$t=(e,t)=>{switch(t.type){case"SET_ZOOM":{const n=Math.max(e.minZoom,Math.min(e.maxZoom,t.payload));return{...e,zoom:n}}case"ZOOM_IN":{const n=Math.min(e.maxZoom,e.zoom*1.2);return{...e,zoom:n}}case"ZOOM_OUT":{const n=Math.max(e.minZoom,e.zoom/1.2);return{...e,zoom:n}}case"ZOOM_TO_FIT":{const{bounds:n,padding:r=50}=t.payload,o=Math.max(e.minZoom,Math.min(e.maxZoom,1)),a={x:-(n.x-r),y:-(n.y-r)};return{...e,zoom:o,pan:a}}case"SET_PAN":return{...e,pan:t.payload};case"PAN_BY":return{...e,pan:{x:e.pan.x+t.payload.x,y:e.pan.y+t.payload.y}};case"RESET":return{...Qe,minZoom:e.minZoom,maxZoom:e.maxZoom};case"SET_CONSTRAINTS":return{...e,minZoom:t.payload.minZoom??e.minZoom,maxZoom:t.payload.maxZoom??e.maxZoom};default:return e}},et=s.createContext(null),re=()=>{const e=s.useContext(et);if(!e)throw new Error("useViewport must be used within a ViewportProvider");return e},tt=({children:e,initialViewport:t})=>{const[n,r]=s.useReducer($t,{...Qe,...t}),o=s.useCallback(l=>{r({type:"SET_ZOOM",payload:l})},[]),a=s.useCallback(()=>{r({type:"ZOOM_IN"})},[]),c=s.useCallback(()=>{r({type:"ZOOM_OUT"})},[]),i=s.useCallback((l,S)=>{r({type:"ZOOM_TO_FIT",payload:{bounds:l,padding:S}})},[]),u=s.useCallback(l=>{r({type:"SET_PAN",payload:l})},[]),g=s.useCallback(l=>{r({type:"PAN_BY",payload:l})},[]),h=s.useCallback(()=>{r({type:"RESET"})},[]),E=s.useCallback(l=>{r({type:"SET_CONSTRAINTS",payload:l})},[]),v=s.useCallback(l=>({x:(l.x-n.pan.x)/n.zoom,y:(l.y-n.pan.y)/n.zoom}),[n.zoom,n.pan]),f=s.useCallback(l=>({x:l.x*n.zoom+n.pan.x,y:l.y*n.zoom+n.pan.y}),[n.zoom,n.pan]),x=s.useMemo(()=>({viewport:n,setZoom:o,zoomIn:a,zoomOut:c,zoomToFit:i,setPan:u,panBy:g,resetViewport:h,setConstraints:E,screenToCanvas:v,canvasToScreen:f}),[n,o,a,c,i,u,g,h,E,v,f]);return s.createElement(et.Provider,{value:x},e)},Bt={selectedIds:new Set,lastSelectedId:null},Wt=(e,t)=>{switch(t.type){case"SELECT":return{selectedIds:new Set([t.payload]),lastSelectedId:t.payload};case"SELECT_MULTIPLE":return{selectedIds:new Set(t.payload),lastSelectedId:t.payload.length>0?t.payload[t.payload.length-1]:null};case"ADD_TO_SELECTION":{const n=new Set(e.selectedIds);return n.add(t.payload),{selectedIds:n,lastSelectedId:t.payload}}case"REMOVE_FROM_SELECTION":{const n=new Set(e.selectedIds);return n.delete(t.payload),{selectedIds:n,lastSelectedId:n.size>0?Array.from(n).pop():null}}case"TOGGLE_SELECTION":{const n=new Set(e.selectedIds);return n.has(t.payload)?(n.delete(t.payload),{selectedIds:n,lastSelectedId:n.size>0?Array.from(n).pop():null}):(n.add(t.payload),{selectedIds:n,lastSelectedId:t.payload})}case"CLEAR_SELECTION":return Bt;case"SELECT_ALL":return{selectedIds:new Set(t.payload),lastSelectedId:t.payload.length>0?t.payload[t.payload.length-1]:null};default:return e}},nt=s.createContext(null),he=()=>{const e=s.useContext(nt);if(!e)throw new Error("useSelection must be used within a SelectionProvider");return e},st=({children:e,initialSelection:t,onSelectionChange:n})=>{const[r,o]=s.useReducer(Wt,{selectedIds:new Set(t??[]),lastSelectedId:t?.[t.length-1]??null}),a=s.useMemo(()=>Array.from(r.selectedIds),[r.selectedIds]);s.useEffect(()=>{n?.(a)},[a,n]);const c=s.useCallback(l=>r.selectedIds.has(l),[r.selectedIds]),i=s.useCallback(l=>{o({type:"SELECT",payload:l})},[]),u=s.useCallback(l=>{o({type:"SELECT_MULTIPLE",payload:l})},[]),g=s.useCallback(l=>{o({type:"ADD_TO_SELECTION",payload:l})},[]),h=s.useCallback(l=>{o({type:"REMOVE_FROM_SELECTION",payload:l})},[]),E=s.useCallback(l=>{o({type:"TOGGLE_SELECTION",payload:l})},[]),v=s.useCallback(()=>{o({type:"CLEAR_SELECTION"})},[]),f=s.useCallback(l=>{o({type:"SELECT_ALL",payload:l})},[]),x=s.useMemo(()=>({selectedIds:a,lastSelectedId:r.lastSelectedId,selectionCount:r.selectedIds.size,hasSelection:r.selectedIds.size>0,isSelected:c,select:i,selectMultiple:u,addToSelection:g,removeFromSelection:h,toggleSelection:E,clearSelection:v,selectAll:f}),[a,r.lastSelectedId,r.selectedIds.size,c,i,u,g,h,E,v,f]);return s.createElement(nt.Provider,{value:x},e)},Zt=(e,t)=>{switch(t.type){case"PUSH":{const n=[...e.past,e.present];return n.length>e.maxHistorySize&&n.shift(),{...e,past:n,present:t.payload,future:[]}}case"UNDO":{if(e.past.length===0)return e;const n=e.past[e.past.length-1],r=e.past.slice(0,-1);return{...e,past:r,present:n,future:[e.present,...e.future]}}case"REDO":{if(e.future.length===0)return e;const n=e.future[0],r=e.future.slice(1);return{...e,past:[...e.past,e.present],present:n,future:r}}case"CLEAR":return{...e,past:[],present:e.present,future:[]};case"SET_PRESENT":return{...e,present:t.payload};case"SET_MAX_SIZE":return{...e,maxHistorySize:t.payload};default:return e}},ot=s.createContext(null),rt=()=>{const e=s.useContext(ot);if(!e)throw new Error("useHistory must be used within a HistoryProvider");return e},at=({children:e,initialElements:t=[],initialConnections:n=[],maxHistorySize:r=50,onStateChange:o})=>{const[a,c]=s.useReducer(Zt,{past:[],present:{elements:t,connections:n,timestamp:Date.now()},future:[],maxHistorySize:r});s.useEffect(()=>{o?.(a.present.elements,a.present.connections)},[a.present,o]);const i=s.useCallback((x,l)=>{c({type:"PUSH",payload:{elements:x,connections:l,timestamp:Date.now()}})},[]),u=s.useCallback(()=>{c({type:"UNDO"})},[]),g=s.useCallback(()=>{c({type:"REDO"})},[]),h=s.useCallback(()=>{c({type:"CLEAR"})},[]),E=s.useCallback((x,l)=>{c({type:"SET_PRESENT",payload:{elements:x,connections:l,timestamp:Date.now()}})},[]),v=s.useCallback(x=>{c({type:"SET_MAX_SIZE",payload:x})},[]),f=s.useMemo(()=>({canUndo:a.past.length>0,canRedo:a.future.length>0,historySize:a.past.length,futureSize:a.future.length,present:a.present,pushState:i,undo:u,redo:g,clearHistory:h,setPresent:E,setMaxHistorySize:v}),[a.past.length,a.future.length,a.present,i,u,g,h,E,v]);return s.createElement(ot.Provider,{value:f},e)},Ut={width:800,height:600,grid:{enabled:!1,size:20,snap:!1,visible:!1},readonly:!1},Vt=(e,t)=>{switch(t.type){case"ADD_ELEMENT":return{...e,elements:[...e.elements,t.payload]};case"ADD_ELEMENTS":return{...e,elements:[...e.elements,...t.payload]};case"UPDATE_ELEMENT":return{...e,elements:e.elements.map(n=>n.id===t.payload.id?{...n,...t.payload.updates}:n)};case"UPDATE_ELEMENTS":return{...e,elements:e.elements.map(n=>t.payload.ids.includes(n.id)?{...n,...t.payload.updates}:n)};case"REMOVE_ELEMENT":{const n=t.payload;return{...e,elements:e.elements.filter(r=>r.id!==n),connections:e.connections.filter(r=>r.fromId!==n&&r.toId!==n)}}case"REMOVE_ELEMENTS":{const n=new Set(t.payload);return{...e,elements:e.elements.filter(r=>!n.has(r.id)),connections:e.connections.filter(r=>!n.has(r.fromId)&&!n.has(r.toId))}}case"MOVE_ELEMENT":return{...e,elements:e.elements.map(n=>n.id===t.payload.id?{...n,x:t.payload.x,y:t.payload.y}:n)};case"MOVE_ELEMENTS":return{...e,elements:e.elements.map(n=>t.payload.ids.includes(n.id)?{...n,x:n.x+t.payload.deltaX,y:n.y+t.payload.deltaY}:n)};case"RESIZE_ELEMENT":return{...e,elements:e.elements.map(n=>n.id===t.payload.id?{...n,width:t.payload.width,height:t.payload.height,...t.payload.x!==void 0&&{x:t.payload.x},...t.payload.y!==void 0&&{y:t.payload.y}}:n)};case"BRING_TO_FRONT":return{...e,elements:Ye(e.elements,t.payload)};case"SEND_TO_BACK":return{...e,elements:je(e.elements,t.payload)};case"MOVE_UP":return{...e,elements:Tt(e.elements,t.payload)};case"MOVE_DOWN":return{...e,elements:It(e.elements,t.payload)};case"SET_ELEMENTS":return{...e,elements:t.payload};case"ADD_CONNECTION":return{...e,connections:[...e.connections,t.payload]};case"UPDATE_CONNECTION":return{...e,connections:e.connections.map(n=>n.id===t.payload.id?{...n,...t.payload.updates}:n)};case"REMOVE_CONNECTION":return{...e,connections:e.connections.filter(n=>n.id!==t.payload)};case"SET_CONNECTIONS":return{...e,connections:t.payload};case"UPDATE_CONFIG":return{...e,config:{...e.config,...t.payload}};case"CLEAR_CANVAS":return{...e,elements:[],connections:[]};case"LOAD_STATE":return{...e,elements:t.payload.elements,connections:t.payload.connections};default:return e}},ct=s.createContext(null),ie=()=>{const e=s.useContext(ct);if(!e)throw new Error("useCanvas must be used within a CanvasProvider");return e},lt=({children:e,initialElements:t=[],initialConnections:n=[],config:r,onChange:o})=>{const[a,c]=s.useReducer(Vt,{elements:t,connections:n,config:{...Ut,...r}});s.useEffect(()=>{o?.(a.elements,a.connections)},[a.elements,a.connections,o]);const i=s.useCallback(m=>a.elements.find(R=>R.id===m),[a.elements]),u=s.useCallback(m=>a.elements.filter(R=>R.type===m),[a.elements]),g=s.useCallback(m=>{const R=m.id??ue(),A=a.elements.length>0?Math.max(...a.elements.map(W=>W.zIndex)):0;return c({type:"ADD_ELEMENT",payload:{...m,id:R,zIndex:m.zIndex??A+1}}),R},[a.elements]),h=s.useCallback(m=>{const R=a.elements.length>0?Math.max(...a.elements.map(W=>W.zIndex)):0,A=m.map((W,ee)=>({...W,id:W.id??ue(),zIndex:W.zIndex??R+1+ee}));return c({type:"ADD_ELEMENTS",payload:A}),A.map(W=>W.id)},[a.elements]),E=s.useCallback((m,R)=>{c({type:"UPDATE_ELEMENT",payload:{id:m,updates:R}})},[]),v=s.useCallback((m,R)=>{c({type:"UPDATE_ELEMENTS",payload:{ids:m,updates:R}})},[]),f=s.useCallback(m=>{c({type:"REMOVE_ELEMENT",payload:m})},[]),x=s.useCallback(m=>{c({type:"REMOVE_ELEMENTS",payload:m})},[]),l=s.useCallback((m,R,A)=>{c({type:"MOVE_ELEMENT",payload:{id:m,x:R,y:A}})},[]),S=s.useCallback((m,R,A)=>{c({type:"MOVE_ELEMENTS",payload:{ids:m,deltaX:R,deltaY:A}})},[]),w=s.useCallback((m,R,A,W,ee)=>{c({type:"RESIZE_ELEMENT",payload:{id:m,width:R,height:A,x:W,y:ee}})},[]),d=s.useCallback(m=>{c({type:"BRING_TO_FRONT",payload:m})},[]),b=s.useCallback(m=>{c({type:"SEND_TO_BACK",payload:m})},[]),y=s.useCallback(m=>{c({type:"MOVE_UP",payload:m})},[]),p=s.useCallback(m=>{c({type:"MOVE_DOWN",payload:m})},[]),k=s.useCallback(m=>{c({type:"SET_ELEMENTS",payload:m})},[]),C=s.useCallback(m=>a.connections.find(R=>R.id===m),[a.connections]),z=s.useCallback(m=>a.connections.filter(R=>R.fromId===m||R.toId===m),[a.connections]),I=s.useCallback(m=>{const R=m.id??ue();return c({type:"ADD_CONNECTION",payload:{...m,id:R}}),R},[]),P=s.useCallback((m,R)=>{c({type:"UPDATE_CONNECTION",payload:{id:m,updates:R}})},[]),L=s.useCallback(m=>{c({type:"REMOVE_CONNECTION",payload:m})},[]),_=s.useCallback(m=>{c({type:"SET_CONNECTIONS",payload:m})},[]),D=s.useCallback(m=>{c({type:"UPDATE_CONFIG",payload:m})},[]),Z=s.useCallback(()=>{c({type:"CLEAR_CANVAS"})},[]),F=s.useCallback((m,R)=>{c({type:"LOAD_STATE",payload:{elements:m,connections:R}})},[]),ne=s.useMemo(()=>({elements:a.elements,connections:a.connections,config:a.config,getElementById:i,getElementsByType:u,addElement:g,addElements:h,updateElement:E,updateElements:v,removeElement:f,removeElements:x,moveElement:l,moveElements:S,resizeElement:w,bringToFront:d,sendToBack:b,moveUp:y,moveDown:p,setElements:k,getConnectionById:C,getConnectionsForElement:z,addConnection:I,updateConnection:P,removeConnection:L,setConnections:_,updateConfig:D,clearCanvas:Z,loadState:F}),[a.elements,a.connections,a.config,i,u,g,h,E,v,f,x,l,S,w,d,b,y,p,k,C,z,I,P,L,_,D,Z,F]);return s.createElement(ct.Provider,{value:ne},e)},it=({children:e,initialElements:t=[],initialConnections:n=[],config:r,theme:o="light",initialViewport:a,maxHistorySize:c=50,onElementsChange:i,onSelectionChange:u,elements:g,connections:h,selectedIds:E})=>{const v=g??t,f=h??n;return K.jsx(qe,{theme:o,children:K.jsx(tt,{initialViewport:a,children:K.jsx(st,{initialSelection:E,onSelectionChange:u,children:K.jsx(at,{initialElements:v,initialConnections:f,maxHistorySize:c,children:K.jsx(lt,{initialElements:v,initialConnections:f,config:r,onChange:i,children:e})})})})})},ve=(e={})=>{const{onDragStart:t,onDrag:n,onDragEnd:r,disabled:o=!1,threshold:a=3}=e,[c,i]=s.useState({isDragging:!1,startPosition:null,currentPosition:null,delta:{x:0,y:0}}),u=s.useRef(null),g=s.useRef(!1),{screenToCanvas:h}=re(),E=s.useCallback(w=>{if("touches"in w){const d=w.touches[0]||w.changedTouches[0];return h({x:d.clientX,y:d.clientY})}return h({x:w.clientX,y:w.clientY})},[h]),v=s.useCallback(w=>{if(!u.current)return;const d=E(w),b={x:d.x-u.current.x,y:d.y-u.current.y};if(!g.current){if(Math.sqrt(b.x**2+b.y**2)<a)return;g.current=!0,t?.(u.current)}i({isDragging:!0,startPosition:u.current,currentPosition:d,delta:b}),n?.(d,b)},[E,a,t,n]),f=s.useCallback(w=>{if(!u.current)return;const d=E(w),b={x:d.x-u.current.x,y:d.y-u.current.y};g.current&&r?.(d,b),i({isDragging:!1,startPosition:null,currentPosition:null,delta:{x:0,y:0}}),u.current=null,g.current=!1,document.removeEventListener("mousemove",v),document.removeEventListener("mouseup",f),document.removeEventListener("touchmove",v),document.removeEventListener("touchend",f)},[E,v,r]),x=s.useCallback((w,d)=>{if(o)return;const b=h({x:w,y:d});u.current=b,g.current=!1,i({isDragging:!1,startPosition:b,currentPosition:b,delta:{x:0,y:0}}),document.addEventListener("mousemove",v),document.addEventListener("mouseup",f),document.addEventListener("touchmove",v,{passive:!1}),document.addEventListener("touchend",f)},[o,h,v,f]),l=s.useCallback(w=>{w.button===0&&(w.preventDefault(),w.stopPropagation(),x(w.clientX,w.clientY))},[x]),S=s.useCallback(w=>{if(w.touches.length!==1)return;const d=w.touches[0];x(d.clientX,d.clientY)},[x]);return{dragState:c,handlers:{onMouseDown:l,onTouchStart:S},isDragging:c.isDragging}},dt=(e={})=>{const{onResizeStart:t,onResize:n,onResizeEnd:r,disabled:o=!1,minWidth:a=20,minHeight:c=20,maxWidth:i=1/0,maxHeight:u=1/0,maintainAspectRatio:g=!1,aspectRatio:h}=e,[E,v]=s.useState({isResizing:!1,handle:null,startBounds:null,currentBounds:null}),f=s.useRef(null),{screenToCanvas:x}=re(),l=s.useCallback(y=>{if("touches"in y){const p=y.touches[0]||y.changedTouches[0];return x({x:p.clientX,y:p.clientY})}return x({x:y.clientX,y:y.clientY})},[x]),S=s.useCallback(y=>{if(!f.current)return{x:0,y:0,width:0,height:0};const{position:p,bounds:k,handle:C}=f.current,z=y.x-p.x,I=y.y-p.y;let P=k.x,L=k.y,_=k.width,D=k.height;switch(C){case"nw":P=k.x+z,L=k.y+I,_=k.width-z,D=k.height-I;break;case"n":L=k.y+I,D=k.height-I;break;case"ne":L=k.y+I,_=k.width+z,D=k.height-I;break;case"e":_=k.width+z;break;case"se":_=k.width+z,D=k.height+I;break;case"s":D=k.height+I;break;case"sw":P=k.x+z,_=k.width-z,D=k.height+I;break;case"w":P=k.x+z,_=k.width-z;break}if(_<a&&(C.includes("w")&&(P=k.x+k.width-a),_=a),D<c&&(C.includes("n")&&(L=k.y+k.height-c),D=c),_>i&&(_=i),D>u&&(D=u),g&&f.current.aspectRatio){const Z=f.current.aspectRatio;_/D>Z?_=D*Z:D=_/Z}return{x:P,y:L,width:_,height:D}},[a,c,i,u,g]),w=s.useCallback(y=>{if(!f.current)return;const p=l(y),k=S(p);v(C=>({...C,currentBounds:k})),n?.(k)},[l,S,n]),d=s.useCallback(y=>{if(!f.current)return;const p=l(y),k=S(p);r?.(k),v({isResizing:!1,handle:null,startBounds:null,currentBounds:null}),f.current=null,document.removeEventListener("mousemove",w),document.removeEventListener("mouseup",d),document.removeEventListener("touchmove",w),document.removeEventListener("touchend",d)},[l,S,w,r]),b=s.useCallback((y,p,k)=>{if(o)return;k.preventDefault(),k.stopPropagation();const C="touches"in k?k.touches[0].clientX:k.clientX,z="touches"in k?k.touches[0].clientY:k.clientY,I=x({x:C,y:z});f.current={position:I,bounds:p,handle:y,aspectRatio:h??p.width/p.height},v({isResizing:!0,handle:y,startBounds:p,currentBounds:p}),t?.(y),document.addEventListener("mousemove",w),document.addEventListener("mouseup",d),document.addEventListener("touchmove",w,{passive:!1}),document.addEventListener("touchend",d)},[o,x,h,t,w,d]);return{resizeState:E,startResize:b,isResizing:E.isResizing}},ke=(e={})=>{const{onRotateStart:t,onRotate:n,onRotateEnd:r,disabled:o=!1,snapAngle:a}=e,[c,i]=s.useState({isRotating:!1,startAngle:null,currentAngle:null,deltaAngle:0}),u=s.useRef(null),{screenToCanvas:g}=re(),h=s.useCallback(S=>{if("touches"in S){const w=S.touches[0]||S.changedTouches[0];return g({x:w.clientX,y:w.clientY})}return g({x:S.clientX,y:S.clientY})},[g]),E=s.useCallback((S,w)=>{const d=w.x-S.x,b=w.y-S.y;return Math.atan2(b,d)*(180/Math.PI)},[]),v=s.useCallback(S=>a?Math.round(S/a)*a:S,[a]),f=s.useCallback(S=>{if(!u.current||o)return;const w=h(S),{center:d,startMouseAngle:b,initialRotation:y}=u.current;let k=E(d,w)-b,C=y+k;C=(C%360+360)%360,S.shiftKey&&a&&(C=v(C)),i({isRotating:!0,startAngle:y,currentAngle:C,deltaAngle:C-y}),n?.(C,C-y)},[o,h,E,a,v,n]),x=s.useCallback(S=>{if(!u.current)return;const w=h(S),{center:d,startMouseAngle:b,initialRotation:y}=u.current;let k=E(d,w)-b,C=y+k;C=(C%360+360)%360,S.shiftKey&&a&&(C=v(C)),r?.(C),i({isRotating:!1,startAngle:null,currentAngle:null,deltaAngle:0}),u.current=null,document.removeEventListener("mousemove",f),document.removeEventListener("mouseup",x),document.removeEventListener("touchmove",f),document.removeEventListener("touchend",x)},[h,E,a,v,r,f]),l=s.useCallback((S,w,d)=>{if(o)return;d.stopPropagation(),d.preventDefault();const b=h(d.nativeEvent),y=E(S,b);u.current={center:S,startMouseAngle:y,initialRotation:w},i({isRotating:!0,startAngle:w,currentAngle:w,deltaAngle:0}),t?.(w),document.addEventListener("mousemove",f),document.addEventListener("mouseup",x),document.addEventListener("touchmove",f),document.addEventListener("touchend",x)},[o,h,E,t,f,x]);return{rotateState:c,startRotate:l,isRotating:c.isRotating}},we=e=>{const{id:t,disabled:n=!1,onSelect:r}=e,{isSelected:o,select:a,addToSelection:c,removeFromSelection:i,toggleSelection:u,clearSelection:g}=he(),h=o(t),E=s.useCallback(()=>{n||(a(t),r?.(!0))},[n,t,a,r]),v=s.useCallback(()=>{n||(i(t),r?.(!1))},[n,t,i,r]),f=s.useCallback(()=>{if(n)return;const l=!h;u(t),r?.(l)},[n,t,h,u,r]),x=s.useCallback(l=>{n||(l.stopPropagation(),l.ctrlKey||l.metaKey?(u(t),r?.(!h)):l.shiftKey?(c(t),r?.(!0)):(a(t),r?.(!0)))},[n,t,h,u,c,a,r]);return{isSelected:h,handlers:{onClick:x},select:E,deselect:v,toggle:f}},Ht=(e,t)=>{const n=e.key.toLowerCase()===t.key.toLowerCase();t.ctrl?e.ctrlKey:!e.ctrlKey||t.meta,t.meta?e.metaKey:!e.metaKey||t.ctrl;const r=t.shift?e.shiftKey:!e.shiftKey,o=t.alt?e.altKey:!e.altKey,a=t.ctrl||t.meta?!!(t.ctrl&&(e.ctrlKey||e.metaKey))||!!(t.meta&&e.metaKey):!e.ctrlKey&&!e.metaKey;return n&&a&&r&&o},ut=(e={})=>{const{shortcuts:t=[],enabled:n=!0,targetRef:r}=e,o=s.useRef(t);o.current=t;const a=s.useCallback(c=>{if(n){for(const i of o.current)if(Ht(c,i)){i.preventDefault!==!1&&c.preventDefault(),i.action();return}}},[n]);s.useEffect(()=>{const c=r?.current??document;return c.addEventListener("keydown",a),()=>{c.removeEventListener("keydown",a)}},[a,r])},ht=e=>{const t=[];e.undo&&t.push({key:"z",ctrl:!0,action:e.undo}),e.redo&&(t.push({key:"z",ctrl:!0,shift:!0,action:e.redo}),t.push({key:"y",ctrl:!0,action:e.redo})),e.delete&&(t.push({key:"Delete",action:e.delete}),t.push({key:"Backspace",action:e.delete})),e.selectAll&&t.push({key:"a",ctrl:!0,action:e.selectAll}),e.copy&&t.push({key:"c",ctrl:!0,action:e.copy}),e.paste&&t.push({key:"v",ctrl:!0,action:e.paste}),e.cut&&t.push({key:"x",ctrl:!0,action:e.cut}),e.escape&&t.push({key:"Escape",action:e.escape}),e.zoomIn&&(t.push({key:"+",ctrl:!0,action:e.zoomIn}),t.push({key:"=",ctrl:!0,action:e.zoomIn})),e.zoomOut&&t.push({key:"-",ctrl:!0,action:e.zoomOut}),e.resetZoom&&t.push({key:"0",ctrl:!0,action:e.resetZoom}),ut({shortcuts:t})},mt=()=>{const e=ie(),t=he(),n=rt(),r=s.useRef(null),o=s.useCallback(()=>{n.pushState(e.elements,e.connections)},[n,e.elements,e.connections]),a=s.useCallback(d=>(o(),e.addElement(d)),[e,o]),c=s.useCallback((d,b)=>{o(),e.updateElement(d,b)},[e,o]),i=s.useCallback(d=>{o(),e.removeElement(d)},[e,o]),u=s.useCallback(()=>{t.selectedIds.length!==0&&(o(),e.removeElements(t.selectedIds),t.clearSelection())},[e,t,o]),g=s.useCallback((d,b)=>{t.selectedIds.length!==0&&(o(),e.moveElements(t.selectedIds,d,b))},[e,t,o]),h=s.useCallback(()=>{if(t.selectedIds.length===0)return[];o();const b=e.elements.filter(p=>t.selectedIds.includes(p.id)).map(p=>({...p,id:void 0,x:p.x+20,y:p.y+20})),y=e.addElements(b);return t.selectMultiple(y),y},[e,t,o]),E=s.useCallback(d=>(o(),e.addConnection(d)),[e,o]),v=s.useCallback(d=>{o(),e.removeConnection(d)},[e,o]),f=s.useCallback(()=>{if(t.selectedIds.length===0)return;const d=e.elements.filter(p=>t.selectedIds.includes(p.id)),b=new Set(t.selectedIds),y=e.connections.filter(p=>b.has(p.fromId)&&b.has(p.toId));r.current={elements:d,connections:y}},[e.elements,e.connections,t.selectedIds]),x=s.useCallback(()=>{f(),u()},[f,u]),l=s.useCallback(()=>{if(!r.current)return;o();const d=new Map,b=r.current.elements.map(p=>({...p,id:void 0,x:p.x+20,y:p.y+20})),y=e.addElements(b);r.current.elements.forEach((p,k)=>{d.set(p.id,y[k])}),r.current.connections.forEach(p=>{const k=d.get(p.fromId),C=d.get(p.toId);k&&C&&e.addConnection({...p,id:void 0,fromId:k,toId:C})}),t.selectMultiple(y)},[e,t,o]),S=s.useCallback(()=>{n.canUndo&&(n.undo(),e.loadState(n.present.elements,n.present.connections))},[n,e]),w=s.useCallback(()=>{n.canRedo&&(n.redo(),e.loadState(n.present.elements,n.present.connections))},[n,e]);return{addElement:a,updateElement:c,removeElement:i,removeSelected:u,moveSelected:g,duplicateSelected:h,addConnection:E,removeConnection:v,copy:f,cut:x,paste:l,hasCopied:r.current!==null,undo:S,redo:w,canUndo:n.canUndo,canRedo:n.canRedo}},me=8,Se=s.forwardRef(({element:e,children:t,className:n,style:r,disabled:o=!1,showHandles:a=!0,enableRotation:c=!0,onSelect:i,onDragStart:u,onDrag:g,onDragEnd:h,onResizeStart:E,onResize:v,onResizeEnd:f,onRotateStart:x,onRotate:l,onRotateEnd:S},w)=>{const{updateElement:d}=ie(),{theme:b}=X(),y=e.locked||o,{isSelected:p,handlers:k}=we({id:e.id,disabled:y,onSelect:i}),{isDragging:C,dragState:z,handlers:I}=ve({disabled:y||!p,onDragStart:()=>{u?.()},onDrag:(T,$)=>{const M=e.x+$.x,N=e.y+$.y;g?.(M,N)},onDragEnd:(T,$)=>{const M=e.x+$.x,N=e.y+$.y;d(e.id,{x:M,y:N}),h?.(M,N)}}),{isResizing:P,resizeState:L,startResize:_}=dt({disabled:y||!p,minWidth:e.minWidth??20,minHeight:e.minHeight??20,maxWidth:e.maxWidth,maxHeight:e.maxHeight,onResizeStart:()=>{E?.()},onResize:T=>{v?.(T.width,T.height,T.x,T.y)},onResizeEnd:T=>{d(e.id,{x:T.x,y:T.y,width:T.width,height:T.height}),f?.(T.width,T.height,T.x,T.y)}}),{isRotating:D,rotateState:Z,startRotate:F}=ke({disabled:y||!p||!c,snapAngle:15,onRotateStart:()=>{x?.()},onRotate:T=>{l?.(T)},onRotateEnd:T=>{d(e.id,{rotation:T}),S?.(T)}}),ne=s.useMemo(()=>D&&Z.currentAngle!==null?Z.currentAngle:e.rotation??0,[D,Z.currentAngle,e.rotation]),m=s.useMemo(()=>P&&L.currentBounds?L.currentBounds:C?{x:e.x+z.delta.x,y:e.y+z.delta.y,width:e.width,height:e.height}:{x:e.x,y:e.y,width:e.width,height:e.height},[P,L.currentBounds,C,z.delta,e.x,e.y,e.width,e.height]),R=s.useMemo(()=>!P||!L.currentBounds?{x:1,y:1}:{x:L.currentBounds.width/e.width,y:L.currentBounds.height/e.height},[P,L.currentBounds,e.width,e.height]),A=s.useMemo(()=>!p||!a||y?[]:Fe({x:0,y:0,width:m.width,height:m.height},me),[p,a,y,m.width,m.height]),W=s.useCallback((T,$)=>{_(T,{x:e.x,y:e.y,width:e.width,height:e.height},$)},[_,e]),ee=s.useCallback(T=>{const $=m.x+m.width/2,M=m.y+m.height/2;F({x:$,y:M},e.rotation??0,T)},[F,m,e.rotation]),de=s.useCallback(T=>{k.onClick(T),p&&I.onMouseDown(T)},[k,I,p]),Y={cursor:C?"grabbing":p?"grab":"pointer",opacity:e.visible===!1?.5:1,...r};return s.createElement("g",{ref:w,className:le("canvas-element",n,{"canvas-element--selected":p,"canvas-element--dragging":C,"canvas-element--resizing":P,"canvas-element--rotating":D,"canvas-element--locked":e.locked}),transform:`translate(${m.x}, ${m.y})${ne?` rotate(${ne}, ${m.width/2}, ${m.height/2})`:""}`,style:Y,onMouseDown:de,onTouchStart:I.onTouchStart,"data-element-id":e.id,"data-element-type":e.type},P?s.createElement("g",{transform:`scale(${R.x}, ${R.y})`},t):t,p&&s.createElement("rect",{className:"canvas-element__selection",x:-2,y:-2,width:m.width+4,height:m.height+4,fill:"none",stroke:b.colors.selection.stroke,strokeWidth:1,strokeDasharray:"4 2",pointerEvents:"none"}),A.map(T=>s.createElement("rect",{key:T.position,className:`canvas-element__handle canvas-element__handle--${T.position}`,x:T.x,y:T.y,width:me,height:me,fill:b.colors.handle.fill,stroke:b.colors.handle.stroke,strokeWidth:1,cursor:Xt(T.position),onMouseDown:$=>W(T.position,$)})),p&&a&&c&&!y&&s.createElement("g",{key:"rotation-handle",className:"canvas-element__rotation-handle"},s.createElement("line",{x1:m.width/2,y1:0,x2:m.width/2,y2:-25,stroke:b.colors.selection.stroke,strokeWidth:1,pointerEvents:"none"}),s.createElement("circle",{cx:m.width/2,cy:-25,r:me/2+2,fill:b.colors.handle.fill,stroke:b.colors.handle.stroke,strokeWidth:1,cursor:"grab",onMouseDown:ee})))});Se.displayName="ElementBase";function Xt(e){return{nw:"nwse-resize",n:"ns-resize",ne:"nesw-resize",e:"ew-resize",se:"nwse-resize",s:"ns-resize",sw:"nesw-resize",w:"ew-resize"}[e]}function te(e){const t=s.forwardRef((n,r)=>{const o=n,a=o.element,c=o.disabled,i=o.showHandles,u=o.enableRotation,g=o.onSelect,h=o.onDragStart,E=o.onDrag,v=o.onDragEnd,f=o.onResizeStart,x=o.onResize,l=o.onResizeEnd,S=o.onRotateStart,w=o.onRotate,d=o.onRotateEnd,b=o.className,y=o.style,{element:p,disabled:k,showHandles:C,enableRotation:z,onSelect:I,onDragStart:P,onDrag:L,onDragEnd:_,onResizeStart:D,onResize:Z,onResizeEnd:F,onRotateStart:ne,onRotate:m,onRotateEnd:R,className:A,style:W,...ee}=o,[de,Y]=s.useState({isSelected:!1,isDragging:!1,isResizing:!1,isRotating:!1}),T=s.useCallback(O=>{Y(V=>({...V,isSelected:O})),g?.(O)},[g]),$=s.useCallback(()=>{Y(O=>({...O,isDragging:!0})),h?.()},[h]),M=s.useCallback((O,V)=>{Y(j=>({...j,isDragging:!1})),v?.(O,V)},[v]),N=s.useCallback(()=>{Y(O=>({...O,isResizing:!0})),f?.()},[f]),B=s.useCallback((O,V,j,q)=>{Y(Q=>({...Q,isResizing:!1})),l?.(O,V,j,q)},[l]),U=s.useCallback(()=>{Y(O=>({...O,isRotating:!0})),S?.()},[S]),J=s.useCallback(O=>{Y(V=>({...V,isRotating:!1})),d?.(O)},[d]),H={element:a,...de};return K.jsx(Se,{ref:r,element:a,disabled:c,showHandles:i,enableRotation:u,className:b,style:y,onSelect:T,onDragStart:$,onDrag:E,onDragEnd:M,onResizeStart:N,onResize:x,onResizeEnd:B,onRotateStart:U,onRotate:w,onRotateEnd:J,children:K.jsx(e,{...H,...ee})})});return t.displayName=`withElementBehavior(${e.displayName||e.name||"Component"})`,t}const Ft=({element:e})=>{const{theme:t}=X(),{width:n,height:r,style:o}=e;return s.createElement("rect",{width:n,height:r,fill:o?.fill??t.colors.element.fill,stroke:o?.stroke??t.colors.element.stroke,strokeWidth:o?.strokeWidth??t.strokeWidth.normal,rx:o?.cornerRadius??0,ry:o?.cornerRadius??0,opacity:o?.opacity??1})},ye=te(Ft);ye.displayName="Rectangle";const Yt=({element:e})=>{const{theme:t}=X(),{width:n,height:r,style:o}=e,a=n/2,c=r/2,i=n/2,u=r/2;return s.createElement("ellipse",{cx:a,cy:c,rx:i,ry:u,fill:o?.fill??t.colors.element.fill,stroke:o?.stroke??t.colors.element.stroke,strokeWidth:o?.strokeWidth??t.strokeWidth.normal,opacity:o?.opacity??1})},ce=te(Yt);ce.displayName="Ellipse";const yt=ce;yt.displayName="Circle";const pt=ce;pt.displayName="Oval";const jt=({element:e})=>{const{theme:t}=X(),{width:n,height:r,style:o}=e,a=[`${n/2},0`,`${n},${r/2}`,`${n/2},${r}`,`0,${r/2}`].join(" ");return s.createElement("polygon",{points:a,fill:o?.fill??t.colors.element.fill,stroke:o?.stroke??t.colors.element.stroke,strokeWidth:o?.strokeWidth??t.strokeWidth.normal,opacity:o?.opacity??1})},be=te(jt);be.displayName="Diamond";const Kt=({element:e})=>{const{theme:t}=X(),{width:n,height:r,style:o,text:a="",fontSize:c,fontFamily:i,fontWeight:u,textAlign:g}=e,h=()=>{switch(g){case"right":return"end";case"center":return"middle";default:return"start"}},E=()=>{switch(g){case"right":return n;case"center":return n/2;default:return 0}};return s.createElement("g",null,s.createElement("rect",{width:n,height:r,fill:"transparent"}),s.createElement("text",{x:E(),y:r/2,dominantBaseline:"central",textAnchor:h(),fill:o?.fill??t.colors.text.primary,fontSize:c??t.fontSize.md,fontFamily:i??"sans-serif",fontWeight:u??"normal",opacity:o?.opacity??1},a))},Ce=te(Kt);Ce.displayName="TextElement";const Ue=8,Ve=25,gt=s.forwardRef(({element:e,children:t,renderLine:n,className:r,style:o,disabled:a=!1,showHandles:c=!0,enableRotation:i=!0,onSelect:u,onDragStart:g,onDrag:h,onDragEnd:E,onPointsChange:v,onRotateStart:f,onRotate:x,onRotateEnd:l},S)=>{const{updateElement:w}=ie(),{theme:d}=X(),{screenToCanvas:b}=re(),y=e.locked||a,[p,k]=s.useState({isDragging:!1,endpointIndex:null,startPosition:null,currentPoints:null}),C=s.useRef(null),z=s.useMemo(()=>e.points??[{x:0,y:e.height/2},{x:e.width,y:e.height/2}],[e.points,e.width,e.height]),{isSelected:I,handlers:P}=we({id:e.id,disabled:y,onSelect:u}),{isDragging:L,dragState:_,handlers:D}=ve({disabled:y||!I||p.isDragging,onDragStart:()=>{g?.()},onDrag:(M,N)=>{const B=e.x+N.x,U=e.y+N.y;h?.(B,U)},onDragEnd:(M,N)=>{const B=e.x+N.x,U=e.y+N.y;w(e.id,{x:B,y:U}),E?.(B,U)}}),{isRotating:Z,rotateState:F,startRotate:ne}=ke({disabled:y||!I||!i,snapAngle:15,onRotateStart:()=>{f?.()},onRotate:M=>{x?.(M)},onRotateEnd:M=>{w(e.id,{rotation:M}),l?.(M)}}),m=s.useMemo(()=>Z&&F.currentAngle!==null?F.currentAngle:e.rotation??0,[Z,F.currentAngle,e.rotation]),R=s.useMemo(()=>L?{x:e.x+_.delta.x,y:e.y+_.delta.y,width:e.width,height:e.height}:{x:e.x,y:e.y,width:e.width,height:e.height},[L,_.delta,e.x,e.y,e.width,e.height]),A=s.useMemo(()=>p.isDragging&&p.currentPoints?p.currentPoints:z,[p.isDragging,p.currentPoints,z]),W=s.useCallback((M,N)=>{if(y||!I)return;N.stopPropagation(),N.preventDefault();const B=b({x:N.clientX,y:N.clientY});C.current={endpointIndex:M,startMousePos:B,originalPoints:[...z]},k({isDragging:!0,endpointIndex:M,startPosition:B,currentPoints:[...z]});const U=H=>{if(!C.current)return;const O=b({x:H.clientX,y:H.clientY}),{endpointIndex:V,startMousePos:j,originalPoints:q}=C.current,Q=O.x-j.x,ge=O.y-j.y,fe=q.map((se,xe)=>xe===V?{x:se.x+Q,y:se.y+ge}:{...se});k(se=>({...se,currentPoints:fe}))},J=()=>{C.current&&(C.current,k(H=>{if(H.currentPoints){const O=H.currentPoints,V=O.map(ae=>ae.x),j=O.map(ae=>ae.y),q=Math.min(...V),Q=Math.min(...j),ge=Math.max(...V),fe=Math.max(...j),se=O.map(ae=>({x:ae.x-q,y:ae.y-Q})),xe=Math.max(ge-q,1),vt=Math.max(fe-Q,1);w(e.id,{x:e.x+q,y:e.y+Q,width:xe,height:vt,points:se}),v?.(se)}return{isDragging:!1,endpointIndex:null,startPosition:null,currentPoints:null}}),C.current=null,document.removeEventListener("mousemove",U),document.removeEventListener("mouseup",J))};document.addEventListener("mousemove",U),document.addEventListener("mouseup",J)},[y,I,z,b,w,e.id,e.x,e.y,v]),ee=s.useCallback(M=>{const N=A[0],B=A[A.length-1],U=(N.x+B.x)/2,J=(N.y+B.y)/2,H=R.x+U,O=R.y+J;ne({x:H,y:O},e.rotation??0,M)},[ne,R,A,e.rotation]),de=s.useCallback(M=>{P.onClick(M),I&&!p.isDragging&&D.onMouseDown(M)},[P,D,I,p.isDragging]),Y={cursor:L?"grabbing":I?"grab":"pointer",opacity:e.visible===!1?.5:1,...o},T=s.useMemo(()=>A.map(M=>({x:M.x,y:M.y})),[A]),$=s.useMemo(()=>{if(A.length<2)return{cx:0,cy:0,x1:0,y1:0,x2:0,y2:0};const M=A[0],N=A[A.length-1],B=(M.x+N.x)/2,U=(M.y+N.y)/2,J=N.x-M.x,H=N.y-M.y,O=Math.sqrt(J*J+H*H)||1,V=-H/O,j=J/O,q=B+V*Ve,Q=U+j*Ve;return{cx:q,cy:Q,x1:B,y1:U,x2:q,y2:Q}},[A]);return s.createElement("g",{ref:S,className:le("canvas-element canvas-line",r,{"canvas-element--selected":I,"canvas-element--dragging":L,"canvas-element--endpoint-dragging":p.isDragging,"canvas-element--rotating":Z,"canvas-element--locked":e.locked}),transform:`translate(${R.x}, ${R.y})${m?` rotate(${m}, ${R.width/2}, ${R.height/2})`:""}`,style:Y,onMouseDown:de,onTouchStart:D.onTouchStart,"data-element-id":e.id,"data-element-type":e.type},n(A,p.isDragging),I&&c&&!y&&T.map((M,N)=>s.createElement("circle",{key:`endpoint-handle-${N}`,className:"canvas-line__endpoint-handle",cx:M.x,cy:M.y,r:Ue/2+2,fill:d.colors.handle.fill,stroke:d.colors.handle.stroke,strokeWidth:1.5,cursor:"move",onMouseDown:B=>W(N,B)})),I&&c&&i&&!y&&s.createElement("g",{key:"rotation-handle",className:"canvas-line__rotation-handle"},s.createElement("line",{x1:$.x1,y1:$.y1,x2:$.x2,y2:$.y2,stroke:d.colors.selection.stroke,strokeWidth:1,pointerEvents:"none"}),s.createElement("circle",{cx:$.cx,cy:$.cy,r:Ue/2+2,fill:d.colors.handle.fill,stroke:d.colors.handle.stroke,strokeWidth:1,cursor:"grab",onMouseDown:ee})))});gt.displayName="LineBase";const Re=s.forwardRef(({element:e,disabled:t,showHandles:n,enableRotation:r,onSelect:o,onDragStart:a,onDrag:c,onDragEnd:i,onPointsChange:u,onRotateStart:g,onRotate:h,onRotateEnd:E,className:v,style:f},x)=>{const{theme:l}=X(),{style:S,lineType:w="solid"}=e,d=s.useCallback(()=>{switch(w){case"dashed":return"8 4";case"dotted":return"2 2";default:return}},[w]),b=S?.stroke??l.colors.element.stroke,y=S?.strokeWidth??l.strokeWidth.normal,p=s.useCallback((k,C)=>{const z=k.map((I,P)=>P===0?`M ${I.x} ${I.y}`:`L ${I.x} ${I.y}`).join(" ");return s.createElement("g",null,s.createElement("path",{d:z,fill:"none",stroke:"transparent",strokeWidth:20,strokeLinecap:"round"}),s.createElement("path",{d:z,fill:"none",stroke:b,strokeWidth:y,strokeDasharray:d(),strokeLinecap:"round",strokeLinejoin:"round",opacity:S?.opacity??1}))},[b,y,d,S?.opacity]);return s.createElement(gt,{ref:x,element:e,disabled:t,showHandles:n,enableRotation:r,className:v,style:f,onSelect:o,onDragStart:a,onDrag:c,onDragEnd:i,onPointsChange:u,onRotateStart:g,onRotate:h,onRotateEnd:E,renderLine:p})});Re.displayName="Line";const Gt=({element:e})=>{const{theme:t}=X(),{width:n,height:r,style:o,label:a}=e,c=Math.min(n,r)*.15,i=n/2,u=c*2+4,g=r*.6,h=u+(g-u)*.3,E=n*.4,v=n*.35,f=r-4,x=o?.stroke??t.colors.element.stroke,l=o?.strokeWidth??t.strokeWidth.normal;return s.createElement("g",null,s.createElement("rect",{width:n,height:r,fill:"transparent"}),s.createElement("circle",{cx:i,cy:c+2,r:c,fill:o?.fill??"none",stroke:x,strokeWidth:l}),s.createElement("line",{x1:i,y1:u,x2:i,y2:g,stroke:x,strokeWidth:l}),s.createElement("line",{x1:i-E,y1:h,x2:i+E,y2:h,stroke:x,strokeWidth:l}),s.createElement("line",{x1:i,y1:g,x2:i-v,y2:r*.85,stroke:x,strokeWidth:l}),s.createElement("line",{x1:i,y1:g,x2:i+v,y2:r*.85,stroke:x,strokeWidth:l}),a&&s.createElement("text",{x:i,y:f,textAnchor:"middle",dominantBaseline:"text-bottom",fill:o?.fill??t.colors.text.primary,fontSize:t.fontSize.sm,fontFamily:"sans-serif"},a))},Te=te(Gt);Te.displayName="Actor";const Jt=({element:e})=>{const{theme:t}=X(),{width:n,height:r,style:o,label:a}=e,c=n/2,i=40,u=o?.stroke??t.colors.element.stroke,g=o?.strokeWidth??t.strokeWidth.normal;return s.createElement("g",null,s.createElement("rect",{x:0,y:0,width:n,height:i,fill:o?.fill??t.colors.element.fill,stroke:u,strokeWidth:g}),a&&s.createElement("text",{x:c,y:i/2,textAnchor:"middle",dominantBaseline:"central",fill:t.colors.text.primary,fontSize:t.fontSize.sm,fontFamily:"sans-serif"},a),s.createElement("line",{x1:c,y1:i,x2:c,y2:r,stroke:u,strokeWidth:g,strokeDasharray:"8 4"}))},Ie=te(Jt);Ie.displayName="Lifeline";const qt=({element:e})=>{const{theme:t}=X(),{width:n,height:r,style:o,label:a,messageType:c="sync"}=e,i=o?.stroke??t.colors.connection.line,u=o?.strokeWidth??t.strokeWidth.normal,g=10,h=r/2,E=()=>{switch(c){case"return":return"8 4";case"create":return"4 2";default:return}},v=()=>c==="async"?s.createElement("polyline",{points:`${n-g},${h-g/2} ${n},${h} ${n-g},${h+g/2}`,fill:"none",stroke:i,strokeWidth:u}):s.createElement("polygon",{points:`${n},${h} ${n-g},${h-g/2} ${n-g},${h+g/2}`,fill:i,stroke:i,strokeWidth:1});return s.createElement("g",null,s.createElement("rect",{width:n,height:r,fill:"transparent"}),s.createElement("line",{x1:0,y1:h,x2:n-(c==="async"?0:g/2),y2:h,stroke:i,strokeWidth:u,strokeDasharray:E()}),v(),a&&s.createElement("text",{x:n/2,y:h-8,textAnchor:"middle",dominantBaseline:"text-bottom",fill:t.colors.text.primary,fontSize:t.fontSize.sm,fontFamily:"sans-serif"},a))},Me=te(qt);Me.displayName="Message";const Qt=({element:e})=>{const{theme:t}=X(),{width:n,height:r,style:o}=e;return s.createElement("rect",{width:n||12,height:r,fill:o?.fill??t.colors.element.fill,stroke:o?.stroke??t.colors.element.stroke,strokeWidth:o?.strokeWidth??t.strokeWidth.normal})},ze=te(Qt);ze.displayName="ActivationBar";const He={rectangle:ye,ellipse:ce,circle:ce,diamond:be,text:Ce,line:Re,actor:Te,lifeline:Ie,message:Me,activationBar:ze,custom:ye},Ne=s.forwardRef(({width:e,height:t,className:n,style:r,showGrid:o,gridSize:a,onCanvasClick:c,onCanvasDoubleClick:i,children:u},g)=>{const{elements:h,config:E}=ie(),{clearSelection:v}=he(),{viewport:f}=re(),{theme:x}=X(),l=e??E.width,S=t??E.height,w=o??E.grid?.visible,d=a??E.grid?.size??20,b=s.useMemo(()=>pe(h),[h]),y=s.useCallback(C=>{C.target===C.currentTarget&&(v(),c?.(C))},[v,c]),p=()=>{if(!w)return null;const C="canvas-grid-pattern";return s.createElement(s.Fragment,null,s.createElement("defs",null,s.createElement("pattern",{id:C,width:d,height:d,patternUnits:"userSpaceOnUse"},s.createElement("path",{d:`M ${d} 0 L 0 0 0 ${d}`,fill:"none",stroke:x.colors.grid.line,strokeWidth:.5}))),s.createElement("rect",{width:"100%",height:"100%",fill:`url(#${C})`}))},k=C=>{const z=He[C.type]??He.custom;return s.createElement(z,{key:C.id,element:C})};return s.createElement("svg",{ref:g,className:le("canvas-drawing",n),width:l,height:S,viewBox:`0 0 ${l} ${S}`,style:{backgroundColor:x.colors.background,cursor:"default",userSelect:"none",...r},onClick:y,onDoubleClick:i},s.createElement("g",{transform:`translate(${f.pan.x}, ${f.pan.y}) scale(${f.zoom})`},p(),b.map(k),u))});Ne.displayName="DrawingCanvas";const ft=s.forwardRef(({width:e,height:t,readonly:n=!1,showGrid:r,gridSize:o,enableKeyboardShortcuts:a=!0,className:c,style:i,children:u},g)=>{const h=s.useRef(null),E=ie(),v=he(),f=re(),x=mt();return ht(a?{undo:x.undo,redo:x.redo,delete:x.removeSelected,selectAll:()=>v.selectAll(E.elements.map(l=>l.id)),copy:x.copy,paste:x.paste,cut:x.cut,escape:v.clearSelection,zoomIn:f.zoomIn,zoomOut:f.zoomOut,resetZoom:f.resetViewport}:{}),s.useImperativeHandle(g,()=>({addElement:x.addElement,updateElement:x.updateElement,removeElement:x.removeElement,getElement:E.getElementById,getElementsByType:E.getElementsByType,select:v.select,selectMultiple:v.selectMultiple,clearSelection:v.clearSelection,getSelectedIds:()=>v.selectedIds,zoomIn:f.zoomIn,zoomOut:f.zoomOut,setZoom:f.setZoom,resetViewport:f.resetViewport,undo:x.undo,redo:x.redo,canUndo:x.canUndo,canRedo:x.canRedo,toJSON:()=>({elements:E.elements,connections:E.connections}),toSVG:()=>h.current?.outerHTML??""}),[E,v,f,x]),K.jsxs("div",{className:le("canvas-container",c,{"canvas-container--readonly":n}),style:{position:"relative",overflow:"hidden",...i},tabIndex:0,children:[K.jsx(Ne,{ref:h,width:e,height:t,showGrid:r,gridSize:o}),u]})});ft.displayName="CanvasInner";const xt=s.forwardRef(({elements:e,connections:t,selectedIds:n,defaultElements:r=[],defaultConnections:o=[],config:a,theme:c="light",initialViewport:i,maxHistorySize:u,onChange:g,onSelectionChange:h,...E},v)=>K.jsx(it,{initialElements:r,initialConnections:o,elements:e,connections:t,selectedIds:n,config:a,theme:c,initialViewport:i,maxHistorySize:u,onElementsChange:g,onSelectionChange:h,children:K.jsx(ft,{...E,ref:v})}));xt.displayName="Canvas";const Xe={rectangle:{width:120,height:80},ellipse:{width:120,height:80},circle:{width:80,height:80},diamond:{width:100,height:100},text:{width:100,height:30},line:{width:100,height:2},actor:{width:60,height:100},lifeline:{width:100,height:300},message:{width:150,height:30},activationBar:{width:12,height:60},custom:{width:100,height:100}},G=(e,t={})=>{const n=Xe[e]??Xe.custom;return{id:t.id??ue(),type:e,x:t.x??0,y:t.y??0,width:t.width??n.width,height:t.height??n.height,zIndex:t.zIndex??0,style:t.style,locked:t.locked??!1,visible:t.visible??!0,data:t.data}},De=(e={})=>G("rectangle",e),Ae=(e={})=>G("ellipse",e),Oe=(e={})=>{const t=e.width??e.height??80;return G("circle",{...e,width:t,height:t})},_e=(e={})=>G("diamond",e),Le=(e={})=>{const{text:t,fontSize:n,fontFamily:r,fontWeight:o,textAlign:a,...c}=e;return{...G("text",c),type:"text",text:t??"",fontSize:n,fontFamily:r,fontWeight:o,textAlign:a}},Pe=(e={})=>{const{points:t,lineType:n,x:r,y:o,...a}=e,c=a.width??100;let i=t??[{x:r??0,y:o??0},{x:(r??0)+c,y:o??0}];const u=i.map(y=>y.x),g=i.map(y=>y.y),h=Math.min(...u),E=Math.min(...g),v=Math.max(...u),f=Math.max(...g),x=i.map(y=>({x:y.x-h,y:y.y-E})),l=v-h,S=f-E,w=Math.max(l,10),d=Math.max(S,10),b=x.map(y=>({x:l<10?y.x+(10-l)/2:y.x,y:S<10?y.y+(10-S)/2:y.y}));return{...G("line",{...a,x:l<10?h-(10-l)/2:h,y:S<10?E-(10-S)/2:E,width:w,height:d}),type:"line",points:b,lineType:n??"solid"}},$e=(e={})=>{const{label:t,...n}=e;return{...G("actor",n),type:"actor",label:t}},Be=(e={})=>{const{label:t,...n}=e;return{...G("lifeline",n),type:"lifeline",label:t}},We=(e={})=>{const{label:t,messageType:n,fromId:r,toId:o,...a}=e;return{...G("message",a),type:"message",label:t,messageType:n??"sync",fromId:r,toId:o}},Ze=(e={})=>G("activationBar",e),Et=(e,t={})=>{switch(e){case"rectangle":return De(t);case"ellipse":return Ae(t);case"circle":return Oe(t);case"diamond":return _e(t);case"text":return Le(t);case"line":return Pe(t);case"actor":return $e(t);case"lifeline":return Be(t);case"message":return We(t);case"activationBar":return Ze(t);default:return G(e,t)}},en={create:Et,rectangle:De,ellipse:Ae,circle:Oe,diamond:_e,text:Le,line:Pe,actor:$e,lifeline:Be,message:We,activationBar:Ze};exports.ActivationBar=ze;exports.Actor=Te;exports.Canvas=xt;exports.CanvasProvider=lt;exports.Circle=yt;exports.CombinedCanvasProvider=it;exports.Diamond=be;exports.DrawingCanvas=Ne;exports.ElementBase=Se;exports.ElementFactory=en;exports.Ellipse=ce;exports.HistoryProvider=at;exports.Lifeline=Ie;exports.Line=Re;exports.Message=Me;exports.Oval=pt;exports.Rectangle=ye;exports.SelectionProvider=st;exports.TextElement=Ce;exports.ThemeProvider=qe;exports.ViewportProvider=tt;exports.boundsIntersect=St;exports.bringToFront=Ye;exports.createActivationBar=Ze;exports.createActor=$e;exports.createCircle=Oe;exports.createDiamond=_e;exports.createElement=Et;exports.createEllipse=Ae;exports.createLifeline=Be;exports.createLine=Pe;exports.createMessage=We;exports.createRectangle=De;exports.createText=Le;exports.cx=le;exports.darkTheme=Ge;exports.deepMerge=Ee;exports.deserializeFromJSON=At;exports.distance=kt;exports.downloadAsFile=Lt;exports.exportToSVG=Ot;exports.generateId=ue;exports.getResizeHandles=Fe;exports.getThemeCSSVariables=Pt;exports.isPointInBounds=wt;exports.lightTheme=oe;exports.sendToBack=je;exports.serializeToJSON=Dt;exports.snapToGrid=bt;exports.sortByZIndex=pe;exports.useCanvas=ie;exports.useCanvasActions=mt;exports.useCanvasKeyboardShortcuts=ht;exports.useDraggable=ve;exports.useHistory=rt;exports.useKeyboard=ut;exports.useResizable=dt;exports.useRotatable=ke;exports.useSelectable=we;exports.useSelection=he;exports.useTheme=X;exports.useViewport=re;exports.validateCanvasData=Ke;exports.withElementBehavior=te;
//# sourceMappingURL=index.cjs.map
